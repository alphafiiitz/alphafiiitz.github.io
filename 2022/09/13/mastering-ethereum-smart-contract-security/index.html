

<!DOCTYPE html>
<html lang="zh-CN" data-default-color-scheme=dark>



<head>
  <meta charset="UTF-8">
  <link rel="apple-touch-icon" sizes="76x76" href="/img/fitz.png">
  <link rel="icon" href="/img/fitz.png">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=5.0, shrink-to-fit=no">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  
  <meta name="theme-color" content="#2f4154">
  <meta name="author" content="alphafitz">
  <meta name="keywords" content="">
  
    <meta name="description" content="精通以太坊：智能合约安全 本文内容是对 Mastering Ethereum 一书的 Smart Contract Security 章节的翻译。  编写智能合约时，安全性是最重要的考虑因素之一。在智能合约编程领域，错误代价高昂且容易被利用。在本章中，我们将研究安全最佳实践和设计模式，以及“安全反模式(security antipatterns)”，它们是可能在我们的智能合约中引入漏洞的实践和模式">
<meta property="og:type" content="article">
<meta property="og:title" content="精通以太坊：智能合约安全">
<meta property="og:url" content="https://alphafitz.com/2022/09/13/mastering-ethereum-smart-contract-security/index.html">
<meta property="og:site_name">
<meta property="og:description" content="精通以太坊：智能合约安全 本文内容是对 Mastering Ethereum 一书的 Smart Contract Security 章节的翻译。  编写智能合约时，安全性是最重要的考虑因素之一。在智能合约编程领域，错误代价高昂且容易被利用。在本章中，我们将研究安全最佳实践和设计模式，以及“安全反模式(security antipatterns)”，它们是可能在我们的智能合约中引入漏洞的实践和模式">
<meta property="og:locale" content="zh_CN">
<meta property="article:published_time" content="2022-09-13T15:09:47.000Z">
<meta property="article:modified_time" content="2022-09-26T10:17:06.338Z">
<meta property="article:author" content="alphafitz">
<meta property="article:tag" content="区块链技术">
<meta property="article:tag" content="以太坊">
<meta property="article:tag" content="区块链安全">
<meta name="twitter:card" content="summary_large_image">
  
  
    <meta name="referrer" content="no-referrer-when-downgrade">
  
  
  <title>精通以太坊：智能合约安全 - </title>

  <link  rel="stylesheet" href="https://lib.baomitu.com/twitter-bootstrap/4.6.1/css/bootstrap.min.css" />



  <link  rel="stylesheet" href="https://lib.baomitu.com/github-markdown-css/4.0.0/github-markdown.min.css" />

  <link  rel="stylesheet" href="https://lib.baomitu.com/hint.css/2.7.0/hint.min.css" />

  <link  rel="stylesheet" href="https://lib.baomitu.com/prism/1.27.0/plugins/line-numbers/prism-line-numbers.min.css" />

  <link  rel="stylesheet" href="https://lib.baomitu.com/fancybox/3.5.7/jquery.fancybox.min.css" />



<!-- 主题依赖的图标库，不要自行修改 -->
<!-- Do not modify the link that theme dependent icons -->

<link rel="stylesheet" href="//at.alicdn.com/t/font_1749284_hj8rtnfg7um.css">



<link rel="stylesheet" href="//at.alicdn.com/t/font_1736178_lbnruvf0jn.css">


<link  rel="stylesheet" href="/css/main.css" />


  <link id="highlight-css" rel="stylesheet" href="/css/highlight.css" />
  
    <link id="highlight-css-dark" rel="stylesheet" href="/css/highlight-dark.css" />
  




  <script id="fluid-configs">
    var Fluid = window.Fluid || {};
    Fluid.ctx = Object.assign({}, Fluid.ctx)
    var CONFIG = {"hostname":"alphafitz.com","root":"/","version":"1.9.2","typing":{"enable":true,"typeSpeed":70,"cursorChar":"_","loop":false,"scope":[]},"anchorjs":{"enable":true,"element":"h1,h2,h3,h4,h5,h6","placement":"left","visible":"hover","icon":""},"progressbar":{"enable":true,"height_px":3,"color":"#29d","options":{"showSpinner":false,"trickleSpeed":100}},"code_language":{"enable":true,"default":"TEXT"},"copy_btn":true,"image_caption":{"enable":true},"image_zoom":{"enable":true,"img_url_replace":["",""]},"toc":{"enable":true,"placement":"right","headingSelector":"h1,h2,h3,h4,h5,h6","collapseDepth":0},"lazyload":{"enable":true,"loading_img":"/img/loading.gif","onlypost":false,"offset_factor":2},"web_analytics":{"enable":true,"follow_dnt":false,"baidu":null,"google":null,"gtag":null,"tencent":{"sid":null,"cid":null},"woyaola":null,"cnzz":null,"leancloud":{"app_id":null,"app_key":null,"server_url":null,"path":"window.location.pathname","ignore_local":false}},"search_path":"/local-search.xml"};

    if (CONFIG.web_analytics.follow_dnt) {
      var dntVal = navigator.doNotTrack || window.doNotTrack || navigator.msDoNotTrack;
      Fluid.ctx.dnt = dntVal && (dntVal.startsWith('1') || dntVal.startsWith('yes') || dntVal.startsWith('on'));
    }
  </script>
  <script  src="/js/utils.js" ></script>
  <script  src="/js/color-schema.js" ></script>
  

  

  

  

  

  

  

  



  
<meta name="generator" content="Hexo 6.2.0"><link rel="alternate" href="/atom.xml" title="null" type="application/atom+xml">
</head>


<body>
  

  <header>
    

<div class="header-inner" style="height: 70vh;">
  <nav id="navbar" class="navbar fixed-top  navbar-expand-lg navbar-dark scrolling-navbar">
  <div class="container">
    <a class="navbar-brand" href="/">
      <strong>alphafitz</strong>
    </a>

    <button id="navbar-toggler-btn" class="navbar-toggler" type="button" data-toggle="collapse"
            data-target="#navbarSupportedContent"
            aria-controls="navbarSupportedContent" aria-expanded="false" aria-label="Toggle navigation">
      <div class="animated-icon"><span></span><span></span><span></span></div>
    </button>

    <!-- Collapsible content -->
    <div class="collapse navbar-collapse" id="navbarSupportedContent">
      <ul class="navbar-nav ml-auto text-center">
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/">
                <i class="iconfont icon-home-fill"></i>
                首页
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/archives/">
                <i class="iconfont icon-archive-fill"></i>
                归档
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/categories/">
                <i class="iconfont icon-category-fill"></i>
                分类
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/tags/">
                <i class="iconfont icon-tags-fill"></i>
                标签
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/about/">
                <i class="iconfont icon-user-fill"></i>
                关于
              </a>
            </li>
          
        
        
          <li class="nav-item" id="search-btn">
            <a class="nav-link" target="_self" href="javascript:;" data-toggle="modal" data-target="#modalSearch" aria-label="Search">
              &nbsp;<i class="iconfont icon-search"></i>&nbsp;
            </a>
          </li>
          
        
        
          <li class="nav-item" id="color-toggle-btn">
            <a class="nav-link" target="_self" href="javascript:;" aria-label="Color Toggle">&nbsp;<i
                class="iconfont icon-dark" id="color-toggle-icon"></i>&nbsp;</a>
          </li>
        
      </ul>
    </div>
  </div>
</nav>

  

<div id="banner" class="banner" parallax=true
     style="background: url('/img/default.png') no-repeat center center; background-size: cover;">
  <div class="full-bg-img">
    <div class="mask flex-center" style="background-color: rgba(0, 0, 0, 0.3)">
      <div class="banner-text text-center fade-in-up">
        <div class="h2">
          
            <span id="subtitle" data-typed-text="精通以太坊：智能合约安全"></span>
          
        </div>

        
          
  <div class="mt-3">
    
    
      <span class="post-meta">
        <i class="iconfont icon-date-fill" aria-hidden="true"></i>
        <time datetime="2022-09-13 23:09" pubdate>
          2022年9月13日 晚上
        </time>
      </span>
    
  </div>

  <div class="mt-1">
    
      <span class="post-meta mr-2">
        <i class="iconfont icon-chart"></i>
        
          48k 字
        
      </span>
    

    
      <span class="post-meta mr-2">
        <i class="iconfont icon-clock-fill"></i>
        
        
        
          402 分钟
        
      </span>
    

    
    
  </div>


        
      </div>

      
    </div>
  </div>
</div>

</div>

  </header>

  <main>
    
      

<div class="container-fluid nopadding-x">
  <div class="row nomargin-x">
    <div class="side-col d-none d-lg-block col-lg-2">
      

    </div>

    <div class="col-lg-8 nopadding-x-md">
      <div class="container nopadding-x-md" id="board-ctn">
        <div id="board">
          <article class="post-content mx-auto">
            <!-- SEO header -->
            <h1 style="display: none">精通以太坊：智能合约安全</h1>
            
            
              <div class="markdown-body">
                
                <h1 id="精通以太坊：智能合约安全"><a href="#精通以太坊：智能合约安全" class="headerlink" title="精通以太坊：智能合约安全"></a>精通以太坊：智能合约安全</h1><blockquote>
<p>本文内容是对 <a target="_blank" rel="noopener" href="https://github.com/ethereumbook/ethereumbook/blob/develop/09smart-contracts-security.asciidoc">Mastering Ethereum</a> 一书的 Smart Contract Security 章节的翻译。</p>
</blockquote>
<p>编写智能合约时，安全性是最重要的考虑因素之一。在智能合约编程领域，错误代价高昂且容易被利用。在本章中，我们将研究安全最佳实践和设计模式，以及“安全反模式(<em>security antipatterns</em>)”，它们是可能在我们的智能合约中引入漏洞的实践和模式。</p>
<p>与其他程序一样，智能合约将准确执行所写的内容，这并不总是程序员的意图。此外，所有智能合约都是公开的，任何用户都可以通过创建交易与它们进行交互。任何漏洞都可以被利用，损失几乎总是无法挽回。因此，遵循最佳实践并使用经过充分测试的设计模式至关重要。</p>
<h2 id="安全最佳实践"><a href="#安全最佳实践" class="headerlink" title="安全最佳实践"></a>安全最佳实践</h2><p>防御性编程(<em>Defensive programming</em>)是一种特别适合智能合约的编程风格。它强调以下几点，所有这些都是最佳实践：</p>
<p><em>极简主义&#x2F;简单</em></p>
<p>复杂性是安全的敌人。代码越简单，代码越少，出现错误或无法预料的影响的可能性就越低。在第一次从事智能合约编程时，开发人员通常会尝试编写大量代码。相反，您应该仔细查看您的智能合约代码，并尝试找到减少代码行数、复杂性和“功能”的方法。如果有人告诉你他们的项目已经为他们的智能合约生成了“数千行代码”，你应该质疑那个项目的安全性。更简单更安全。</p>
<p><em>代码重用</em></p>
<p>尽量不要重新发明轮子。如果已经存在可以满足您大部分需求的库或合约，请重用它。在您自己的代码中，遵循 DRY 原则：不要重复自己(<em>Don’t Repeat Yourself</em>)。如果您看到任何代码片段重复多次，请问问自己是否可以将其编写为函数或库并重用。已被广泛使用和测试的代码可能比您编写的任何新代码都更安全。谨防“此处未发明(<em>No Invented Here</em>)”综合症，在这种情况下，您很想通过从头开始构建功能或组件来“改进”它。安全风险往往大于改进价值。</p>
<p><em>代码质量</em></p>
<p>智能合约代码是无情的。每个错误都可能导致金钱损失。您不应该将智能合约编程视为通用编程。使用 Solidity 编写 DApp 与使用 JavaScript 创建 Web 小部件不同。相反，您应该应用严格的工程和软件开发方法，就像在航空工程或任何类似的无情学科(<em>unforgiving discipline</em>)中一样。一旦你“启动”你的代码，你几乎无法解决任何问题。</p>
<p><em>可读性&#x2F;可审计性</em></p>
<p>您的代码应该清晰易懂。越容易阅读，就越容易审计。智能合约是公开的，因为每个人都可以读取字节码并且任何人都可以对其进行逆向工程。因此，使用协作和开源方法在公共场合开发您的工作是有益的，以利用开发人员社区的集体智慧并从开源开发的最高公分母中受益。你应该编写有据可查且易于阅读的代码，遵循以太坊社区的风格和命名约定。</p>
<p><em>测试覆盖率</em></p>
<p>尽可能测试一切。智能合约在公共执行环境中运行，任何人都可以使用他们想要的任何输入来执行它们。您永远不应假设输入（例如函数参数）格式正确、有适当界限或具有良性目的。测试所有参数以确保它们在预期范围内并且格式正确，然后才能继续执行代码。</p>
<h2 id="安全风险和反模式"><a href="#安全风险和反模式" class="headerlink" title="安全风险和反模式"></a>安全风险和反模式</h2><p>作为智能合约程序员，您应该熟悉最常见的安全风险，以便能够检测和避免使您的合约暴露于这些风险的编程模式。在接下来的几节中，我们将研究不同的安全风险、漏洞如何出现的示例，以及可用于解决这些问题的对策或预防性解决方案。</p>
<h2 id="重入-Reentrancy"><a href="#重入-Reentrancy" class="headerlink" title="重入 (Reentrancy)"></a>重入 (Reentrancy)</h2><p><strong>以太坊智能合约的特点之一是它们能够调用和利用来自其他外部合约的代码。</strong>合约通常还处理以太币，因此经常将以太币发送到各种外部用户地址。这些操作需要合约提交外部调用。这些外部调用可能被攻击者劫持，攻击者可以强制合约执行进一步的代码（通过 fallback 函数），包括对自身的调用。这种攻击被用于臭名昭著的 <a target="_blank" rel="noopener" href="http://bit.ly/2DamSZT">DAO 攻击</a>。</p>
<p>有关重入攻击的进一步阅读，请参阅 Gus Guimareas 关于该主题的<a target="_blank" rel="noopener" href="https://gus-tavo-guim.medium.com/reentrancy-attack-on-smart-contracts-how-to-identify-the-exploitable-and-an-example-of-an-attack-4470a2d8dfe4">博客文章</a>和<a target="_blank" rel="noopener" href="https://consensys.github.io/smart-contract-best-practices/">以太坊智能合约最佳实践</a>。</p>
<h3 id="漏洞"><a href="#漏洞" class="headerlink" title="漏洞"></a>漏洞</h3><p>当合约将以太币发送到未知地址时，可能会发生这种类型的攻击。攻击者可以在 fallback 函数中小心地在包含恶意代码的外部地址构造合约。因此，当合约将以太币发送到该地址时，它将调用恶意代码。通常，恶意代码在易受攻击的合约上执行一个函数，执行开发人员不期望的操作。 “重入(<em>reentrancy</em>)”一词来自于外部恶意合约调用易受攻击合约上的函数并且代码执行的路径“重新进入”它。</p>
<p>为了理清这一点，请考虑 <a target="_blank" rel="noopener" href="https://github.com/ethereumbook/ethereumbook/blob/develop/09smart-contracts-security.asciidoc#etherstore_vulnerable">EtherStore.sol</a> 中的简单易受攻击合约，它充当以太坊保险库，允许储户每周仅提取 1 个以太币。</p>
<p>示例1. EtherStore.sol</p>
<figure><div class="code-wrapper"><pre class="line-numbers language-solidity" data-language="solidity"><code class="language-solidity"><span class="token keyword">contract</span> <span class="token class-name">EtherStore</span> <span class="token punctuation">&#123;</span>

    <span class="token builtin">uint256</span> <span class="token keyword">public</span> withdrawalLimit <span class="token operator">=</span> <span class="token number">1</span> ether<span class="token punctuation">;</span>
    <span class="token keyword">mapping</span><span class="token punctuation">(</span><span class="token builtin">address</span> <span class="token operator">=></span> <span class="token builtin">uint256</span><span class="token punctuation">)</span> <span class="token keyword">public</span> lastWithdrawTime<span class="token punctuation">;</span>
    <span class="token keyword">mapping</span><span class="token punctuation">(</span><span class="token builtin">address</span> <span class="token operator">=></span> <span class="token builtin">uint256</span><span class="token punctuation">)</span> <span class="token keyword">public</span> balances<span class="token punctuation">;</span>

    <span class="token keyword">function</span> <span class="token function">depositFunds</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">external</span> <span class="token keyword">payable</span> <span class="token punctuation">&#123;</span>
        balances<span class="token punctuation">[</span>msg<span class="token punctuation">.</span>sender<span class="token punctuation">]</span> <span class="token operator">+=</span> msg<span class="token punctuation">.</span>value<span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>

    <span class="token keyword">function</span> withdrawFunds <span class="token punctuation">(</span><span class="token builtin">uint256</span> _weiToWithdraw<span class="token punctuation">)</span> <span class="token keyword">public</span> <span class="token punctuation">&#123;</span>
        <span class="token keyword">require</span><span class="token punctuation">(</span>balances<span class="token punctuation">[</span>msg<span class="token punctuation">.</span>sender<span class="token punctuation">]</span> <span class="token operator">>=</span> _weiToWithdraw<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// limit the withdrawal</span>
        <span class="token keyword">require</span><span class="token punctuation">(</span>_weiToWithdraw <span class="token operator">&lt;=</span> withdrawalLimit<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// limit the time allowed to withdraw</span>
        <span class="token keyword">require</span><span class="token punctuation">(</span>now <span class="token operator">>=</span> lastWithdrawTime<span class="token punctuation">[</span>msg<span class="token punctuation">.</span>sender<span class="token punctuation">]</span> <span class="token operator">+</span> <span class="token number">1</span> weeks<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">require</span><span class="token punctuation">(</span>msg<span class="token punctuation">.</span>sender<span class="token punctuation">.</span>call<span class="token punctuation">.</span><span class="token function">value</span><span class="token punctuation">(</span>_weiToWithdraw<span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        balances<span class="token punctuation">[</span>msg<span class="token punctuation">.</span>sender<span class="token punctuation">]</span> <span class="token operator">-=</span> _weiToWithdraw<span class="token punctuation">;</span>
        lastWithdrawTime<span class="token punctuation">[</span>msg<span class="token punctuation">.</span>sender<span class="token punctuation">]</span> <span class="token operator">=</span> now<span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
 <span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></div></figure>

<p>该合约有两个公共函数，<code>depositFunds</code> 和 <code>withdrawFunds</code>。 <code>depositFunds</code> 函数只是增加发送者的余额。 <code>withdrawFunds</code> 函数允许发送者指定要提取的 wei 数量。此功能仅在请求的提款金额小于 1 ether 且上周未发生提款时才会成功。</p>
<p>该漏洞位于第 17 行，合约向用户发送他们请求的以太币数量。考虑一个在 Attack.sol 中创建合约的攻击者。</p>
<p>示例2. Attack.sol</p>
<figure><div class="code-wrapper"><pre class="line-numbers language-solidity" data-language="solidity"><code class="language-solidity"><span class="token keyword">import</span> <span class="token string">"EtherStore.sol"</span><span class="token punctuation">;</span>

<span class="token keyword">contract</span> <span class="token class-name">Attack</span> <span class="token punctuation">&#123;</span>
  EtherStore <span class="token keyword">public</span> etherStore<span class="token punctuation">;</span>

  <span class="token comment">// intialize the etherStore variable with the contract address</span>
  <span class="token keyword">constructor</span><span class="token punctuation">(</span><span class="token builtin">address</span> _etherStoreAddress<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
      etherStore <span class="token operator">=</span> <span class="token function">EtherStore</span><span class="token punctuation">(</span>_etherStoreAddress<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">&#125;</span>

  <span class="token keyword">function</span> <span class="token function">attackEtherStore</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">external</span> <span class="token keyword">payable</span> <span class="token punctuation">&#123;</span>
      <span class="token comment">// attack to the nearest ether</span>
      <span class="token keyword">require</span><span class="token punctuation">(</span>msg<span class="token punctuation">.</span>value <span class="token operator">>=</span> <span class="token number">1</span> ether<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token comment">// send eth to the depositFunds() function</span>
      etherStore<span class="token punctuation">.</span>depositFunds<span class="token punctuation">.</span><span class="token function">value</span><span class="token punctuation">(</span><span class="token number">1</span> ether<span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token comment">// start the magic</span>
      etherStore<span class="token punctuation">.</span><span class="token function">withdrawFunds</span><span class="token punctuation">(</span><span class="token number">1</span> ether<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">&#125;</span>

  <span class="token keyword">function</span> <span class="token function">collectEther</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">public</span> <span class="token punctuation">&#123;</span>
      msg<span class="token punctuation">.</span>sender<span class="token punctuation">.</span><span class="token function">transfer</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>balance<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">&#125;</span>

  <span class="token comment">// fallback function - where the magic happens</span>
  <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">payable</span> <span class="token punctuation">&#123;</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>etherStore<span class="token punctuation">.</span>balance <span class="token operator">></span> <span class="token number">1</span> ether<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
          etherStore<span class="token punctuation">.</span><span class="token function">withdrawFunds</span><span class="token punctuation">(</span><span class="token number">1</span> ether<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">&#125;</span>
  <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></div></figure>

<p>漏洞利用如何发生？首先，攻击者会使用 <code>EtherStore</code> 的合约地址作为唯一的构造函数参数来创建恶意合约（假设在地址 <code>0x0...123</code>）。这将初始化公共变量 <code>etherStore</code> 并将其指向要攻击的合约。</p>
<p>然后攻击者将调用 <code>attackEtherStore</code> 函数，其中一定数量的以太大于或等于1——让我们暂时假设 <code>1 ether</code>。在此示例中，我们还将假设许多其他用户已将以太币存入该合约，因此其当前余额为 <code>10 ether</code>。然后会出现以下情况：</p>
<ol>
<li><em>Attack.sol</em>，第 15 行：<code>EtherStore</code> 合约的 <code>depositFunds</code> 函数将被调用，<code>msg.value</code> 为 <code>1 ether</code>（以及大量gas）。发送者（<code>msg.sender</code>）将是恶意合约（<code>0x0…123</code>）。因此，<code>balance[0x0..123] = 1 ether</code>。</li>
<li><em>Attack.sol</em>，第 17 行：恶意合约随后将调用参数为 <code>1 ether</code> 的 <code>EtherStore</code> 合约的 <code>withdrawFunds</code> 函数。这将通过所有要求（<code>EtherStore</code> 合约的第 12-16 行），因为之前没有提款。</li>
<li><em>EtherStore.sol</em>，第 17 行：合约会将 <code>1 ether</code> 发送回恶意合约。</li>
<li><em>Attack.sol</em>，第 25 行：支付给恶意合约的款项将执行 fallback 函数。</li>
<li><em>Attack.sol</em>，第 26 行：EtherStore 合约的总余额是 <code>10 ether</code>，现在是 <code>9 ether</code>，所以这个 if 语句通过了。</li>
<li><em>Attack.sol</em>，第 27 行：回退函数再次调用 <code>EtherStore</code> 的 <code>withdrawFunds</code> 函数并“重新进入”<code>EtherStore</code> 合约。</li>
<li><em>EtherStore.sol</em>，第 11 行：在第二次调用 <code>withdrawFunds</code> 时，攻击合约的余额仍然是 <code>1 ether</code>，因为第 18 行尚未执行。因此，我们仍然有 <code>balances[0x0..123] = 1 ether</code>。<code>lastWithdrawTime</code> 变量也是如此。同样，我们通过了所有要求。</li>
<li><em>EtherStore.sol</em>，第 17 行：攻击合约提取另外 <code>1 ether</code>。</li>
<li>重复步骤 4-8，直到 <code>EtherStore.balance &gt; 1</code> 不再出现，如 Attack.sol 中的第 26 行所示。</li>
<li><em>Attack.sol</em>，第 26 行：一旦 <code>EtherStore</code> 合约中剩下 1 个（或更少）以太币，这个 <code>if</code> 语句就会失败。然后，这将允许执行 <code>EtherStore</code>合约的第 18 行和第 19 行（每次调用<code>withdrawFunds</code> 函数）。</li>
<li><em>EtherStore.sol</em>，第 18 行和第 19 行：<code>balances</code> 和 <code>lastWithdrawTime</code> 映射将被设置，执行将结束。</li>
</ol>
<p>最终结果是攻击者在一次交易中从 <code>EtherStore</code> 合约中提取了除 1 个以太币之外的所有以太币。</p>
<h3 id="预防技术"><a href="#预防技术" class="headerlink" title="预防技术"></a>预防技术</h3><p>有许多常用技术可以帮助避免智能合约中潜在的重入漏洞。<strong>第一个是（尽可能）在向外部合约发送以太币时使用内置的transfer函数。</strong>transfer 函数只发送 2300 gas 与外部调用，这不足以让目标地址&#x2F;合约调用另一个合约（即重新进入发送合约）。</p>
<p><strong>第二种技术是确保所有更改状态变量的逻辑都发生在以太被发送出合约（或任何外部调用）之前。</strong>在 <code>EtherStore</code> 示例中，应将 EtherStore.sol 的第 18 行和第 19 行放在第 17 行之前。<strong>对于对未知地址执行外部调用的任何代码，最好将其作为本地化函数或代码执行中的最后一个操作。</strong>这被称为<a target="_blank" rel="noopener" href="https://docs.soliditylang.org/en/latest/security-considerations.html#use-the-checks-effects-interactions-pattern">checks-effects-interactions pattern</a>。</p>
<p><strong>第三种技术是引入互斥锁(mutex)——即添加一个状态变量，在代码执行期间锁定合约，防止重入调用。</strong></p>
<figure><div class="code-wrapper"><pre class="line-numbers language-solidity" data-language="solidity"><code class="language-solidity"><span class="token keyword">contract</span> <span class="token class-name">EtherStore</span> <span class="token punctuation">&#123;</span>

    <span class="token comment">// initialize the mutex</span>
    <span class="token builtin">bool</span> reEntrancyMutex <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
    <span class="token builtin">uint256</span> <span class="token keyword">public</span> withdrawalLimit <span class="token operator">=</span> <span class="token number">1</span> ether<span class="token punctuation">;</span>
    <span class="token keyword">mapping</span><span class="token punctuation">(</span><span class="token builtin">address</span> <span class="token operator">=></span> <span class="token builtin">uint256</span><span class="token punctuation">)</span> <span class="token keyword">public</span> lastWithdrawTime<span class="token punctuation">;</span>
    <span class="token keyword">mapping</span><span class="token punctuation">(</span><span class="token builtin">address</span> <span class="token operator">=></span> <span class="token builtin">uint256</span><span class="token punctuation">)</span> <span class="token keyword">public</span> balances<span class="token punctuation">;</span>

    <span class="token keyword">function</span> <span class="token function">depositFunds</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">external</span> <span class="token keyword">payable</span> <span class="token punctuation">&#123;</span>
        balances<span class="token punctuation">[</span>msg<span class="token punctuation">.</span>sender<span class="token punctuation">]</span> <span class="token operator">+=</span> msg<span class="token punctuation">.</span>value<span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>

    <span class="token keyword">function</span> withdrawFunds <span class="token punctuation">(</span><span class="token builtin">uint256</span> _weiToWithdraw<span class="token punctuation">)</span> <span class="token keyword">public</span> <span class="token punctuation">&#123;</span>
        <span class="token keyword">require</span><span class="token punctuation">(</span><span class="token operator">!</span>reEntrancyMutex<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">require</span><span class="token punctuation">(</span>balances<span class="token punctuation">[</span>msg<span class="token punctuation">.</span>sender<span class="token punctuation">]</span> <span class="token operator">>=</span> _weiToWithdraw<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// limit the withdrawal</span>
        <span class="token keyword">require</span><span class="token punctuation">(</span>_weiToWithdraw <span class="token operator">&lt;=</span> withdrawalLimit<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// limit the time allowed to withdraw</span>
        <span class="token keyword">require</span><span class="token punctuation">(</span>now <span class="token operator">>=</span> lastWithdrawTime<span class="token punctuation">[</span>msg<span class="token punctuation">.</span>sender<span class="token punctuation">]</span> <span class="token operator">+</span> <span class="token number">1</span> weeks<span class="token punctuation">)</span><span class="token punctuation">;</span>
        balances<span class="token punctuation">[</span>msg<span class="token punctuation">.</span>sender<span class="token punctuation">]</span> <span class="token operator">-=</span> _weiToWithdraw<span class="token punctuation">;</span>
        lastWithdrawTime<span class="token punctuation">[</span>msg<span class="token punctuation">.</span>sender<span class="token punctuation">]</span> <span class="token operator">=</span> now<span class="token punctuation">;</span>
        <span class="token comment">// set the reEntrancy mutex before the external call</span>
        reEntrancyMutex <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
        msg<span class="token punctuation">.</span>sender<span class="token punctuation">.</span><span class="token function">transfer</span><span class="token punctuation">(</span>_weiToWithdraw<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// release the mutex after the external call</span>
        reEntrancyMutex <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
 <span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></div></figure>

<h3 id="现实世界的例子：The-DAO"><a href="#现实世界的例子：The-DAO" class="headerlink" title="现实世界的例子：The DAO"></a>现实世界的例子：The DAO</h3><p>The DAO（去中心化自治组织）攻击是以太坊早期开发中发生的主要黑客攻击之一。当时，合约金额超过 1.5 亿美元。重入在攻击中发挥了重要作用，最终导致了创建以太坊经典（ETC）的硬分叉。有关 DAO 漏洞利用的良好分析，请参阅 <a target="_blank" rel="noopener" href="http://bit.ly/2EQaLCI">Analysis of the DAO exploit (hackingdistributed.com)</a>。有关以太坊分叉历史、DAO 黑客时间表以及硬分叉中 ETC 诞生的更多信息，请参见 <a target="_blank" rel="noopener" href="https://github.com/ethereumbook/ethereumbook/blob/develop/09smart-contracts-security.asciidoc#ethereum_standards">ethereum_standards</a>。</p>
<h2 id="算术上溢-x2F-下溢-Arithmetic-Over-x2F-Underflows"><a href="#算术上溢-x2F-下溢-Arithmetic-Over-x2F-Underflows" class="headerlink" title="算术上溢&#x2F;下溢 (Arithmetic Over&#x2F;Underflows)"></a>算术上溢&#x2F;下溢 (Arithmetic Over&#x2F;Underflows)</h2><p>以太坊虚拟机为整数指定固定大小的数据类型。这意味着一个整数变量只能表示一定范围的数字。例如，一个 <code>uint8</code> 只能存储 [0,255] 范围内的数字。尝试将 <code>256</code> 存储到 <code>uint8</code> 将导致 <code>0</code>。如果不小心，如果未检查用户输入并且执行的计算导致数字超出存储它们的数据类型范围，那么 Solidity 中的变量就会被利用。</p>
<p>有关算术上溢&#x2F;下溢的进一步阅读，请参阅“<a target="_blank" rel="noopener" href="https://medium.com/loom-network/how-to-secure-your-smart-contracts-6-solidity-vulnerabilities-and-how-to-avoid-them-part-1-c33048d4d17d">How to Secure Your Smart Contracts</a>”、<a target="_blank" rel="noopener" href="https://consensys.github.io/smart-contract-best-practices/">Ethereum Smart Contract Best Practices</a> 和“<a target="_blank" rel="noopener" href="https://randomoracle.wordpress.com/2018/04/27/ethereum-solidity-and-integer-overflows-programming-blockchains-like-1970/">Ethereum, Solidity and integer overflows: programming blockchains like 1970</a>”。</p>
<h3 id="漏洞-1"><a href="#漏洞-1" class="headerlink" title="漏洞"></a>漏洞</h3><p>当执行需要固定大小的变量来存储超出变量数据类型范围的数字（或数据段）的操作时，会发生上溢&#x2F;下溢。</p>
<p>例如，从值为 <code>0</code> 的 <code>uint8</code>（8 位无符号整数；即非负数）变量中减去 <code>1</code> 将得到数字 <code>255</code>。这是下溢(<em>underflow</em>)。我们已经分配了一个低于 <code>uint8</code> 范围的数字，因此结果会环绕(<em>wraps around</em>)并给出 <code>uint8</code> 可以存储的最大数字。同样，将 <code>2^8=256</code> 加到一个 <code>uint8</code> 变量将使变量保持不变，因为我们已经环绕了 <code>uint</code> 的整个长度。这种行为的两个简单类比是汽车中的里程表，它测量行驶距离（在超过最大数字，即 999999 之后，它们重置为 000000）和周期性数学函数（在 sin 的参数中添加 2π 保持值不变） .</p>
<p>加上大于数据类型范围的数字称为上溢(<em>overflow</em>)。为清楚起见，将 <code>257</code> 添加到当前值为 <code>0</code> 的 <code>uint8</code> 将导致数字 <code>1</code>。有时将固定大小的变量视为循环变量是有启发性的，如果我们将数字添加到最大值之上，我们将从零重新开始可能存储的数字，如果我们从零减去，则从最大数字开始倒数。在有符号的 <code>int</code> 类型可以表示负数的情况下，一旦达到最大的负值，我们就会重新开始；例如，如果我们尝试从值为 <code>-128</code> 的 <code>int8</code> 中减去 <code>1</code>，我们将得到 <code>127</code>。</p>
<p>这些类型的数字陷阱允许攻击者滥用代码并创建意外的逻辑流。例如，考虑 TimeLock.sol 中的 TimeLock 合约。</p>
<p>示例3. TimeLock.sol</p>
<figure><div class="code-wrapper"><pre class="line-numbers language-solidity" data-language="solidity"><code class="language-solidity"><span class="token keyword">contract</span> <span class="token class-name">TimeLock</span> <span class="token punctuation">&#123;</span>

    <span class="token keyword">mapping</span><span class="token punctuation">(</span><span class="token builtin">address</span> <span class="token operator">=></span> <span class="token builtin">uint</span><span class="token punctuation">)</span> <span class="token keyword">public</span> balances<span class="token punctuation">;</span>
    <span class="token keyword">mapping</span><span class="token punctuation">(</span><span class="token builtin">address</span> <span class="token operator">=></span> <span class="token builtin">uint</span><span class="token punctuation">)</span> <span class="token keyword">public</span> lockTime<span class="token punctuation">;</span>

    <span class="token keyword">function</span> <span class="token function">deposit</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">external</span> <span class="token keyword">payable</span> <span class="token punctuation">&#123;</span>
        balances<span class="token punctuation">[</span>msg<span class="token punctuation">.</span>sender<span class="token punctuation">]</span> <span class="token operator">+=</span> msg<span class="token punctuation">.</span>value<span class="token punctuation">;</span>
        lockTime<span class="token punctuation">[</span>msg<span class="token punctuation">.</span>sender<span class="token punctuation">]</span> <span class="token operator">=</span> now <span class="token operator">+</span> <span class="token number">1</span> weeks<span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>

    <span class="token keyword">function</span> <span class="token function">increaseLockTime</span><span class="token punctuation">(</span><span class="token builtin">uint</span> _secondsToIncrease<span class="token punctuation">)</span> <span class="token keyword">public</span> <span class="token punctuation">&#123;</span>
        lockTime<span class="token punctuation">[</span>msg<span class="token punctuation">.</span>sender<span class="token punctuation">]</span> <span class="token operator">+=</span> _secondsToIncrease<span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>

    <span class="token keyword">function</span> <span class="token function">withdraw</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">public</span> <span class="token punctuation">&#123;</span>
        <span class="token keyword">require</span><span class="token punctuation">(</span>balances<span class="token punctuation">[</span>msg<span class="token punctuation">.</span>sender<span class="token punctuation">]</span> <span class="token operator">></span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">require</span><span class="token punctuation">(</span>now <span class="token operator">></span> lockTime<span class="token punctuation">[</span>msg<span class="token punctuation">.</span>sender<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token builtin">uint</span> transferValue <span class="token operator">=</span> balances<span class="token punctuation">[</span>msg<span class="token punctuation">.</span>sender<span class="token punctuation">]</span><span class="token punctuation">;</span>
        balances<span class="token punctuation">[</span>msg<span class="token punctuation">.</span>sender<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
        msg<span class="token punctuation">.</span>sender<span class="token punctuation">.</span><span class="token function">transfer</span><span class="token punctuation">(</span>transferValue<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></div></figure>

<p>这份合约的设计就像一个时间保险库：用户可以将以太币存入合约，并将被锁定至少一周。如果他们愿意，用户可以将等待时间延长到 1 周以上，但一旦存入，用户可以确保他们的以太币被安全锁定至少一周。</p>
<p>如果用户被迫交出他们的私钥，这样的合约可能会很方便地确保他们的以太币在短时间内无法获得。但是，如果用户在该合约中锁定了 <code>100 ether</code> 并将其密钥交给攻击者，则攻击者可以使用溢出来接收以太币，而不管锁定时间如何。</p>
<p>攻击者可以确定他们现在持有密钥的地址的当前 <code>lockTime</code>（它是一个公共变量）。我们称之为 <code>userLockTime</code>。然后他们可以调用 <code>increaseLockTime</code> 函数并将数字 <code>2^256 - userLockTime</code> 作为参数传递。这个数字将被添加到当前 <code>userLockTime</code> 并导致溢出，将 <code>lockTime[msg.sender]</code> 重置为 <code>0</code>。然后攻击者可以简单地调用 <code>withdraw</code> 函数来获得他们的奖励。</p>
<p>让我们看另一个示例(<a target="_blank" rel="noopener" href="https://github.com/ethereumbook/ethereumbook/blob/develop/09smart-contracts-security.asciidoc#underflow_vulnerability_example_from_ethernaut_challenge">Underflow vulnerability example from Ethernaut challenge</a>)，这来自 <a target="_blank" rel="noopener" href="https://github.com/OpenZeppelin/ethernaut">Ethernaut challenges</a>。</p>
<p>剧透警告：如果您还没有完成 Ethernaut challenges，这将提供其中一个级别的解决方案。</p>
<p>示例4. Underflow vulnerability example from Ethernaut challenge</p>
<figure><div class="code-wrapper"><pre class="line-numbers language-solidity" data-language="solidity"><code class="language-solidity"><span class="token keyword">pragma</span> <span class="token keyword">solidity</span> <span class="token operator">^</span><span class="token version number">0.4.18</span><span class="token punctuation">;</span>

<span class="token keyword">contract</span> <span class="token class-name">Token</span> <span class="token punctuation">&#123;</span>

  <span class="token keyword">mapping</span><span class="token punctuation">(</span><span class="token builtin">address</span> <span class="token operator">=></span> <span class="token builtin">uint</span><span class="token punctuation">)</span> balances<span class="token punctuation">;</span>
  <span class="token builtin">uint</span> <span class="token keyword">public</span> totalSupply<span class="token punctuation">;</span>

  <span class="token keyword">function</span> <span class="token function">Token</span><span class="token punctuation">(</span><span class="token builtin">uint</span> _initialSupply<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    balances<span class="token punctuation">[</span>msg<span class="token punctuation">.</span>sender<span class="token punctuation">]</span> <span class="token operator">=</span> totalSupply <span class="token operator">=</span> _initialSupply<span class="token punctuation">;</span>
  <span class="token punctuation">&#125;</span>

  <span class="token keyword">function</span> <span class="token function">transfer</span><span class="token punctuation">(</span><span class="token builtin">address</span> _to<span class="token punctuation">,</span> <span class="token builtin">uint</span> _value<span class="token punctuation">)</span> <span class="token keyword">public</span> <span class="token keyword">returns</span> <span class="token punctuation">(</span><span class="token builtin">bool</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">require</span><span class="token punctuation">(</span>balances<span class="token punctuation">[</span>msg<span class="token punctuation">.</span>sender<span class="token punctuation">]</span> <span class="token operator">-</span> _value <span class="token operator">>=</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    balances<span class="token punctuation">[</span>msg<span class="token punctuation">.</span>sender<span class="token punctuation">]</span> <span class="token operator">-=</span> _value<span class="token punctuation">;</span>
    balances<span class="token punctuation">[</span>_to<span class="token punctuation">]</span> <span class="token operator">+=</span> _value<span class="token punctuation">;</span>
    <span class="token keyword">return</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
  <span class="token punctuation">&#125;</span>

  <span class="token keyword">function</span> <span class="token function">balanceOf</span><span class="token punctuation">(</span><span class="token builtin">address</span> _owner<span class="token punctuation">)</span> <span class="token keyword">public</span> <span class="token keyword">constant</span> <span class="token keyword">returns</span> <span class="token punctuation">(</span><span class="token builtin">uint</span> balance<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">return</span> balances<span class="token punctuation">[</span>_owner<span class="token punctuation">]</span><span class="token punctuation">;</span>
  <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></div></figure>

<p>这是一个使用转移功能的简单代币合约，允许参与者移动他们的代币。你能看出这份合约的错误吗？</p>
<p>缺陷出现在 <code>transfer</code> 函数中。可以使用下溢绕过第 13 行的 require 语句。考虑一个余额为零的用户。他们可以使用任何非零 <code>_value</code> 调用 <code>transfer</code> 函数并在第 13 行传递 require 语句。这是因为 <code>balances[msg.sender]</code> 为 0（和 <code>uint256</code>），因此减去任何正数（不包括 <code>2^256</code>）将导致一个正数，如前所述。第 14 行也是如此，其中余额将记为正数。因此，在此示例中，攻击者可以通过下溢漏洞获得免费代币。</p>
<h3 id="预防技术-1"><a href="#预防技术-1" class="headerlink" title="预防技术"></a>预防技术</h3><p><strong>当前防止下溢&#x2F;下溢漏洞的常规技术是使用或构建数学库来替换标准数学运算符加法、减法和乘法（除法被排除在外，因为它不会导致上溢&#x2F;下溢，并且 EVM 在除以 0 时 revert）。</strong></p>
<p><a target="_blank" rel="noopener" href="https://github.com/OpenZeppelin/openzeppelin-contracts">OpenZeppelin</a> 在为以太坊社区构建和审核安全库方面做得非常出色。特别是，它的 <a target="_blank" rel="noopener" href="https://github.com/OpenZeppelin/openzeppelin-contracts/blob/v1.12.0/contracts/math/SafeMath.sol">SafeMath</a> 库可用于避免下溢&#x2F;上溢漏洞。</p>
<p>为了演示如何在 Solidity 中使用这些库，让我们使用 SafeMath 库更正 TimeLock 合约。合约的无溢出版本是：</p>
<figure><div class="code-wrapper"><pre class="line-numbers language-solidity" data-language="solidity"><code class="language-solidity"><span class="token keyword">library</span> <span class="token class-name">SafeMath</span> <span class="token punctuation">&#123;</span>

  <span class="token keyword">function</span> <span class="token function">mul</span><span class="token punctuation">(</span><span class="token builtin">uint256</span> a<span class="token punctuation">,</span> <span class="token builtin">uint256</span> b<span class="token punctuation">)</span> <span class="token keyword">internal</span> <span class="token keyword">pure</span> <span class="token keyword">returns</span> <span class="token punctuation">(</span><span class="token builtin">uint256</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>a <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
      <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
    <span class="token builtin">uint256</span> c <span class="token operator">=</span> a <span class="token operator">*</span> b<span class="token punctuation">;</span>
    <span class="token keyword">assert</span><span class="token punctuation">(</span>c <span class="token operator">/</span> a <span class="token operator">==</span> b<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> c<span class="token punctuation">;</span>
  <span class="token punctuation">&#125;</span>

  <span class="token keyword">function</span> <span class="token function">div</span><span class="token punctuation">(</span><span class="token builtin">uint256</span> a<span class="token punctuation">,</span> <span class="token builtin">uint256</span> b<span class="token punctuation">)</span> <span class="token keyword">internal</span> <span class="token keyword">pure</span> <span class="token keyword">returns</span> <span class="token punctuation">(</span><span class="token builtin">uint256</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token comment">// assert(b > 0); // Solidity automatically throws when dividing by 0</span>
    <span class="token builtin">uint256</span> c <span class="token operator">=</span> a <span class="token operator">/</span> b<span class="token punctuation">;</span>
    <span class="token comment">// assert(a == b * c + a % b); // This holds in all cases</span>
    <span class="token keyword">return</span> c<span class="token punctuation">;</span>
  <span class="token punctuation">&#125;</span>

  <span class="token keyword">function</span> <span class="token function">sub</span><span class="token punctuation">(</span><span class="token builtin">uint256</span> a<span class="token punctuation">,</span> <span class="token builtin">uint256</span> b<span class="token punctuation">)</span> <span class="token keyword">internal</span> <span class="token keyword">pure</span> <span class="token keyword">returns</span> <span class="token punctuation">(</span><span class="token builtin">uint256</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">assert</span><span class="token punctuation">(</span>b <span class="token operator">&lt;=</span> a<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> a <span class="token operator">-</span> b<span class="token punctuation">;</span>
  <span class="token punctuation">&#125;</span>

  <span class="token keyword">function</span> <span class="token function">add</span><span class="token punctuation">(</span><span class="token builtin">uint256</span> a<span class="token punctuation">,</span> <span class="token builtin">uint256</span> b<span class="token punctuation">)</span> <span class="token keyword">internal</span> <span class="token keyword">pure</span> <span class="token keyword">returns</span> <span class="token punctuation">(</span><span class="token builtin">uint256</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token builtin">uint256</span> c <span class="token operator">=</span> a <span class="token operator">+</span> b<span class="token punctuation">;</span>
    <span class="token keyword">assert</span><span class="token punctuation">(</span>c <span class="token operator">>=</span> a<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> c<span class="token punctuation">;</span>
  <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span>

<span class="token keyword">contract</span> <span class="token class-name">TimeLock</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">using</span> <span class="token class-name">SafeMath</span> <span class="token keyword">for</span> <span class="token builtin">uint</span><span class="token punctuation">;</span> <span class="token comment">// use the library for uint type</span>
    <span class="token keyword">mapping</span><span class="token punctuation">(</span><span class="token builtin">address</span> <span class="token operator">=></span> <span class="token builtin">uint256</span><span class="token punctuation">)</span> <span class="token keyword">public</span> balances<span class="token punctuation">;</span>
    <span class="token keyword">mapping</span><span class="token punctuation">(</span><span class="token builtin">address</span> <span class="token operator">=></span> <span class="token builtin">uint256</span><span class="token punctuation">)</span> <span class="token keyword">public</span> lockTime<span class="token punctuation">;</span>

    <span class="token keyword">function</span> <span class="token function">deposit</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">external</span> <span class="token keyword">payable</span> <span class="token punctuation">&#123;</span>
        balances<span class="token punctuation">[</span>msg<span class="token punctuation">.</span>sender<span class="token punctuation">]</span> <span class="token operator">=</span> balances<span class="token punctuation">[</span>msg<span class="token punctuation">.</span>sender<span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>msg<span class="token punctuation">.</span>value<span class="token punctuation">)</span><span class="token punctuation">;</span>
        lockTime<span class="token punctuation">[</span>msg<span class="token punctuation">.</span>sender<span class="token punctuation">]</span> <span class="token operator">=</span> now<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span><span class="token number">1</span> weeks<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>

    <span class="token keyword">function</span> <span class="token function">increaseLockTime</span><span class="token punctuation">(</span><span class="token builtin">uint256</span> _secondsToIncrease<span class="token punctuation">)</span> <span class="token keyword">public</span> <span class="token punctuation">&#123;</span>
        lockTime<span class="token punctuation">[</span>msg<span class="token punctuation">.</span>sender<span class="token punctuation">]</span> <span class="token operator">=</span> lockTime<span class="token punctuation">[</span>msg<span class="token punctuation">.</span>sender<span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>_secondsToIncrease<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>

    <span class="token keyword">function</span> <span class="token function">withdraw</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">public</span> <span class="token punctuation">&#123;</span>
        <span class="token keyword">require</span><span class="token punctuation">(</span>balances<span class="token punctuation">[</span>msg<span class="token punctuation">.</span>sender<span class="token punctuation">]</span> <span class="token operator">></span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">require</span><span class="token punctuation">(</span>now <span class="token operator">></span> lockTime<span class="token punctuation">[</span>msg<span class="token punctuation">.</span>sender<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token builtin">uint256</span> transferValue <span class="token operator">=</span> balances<span class="token punctuation">[</span>msg<span class="token punctuation">.</span>sender<span class="token punctuation">]</span><span class="token punctuation">;</span>
        balances<span class="token punctuation">[</span>msg<span class="token punctuation">.</span>sender<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
        msg<span class="token punctuation">.</span>sender<span class="token punctuation">.</span><span class="token function">transfer</span><span class="token punctuation">(</span>transferValue<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></div></figure>

<p>请注意，所有标准数学运算都已替换为 <code>SafeMath</code> 库中定义的运算。 <code>TimeLock</code> 合约不再执行任何能够下溢&#x2F;溢出的操作。</p>
<h3 id="现实世界的例子：PoWHC-和批量传输溢出-CVE-2018-10299"><a href="#现实世界的例子：PoWHC-和批量传输溢出-CVE-2018-10299" class="headerlink" title="现实世界的例子：PoWHC 和批量传输溢出(CVE-2018-10299)"></a>现实世界的例子：PoWHC 和批量传输溢出(CVE-2018-10299)</h3><p>弱手币证明 (Proof of Weak Hands Coin, PoWHC) 最初是为了某种玩笑而设计的，是一个由互联网集体编写的庞氏骗局。不幸的是，合约的作者似乎之前没有看到过溢出&#x2F;下溢，因此 866 以太币从其合约中解放出来。 Eric Banisadr 在他关于该事件的博客文章(<a target="_blank" rel="noopener" href="https://medium.com/@ebanisadr/how-800k-evaporated-from-the-powh-coin-ponzi-scheme-overnight-1b025c33b530">How $800k Evaporated from the PoWH Coin Ponzi Scheme Overnight</a>)中很好地概述了下溢是如何发生的（这与前面描述的 Ethernaut challenge 并没有太大的不同）。</p>
<p>另一个例子(<a target="_blank" rel="noopener" href="https://github.com/ethereum/EIPs/blob/master/EIPS/eip-20.md">EIPs&#x2F;eip-20</a>)来自在一组 ERC20 代币合约中实现 <code>batchTransfer()</code> 函数。该实现包含溢出漏洞；您可以阅读 <a target="_blank" rel="noopener" href="https://peckshield.medium.com/alert-new-batchoverflow-bug-in-multiple-erc20-smart-contracts-cve-2018-10299-511067db6536">PeckShield’s account</a> 中的详细信息。</p>
<h2 id="意外的以太币-Unexpected-Ether"><a href="#意外的以太币-Unexpected-Ether" class="headerlink" title="意外的以太币 (Unexpected Ether)"></a>意外的以太币 (Unexpected Ether)</h2><p>通常，当以太币被发送到合约时，它必须执行 fallback 函数或合约中定义的另一个函数。有两个例外，以太可以存在于合约中而无需执行任何代码。对于发送给他们的所有以太币，依赖于代码执行的合约可能容易受到强制发送以太币的攻击。</p>
<p>有关这方面的进一步阅读，请参阅“<a target="_blank" rel="noopener" href="https://medium.com/loom-network/how-to-secure-your-smart-contracts-6-solidity-vulnerabilities-and-how-to-avoid-them-part-2-730db0aa4834">How to Secure Your Smart Contracts</a>”。</p>
<h3 id="漏洞-2"><a href="#漏洞-2" class="headerlink" title="漏洞"></a>漏洞</h3><p><strong>用于强制执行正确的状态转换或验证操作的常见防御性编程技术是不变检查(invariant checking)。</strong>该技术涉及定义一组不变量(<em>invariants</em>)（不应改变的度量或参数）并检查它们在单个（或多个）操作后是否保持不变。如果被检查的不变量是实际上的不变量，这通常是一个好的设计。不变量的一个例子是固定发行的 <a target="_blank" rel="noopener" href="http://bit.ly/2CUf7WG">ERC20 token</a> 的 <code>totalSupply</code>。由于任何函数都不应修改此不变量，因此可以向 <code>transfer</code> 函数添加一个检查，以确保 <code>totalSupply</code> 保持不变，保证函数按预期工作。</p>
<p>特别是，有一个明显的不变量，它可能很容易使用，但实际上可以被外部用户操纵（不管智能合约中的规则如何）。这是存储在合约中的当前以太币。通常，当开发人员第一次学习 Solidity 时，他们会误认为合约只能通过支付功能接受或获得以太币。这种误解可能导致合约对其中的以太币余额做出错误假设，从而导致一系列漏洞。这个漏洞的确凿证据是 <code>this.balance</code> 的（不正确的）使用。</p>
<p>有两种方法可以（强制）将以太币发送到合约，而无需使用可支付函数或在合约上执行任何代码：</p>
<p><em>自毁(Self-destruct)</em></p>
<p>任何合约都可以实现 <a target="_blank" rel="noopener" href="https://docs.soliditylang.org/en/latest/introduction-to-smart-contracts.html#self-destruct">selfdestruct 函数</a>，该功能从合约地址中删除所有字节码，并将存储在那里的所有以太币发送到参数指定的地址。<strong>如果这个指定的地址也是一个合约，则不会调用任何函数（包括 fallback）。</strong>因此，<code>selfdestruct</code> 函数<strong>可用于强制向任何合约发送以太币，而不管合约中可能存在的任何代码，甚至是没有支付功能的合约</strong>。这意味着任何攻击者都可以创建带有 <code>selfdestruct</code> 函数的合约，向其发送以太币，调用 <code>selfdestruct(target)</code> 并强制将以太币发送到目标合约。 Martin Swende 有一篇出色的博客文章(<a target="_blank" rel="noopener" href="https://swende.se/blog/Ethereum_quirks_and_vulns.html">Ethereum quirks and vulns</a>)，描述了 self-destruct 操作码的一些怪癖（Quirk #2），以及客户端节点如何检查不正确的不变量，这可能导致以太坊网络发生灾难性的崩溃。</p>
<p><em>赠送以太币(Pre-sent ether)</em></p>
<p><strong>将以太币加入合约的另一种方法是用以太币预加载合约地址。</strong>合约地址是确定性的——事实上，地址是根据创建合约的地址和创建合约的交易随机数的 Keccak-256（通常与 SHA-3 同义）哈希计算的。具体来说，它的格式为 <code>address = sha3(rlp.encode([account_address,transaction_nonce]))</code>（有关一些有趣的用例，请参见 Adrian Manning 关于“<a target="_blank" rel="noopener" href="https://blog.sigmaprime.io/solidity-security.html#keyless-eth">无密钥以太(Keyless Ether)</a>”的讨论）。这意味着任何人都可以在创建合约之前计算出合约的地址，并将以太币发送到该地址。创建合约时，它将有一个非零的以太币余额。</p>
<p>让我们探讨一下这些知识可能出现的一些陷阱。考虑一下 EtherGame.sol 中过于简单的合约。</p>
<p>示例5. EtherGame.sol</p>
<figure><div class="code-wrapper"><pre class="line-numbers language-solidity" data-language="solidity"><code class="language-solidity"><span class="token keyword">contract</span> <span class="token class-name">EtherGame</span> <span class="token punctuation">&#123;</span>

    <span class="token builtin">uint</span> <span class="token keyword">public</span> payoutMileStone1 <span class="token operator">=</span> <span class="token number">3</span> ether<span class="token punctuation">;</span>
    <span class="token builtin">uint</span> <span class="token keyword">public</span> mileStone1Reward <span class="token operator">=</span> <span class="token number">2</span> ether<span class="token punctuation">;</span>
    <span class="token builtin">uint</span> <span class="token keyword">public</span> payoutMileStone2 <span class="token operator">=</span> <span class="token number">5</span> ether<span class="token punctuation">;</span>
    <span class="token builtin">uint</span> <span class="token keyword">public</span> mileStone2Reward <span class="token operator">=</span> <span class="token number">3</span> ether<span class="token punctuation">;</span>
    <span class="token builtin">uint</span> <span class="token keyword">public</span> finalMileStone <span class="token operator">=</span> <span class="token number">10</span> ether<span class="token punctuation">;</span>
    <span class="token builtin">uint</span> <span class="token keyword">public</span> finalReward <span class="token operator">=</span> <span class="token number">5</span> ether<span class="token punctuation">;</span>

    <span class="token keyword">mapping</span><span class="token punctuation">(</span><span class="token builtin">address</span> <span class="token operator">=></span> <span class="token builtin">uint</span><span class="token punctuation">)</span> redeemableEther<span class="token punctuation">;</span>
    <span class="token comment">// Users pay 0.5 ether. At specific milestones, credit their accounts.</span>
    <span class="token keyword">function</span> <span class="token function">play</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">external</span> <span class="token keyword">payable</span> <span class="token punctuation">&#123;</span>
        <span class="token keyword">require</span><span class="token punctuation">(</span>msg<span class="token punctuation">.</span>value <span class="token operator">==</span> <span class="token number">0.5</span> ether<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// each play is 0.5 ether</span>
        <span class="token builtin">uint</span> currentBalance <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>balance <span class="token operator">+</span> msg<span class="token punctuation">.</span>value<span class="token punctuation">;</span>
        <span class="token comment">// ensure no players after the game has finished</span>
        <span class="token keyword">require</span><span class="token punctuation">(</span>currentBalance <span class="token operator">&lt;=</span> finalMileStone<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// if at a milestone, credit the player's account</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>currentBalance <span class="token operator">==</span> payoutMileStone1<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
            redeemableEther<span class="token punctuation">[</span>msg<span class="token punctuation">.</span>sender<span class="token punctuation">]</span> <span class="token operator">+=</span> mileStone1Reward<span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span>
        <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>currentBalance <span class="token operator">==</span> payoutMileStone2<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
            redeemableEther<span class="token punctuation">[</span>msg<span class="token punctuation">.</span>sender<span class="token punctuation">]</span> <span class="token operator">+=</span> mileStone2Reward<span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span>
        <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>currentBalance <span class="token operator">==</span> finalMileStone <span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
            redeemableEther<span class="token punctuation">[</span>msg<span class="token punctuation">.</span>sender<span class="token punctuation">]</span> <span class="token operator">+=</span> finalReward<span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span>
        <span class="token keyword">return</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>

    <span class="token keyword">function</span> <span class="token function">claimReward</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">public</span> <span class="token punctuation">&#123;</span>
        <span class="token comment">// ensure the game is complete</span>
        <span class="token keyword">require</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>balance <span class="token operator">==</span> finalMileStone<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// ensure there is a reward to give</span>
        <span class="token keyword">require</span><span class="token punctuation">(</span>redeemableEther<span class="token punctuation">[</span>msg<span class="token punctuation">.</span>sender<span class="token punctuation">]</span> <span class="token operator">></span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token builtin">uint</span> transferValue <span class="token operator">=</span> redeemableEther<span class="token punctuation">[</span>msg<span class="token punctuation">.</span>sender<span class="token punctuation">]</span><span class="token punctuation">;</span>
        redeemableEther<span class="token punctuation">[</span>msg<span class="token punctuation">.</span>sender<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
        msg<span class="token punctuation">.</span>sender<span class="token punctuation">.</span><span class="token function">transfer</span><span class="token punctuation">(</span>transferValue<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
 <span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></div></figure>

<p>该合约代表一个简单的游戏（自然会涉及竞赛条件），其中玩家向合约发送 0.5 以太币，希望成为首先达到三个里程碑之一的玩家。里程碑以以太币计价。当游戏结束时，第一个达到里程碑的人可能会获得一部分以太币。当达到最后一个里程碑（10 以太币）时，游戏结束；然后用户可以领取他们的奖励。</p>
<p><code>EtherGame</code> 合约的问题来自于第 14 行（以及第 16 行和第 32 行）对 <code>this.balance</code> 的使用不当。一个恶作剧的攻击者可以通过 <code>selfdestruct</code> 函数强行发送少量的以太币，比如 0.1 以太币（前面讨论过）以防止任何未来的玩家达到里程碑。由于这 0.1 以太币的贡献，<code>this.balance</code> 永远不会是 0.5 以太币的倍数，因为所有合法玩家只能发送 0.5 以太币增量。这可以防止第 18、21 和 24 行的所有 if 条件为真。</p>
<p>更糟糕的是，错过里程碑的报复性攻击者可以强行发送 10 个以太币（或等量的以太币，将合约的余额推高到 <code>finalMileStone</code> 之上），这将永远锁定合约中的所有奖励。这是因为由于第 32 行的要求，<code>claimReward</code> 函数将始终revert（即，因为 <code>this.balance</code> 大于 <code>finalMileStone</code>）。</p>
<h3 id="预防技术-2"><a href="#预防技术-2" class="headerlink" title="预防技术"></a>预防技术</h3><p>这种漏洞通常源于对 <code>this.balance</code> 的滥用。<strong>合约逻辑应尽可能避免依赖合约余额的确切值，因为它可以被人为操纵。</strong>如果应用基于 <code>this.balance</code> 的逻辑，您必须应对意外的余额。</p>
<p>如果需要存入的以太币的准确值，则应使用在payable函数中递增的自定义变量，以安全地跟踪存入的以太币。这个变量不会受到通过 <code>selfdestruct</code> 调用发送的强制以太币的影响。</p>
<p>考虑到这一点，<code>EtherGame</code> 合约的修正版本可能如下所示：</p>
<figure><div class="code-wrapper"><pre class="line-numbers language-solidity" data-language="solidity"><code class="language-solidity"><span class="token keyword">contract</span> <span class="token class-name">EtherGame</span> <span class="token punctuation">&#123;</span>

    <span class="token builtin">uint</span> <span class="token keyword">public</span> payoutMileStone1 <span class="token operator">=</span> <span class="token number">3</span> ether<span class="token punctuation">;</span>
    <span class="token builtin">uint</span> <span class="token keyword">public</span> mileStone1Reward <span class="token operator">=</span> <span class="token number">2</span> ether<span class="token punctuation">;</span>
    <span class="token builtin">uint</span> <span class="token keyword">public</span> payoutMileStone2 <span class="token operator">=</span> <span class="token number">5</span> ether<span class="token punctuation">;</span>
    <span class="token builtin">uint</span> <span class="token keyword">public</span> mileStone2Reward <span class="token operator">=</span> <span class="token number">3</span> ether<span class="token punctuation">;</span>
    <span class="token builtin">uint</span> <span class="token keyword">public</span> finalMileStone <span class="token operator">=</span> <span class="token number">10</span> ether<span class="token punctuation">;</span>
    <span class="token builtin">uint</span> <span class="token keyword">public</span> finalReward <span class="token operator">=</span> <span class="token number">5</span> ether<span class="token punctuation">;</span>
    <span class="token builtin">uint</span> <span class="token keyword">public</span> depositedWei<span class="token punctuation">;</span>

    <span class="token keyword">mapping</span> <span class="token punctuation">(</span><span class="token builtin">address</span> <span class="token operator">=></span> <span class="token builtin">uint</span><span class="token punctuation">)</span> redeemableEther<span class="token punctuation">;</span>

    <span class="token keyword">function</span> <span class="token function">play</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">external</span> <span class="token keyword">payable</span> <span class="token punctuation">&#123;</span>
        <span class="token keyword">require</span><span class="token punctuation">(</span>msg<span class="token punctuation">.</span>value <span class="token operator">==</span> <span class="token number">0.5</span> ether<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token builtin">uint</span> currentBalance <span class="token operator">=</span> depositedWei <span class="token operator">+</span> msg<span class="token punctuation">.</span>value<span class="token punctuation">;</span>
        <span class="token comment">// ensure no players after the game has finished</span>
        <span class="token keyword">require</span><span class="token punctuation">(</span>currentBalance <span class="token operator">&lt;=</span> finalMileStone<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>currentBalance <span class="token operator">==</span> payoutMileStone1<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
            redeemableEther<span class="token punctuation">[</span>msg<span class="token punctuation">.</span>sender<span class="token punctuation">]</span> <span class="token operator">+=</span> mileStone1Reward<span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span>
        <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>currentBalance <span class="token operator">==</span> payoutMileStone2<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
            redeemableEther<span class="token punctuation">[</span>msg<span class="token punctuation">.</span>sender<span class="token punctuation">]</span> <span class="token operator">+=</span> mileStone2Reward<span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span>
        <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>currentBalance <span class="token operator">==</span> finalMileStone <span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
            redeemableEther<span class="token punctuation">[</span>msg<span class="token punctuation">.</span>sender<span class="token punctuation">]</span> <span class="token operator">+=</span> finalReward<span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span>
        depositedWei <span class="token operator">+=</span> msg<span class="token punctuation">.</span>value<span class="token punctuation">;</span>
        <span class="token keyword">return</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>

    <span class="token keyword">function</span> <span class="token function">claimReward</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">public</span> <span class="token punctuation">&#123;</span>
        <span class="token comment">// ensure the game is complete</span>
        <span class="token keyword">require</span><span class="token punctuation">(</span>depositedWei <span class="token operator">==</span> finalMileStone<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// ensure there is a reward to give</span>
        <span class="token keyword">require</span><span class="token punctuation">(</span>redeemableEther<span class="token punctuation">[</span>msg<span class="token punctuation">.</span>sender<span class="token punctuation">]</span> <span class="token operator">></span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token builtin">uint</span> transferValue <span class="token operator">=</span> redeemableEther<span class="token punctuation">[</span>msg<span class="token punctuation">.</span>sender<span class="token punctuation">]</span><span class="token punctuation">;</span>
        redeemableEther<span class="token punctuation">[</span>msg<span class="token punctuation">.</span>sender<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
        msg<span class="token punctuation">.</span>sender<span class="token punctuation">.</span><span class="token function">transfer</span><span class="token punctuation">(</span>transferValue<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
 <span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></div></figure>

<p>在这里，我们创建了一个新变量，<code>depositedWei</code>，它跟踪已知的以太坊存款，我们将这个变量用于我们的测试。请注意，我们不再引用 <code>this.balance</code>。</p>
<h3 id="进一步的例子"><a href="#进一步的例子" class="headerlink" title="进一步的例子"></a>进一步的例子</h3><p><a target="_blank" rel="noopener" href="https://github.com/Arachnid/uscc/tree/master/submissions-2017/">Underhanded Solidity Coding Contest</a> 中给出了一些可利用合约的示例，还提供了本节中提出的许多陷阱的扩展示例。</p>
<h2 id="DELEGATECALL"><a href="#DELEGATECALL" class="headerlink" title="DELEGATECALL"></a>DELEGATECALL</h2><p><code>CALL</code> 和 <code>DELEGATECALL</code> 操作码在允许以太坊开发人员模块化他们的代码方面很有用。对合约的标准外部消息调用由 <code>CALL</code> 操作码处理，代码在外部合约&#x2F;函数的上下文中运行。 <code>DELEGATECALL</code> 操作码几乎相同，只是在目标地址执行的代码是在调用合约的上下文中运行的，并且 <code>msg.sender</code> 和 <code>msg.value</code> 保持不变。<strong>此特性支持库(libraries)的实现，允许开发人员一次性部署可重用代码并从未来的合约中调用它。</strong></p>
<p>尽管这两个操作码之间的区别简单直观，但使用 <code>DELEGATECALL</code> 可能会导致意外的代码执行。</p>
<p>如需进一步阅读，请参阅 Loi.Luu 关于此主题的 <a target="_blank" rel="noopener" href="https://ethereum.stackexchange.com/questions/3667/difference-between-call-callcode-and-delegatecall">Ethereum Stack Exchange</a> 问题和 <a target="_blank" rel="noopener" href="https://docs.soliditylang.org/en/latest/introduction-to-smart-contracts.html#delegatecall-callcode-and-libraries">Solidity 文档</a>。</p>
<h3 id="漏洞-3"><a href="#漏洞-3" class="headerlink" title="漏洞"></a>漏洞</h3><p>由于 <code>DELEGATECALL</code> 的上下文保留特性，构建无漏洞的自定义库并不像人们想象的那么容易。库本身的代码可以是安全且无漏洞的；但是，当在另一个应用程序的上下文中运行时，可能会出现新的漏洞。让我们看一个相当复杂的例子，使用斐波那契数。</p>
<p>考虑 FibonacciLib.sol 中的库，它可以生成 Fibonacci 序列和类似形式的序列。 （注意：此代码是从 <a target="_blank" rel="noopener" href="https://github.com/web3j/web3j/blob/master/codegen/src/test/resources/solidity/fibonacci/Fibonacci.sol">web3j&#x2F;Fibonacci.sol</a> 修改的。）</p>
<p>示例6. FibonacciLib.sol</p>
<figure><div class="code-wrapper"><pre class="line-numbers language-solidity" data-language="solidity"><code class="language-solidity"><span class="token comment">// library contract - calculates Fibonacci-like numbers</span>
<span class="token keyword">contract</span> <span class="token class-name">FibonacciLib</span> <span class="token punctuation">&#123;</span>
    <span class="token comment">// initializing the standard Fibonacci sequence</span>
    <span class="token builtin">uint</span> <span class="token keyword">public</span> start<span class="token punctuation">;</span>
    <span class="token builtin">uint</span> <span class="token keyword">public</span> calculatedFibNumber<span class="token punctuation">;</span>

    <span class="token comment">// modify the zeroth number in the sequence</span>
    <span class="token keyword">function</span> <span class="token function">setStart</span><span class="token punctuation">(</span><span class="token builtin">uint</span> _start<span class="token punctuation">)</span> <span class="token keyword">public</span> <span class="token punctuation">&#123;</span>
        start <span class="token operator">=</span> _start<span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>

    <span class="token keyword">function</span> <span class="token function">setFibonacci</span><span class="token punctuation">(</span><span class="token builtin">uint</span> n<span class="token punctuation">)</span> <span class="token keyword">public</span> <span class="token punctuation">&#123;</span>
        calculatedFibNumber <span class="token operator">=</span> <span class="token function">fibonacci</span><span class="token punctuation">(</span>n<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>

    <span class="token keyword">function</span> <span class="token function">fibonacci</span><span class="token punctuation">(</span><span class="token builtin">uint</span> n<span class="token punctuation">)</span> <span class="token keyword">internal</span> <span class="token keyword">returns</span> <span class="token punctuation">(</span><span class="token builtin">uint</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>n <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token keyword">return</span> start<span class="token punctuation">;</span>
        <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>n <span class="token operator">==</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token keyword">return</span> start <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">;</span>
        <span class="token keyword">else</span> <span class="token keyword">return</span> <span class="token function">fibonacci</span><span class="token punctuation">(</span>n <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token function">fibonacci</span><span class="token punctuation">(</span>n <span class="token operator">-</span> <span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></div></figure>

<p>这个库提供了一个函数，可以生成序列中的第 n 个斐波那契数。它允许用户更改序列的起始编号（<code>start</code>）并计算此新序列中的第 n 个类似斐波那契的数字。</p>
<p>现在让我们考虑一个使用这个库的合约，显示在 FibonacciBalance.sol 中。</p>
<p>示例7. FibonacciBalance.sol</p>
<figure><div class="code-wrapper"><pre class="line-numbers language-solidity" data-language="solidity"><code class="language-solidity"><span class="token keyword">contract</span> <span class="token class-name">FibonacciBalance</span> <span class="token punctuation">&#123;</span>

    <span class="token builtin">address</span> <span class="token keyword">public</span> fibonacciLibrary<span class="token punctuation">;</span>
    <span class="token comment">// the current Fibonacci number to withdraw</span>
    <span class="token builtin">uint</span> <span class="token keyword">public</span> calculatedFibNumber<span class="token punctuation">;</span>
    <span class="token comment">// the starting Fibonacci sequence number</span>
    <span class="token builtin">uint</span> <span class="token keyword">public</span> start <span class="token operator">=</span> <span class="token number">3</span><span class="token punctuation">;</span>
    <span class="token builtin">uint</span> <span class="token keyword">public</span> withdrawalCounter<span class="token punctuation">;</span>
    <span class="token comment">// the Fibonancci function selector</span>
    <span class="token builtin">bytes4</span> <span class="token keyword">constant</span> fibSig <span class="token operator">=</span> <span class="token builtin">bytes4</span><span class="token punctuation">(</span><span class="token function">sha3</span><span class="token punctuation">(</span><span class="token string">"setFibonacci(uint256)"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// constructor - loads the contract with ether</span>
    <span class="token keyword">constructor</span><span class="token punctuation">(</span><span class="token builtin">address</span> _fibonacciLibrary<span class="token punctuation">)</span> <span class="token keyword">external</span> <span class="token keyword">payable</span> <span class="token punctuation">&#123;</span>
        fibonacciLibrary <span class="token operator">=</span> _fibonacciLibrary<span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>

    <span class="token keyword">function</span> <span class="token function">withdraw</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        withdrawalCounter <span class="token operator">+=</span> <span class="token number">1</span><span class="token punctuation">;</span>
        <span class="token comment">// calculate the Fibonacci number for the current withdrawal user-</span>
        <span class="token comment">// this sets calculatedFibNumber</span>
        <span class="token keyword">require</span><span class="token punctuation">(</span>fibonacciLibrary<span class="token punctuation">.</span><span class="token function">delegatecall</span><span class="token punctuation">(</span>fibSig<span class="token punctuation">,</span> withdrawalCounter<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        msg<span class="token punctuation">.</span>sender<span class="token punctuation">.</span><span class="token function">transfer</span><span class="token punctuation">(</span>calculatedFibNumber <span class="token operator">*</span> <span class="token number">1</span> ether<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>

    <span class="token comment">// allow users to call Fibonacci library functions</span>
    <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">public</span> <span class="token punctuation">&#123;</span>
        <span class="token keyword">require</span><span class="token punctuation">(</span>fibonacciLibrary<span class="token punctuation">.</span><span class="token function">delegatecall</span><span class="token punctuation">(</span>msg<span class="token punctuation">.</span>data<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></div></figure>

<p>该合约允许参与者从合约中提取以太币，以太币数量等于参与者提现订单对应的斐波那契数；即，第一个参与者得到 1 个以太币，第二个也得到 1 个，第三个得到 2 个，第四个得到 3 个，第五个得到 5 个，依此类推（直到合约余额小于被提取的斐波那契数）。</p>
<p>本合约中的许多要素可能需要一些解释。首先，有一个看起来很有趣的变量 <code>fibSig</code>。这包含字符串 <code>&quot;setFibonacci(uint256)&quot;</code> 的 Keccak-256 (SHA-3) 散列的前 4 个字节。这被称为函数选择器，并被放入 <code>calldata</code> 以指定将调用智能合约的哪个函数。它在第 21 行的 <code>delegatecall</code> 函数中用于指定我们希望运行 <code>fibonacci(uint256)</code> 函数。 <code>delegatecall</code> 中的第二个参数是我们传递给函数的参数。其次，我们假设 <code>FibonacciLib</code> 库的地址在构造函数中被正确引用（<a target="_blank" rel="noopener" href="https://github.com/ethereumbook/ethereumbook/blob/develop/09smart-contracts-security.asciidoc#external_contract_referencing">外部合约引用</a>讨论了与这种合约引用初始化相关的一些潜在漏洞）。</p>
<p>你能发现这个合约中的任何错误吗？如果要部署这个合约，用以太币填充它，然后调用 <code>withdraw</code>，它可能会revert。</p>
<p>您可能已经注意到状态变量 <code>start</code> 在库和主调用合约中都使用了。在库合约中，<code>start</code> 用于指定斐波那契数列的开始，设置为 <code>0</code>，而在调用合约中设置为 <code>3</code>。您可能还注意到 <code>FibonacciBalance</code> 合约中的 <code>fallback</code> 函数允许将所有调用传递给库合约，这允许调用库合约的 <code>setStart</code> 函数。回想一下我们保留了合约的状态，这个函数似乎允许您更改本地 <code>FibonnacciBalance</code> 合约中 <code>start</code> 变量的状态。如果是这样，这将允许一个人提取更多的以太币，因为结果计算的 <code>FibNumber</code> 取决于 <code>start</code> 变量（如库合约中所示）。实际上，<code>setStart</code> 函数不会（也不能）修改 <code>FibonacciBalance</code> 合约中的 <code>start</code> 变量。该合约的潜在漏洞比仅仅修改 <code>start</code> 变量要严重得多。</p>
<p>在讨论实际问题之前，让我们快速了解一下状态变量是如何实际存储在合约中的。<strong>状态或存储变量（在单个交易中持续存在的变量）在合约中引入时按顺序放入槽(slots)中。</strong>（这里有一些复杂性；请查阅 Solidity 文档以获得更透彻的理解。）</p>
<p>作为一个例子，让我们看一下库合约。它有两个状态变量，<code>start</code> 和 <code>computedFibNumber</code>。第一个变量 <code>start</code> 存储在合约存储的 <code>slot[0]</code>（即第一个 slot）中。第二个变量 <code>calculatedFibNumber</code> 被放置在下一个可用的存储槽 <code>slot[1]</code> 中。函数 <code>setStart</code> 接受一个输入并将 <code>start</code> 设置为输入的任何内容。因此，此函数将 <code>slot[0]</code> 设置为我们在 <code>setStart</code> 函数中提供的任何输入。类似地，<code>setFibonacci</code> 函数将计算的 <code>FibNumber</code> 设置为 <code>fibonacci(n)</code> 的结果。同样，这只是将 storage <code>slot[1]</code> 设置为 <code>fibonacci(n)</code> 的值。</p>
<p>现在让我们看看 <code>FibonacciBalance</code> 合约。存储 <code>slot[0]</code> 现在对应 <code>fibonacciLibrary</code> 地址，<code>slot[1]</code> 对应计算的 <code>FibNumber</code>。<strong>漏洞正是在这个不正确的映射中发生的。</strong> <strong>delegatecall 保留合约上下文(preserves contract context)。这意味着通过 delegatecall 调用执行的代码将作用于调用合约的状态（如存储）。</strong></p>
<p>现在请注意，在第 21 行的 <code>withdraw</code> 中，我们执行了 <code>fibonacciLibrary.delegatecall(fibSig,withdrawalCounter)</code>。这调用了 <code>setFibonacci</code> 函数，正如我们所讨论的，它修改了存储 <code>slot[1]</code>，在我们当前的上下文中是 <code>calculatedFibNumber</code>。这是预期的（即执行后，计算的 <code>FibNumber</code> 被修改）。但是，回想一下 <code>FibonacciLib</code> 合约中的 <code>start</code> 变量位于 storage <code>slot[0]</code> 中，即当前合约中的 <code>fibonacciLibrary</code> 地址。这意味着函数 <code>fibonacci</code> 将给出意想不到的结果。这是因为它引用了 <code>start</code> (<code>slot[0]</code>)，它在当前调用上下文中是 <code>fibonacciLibrary</code> 地址（当解释为 <code>uint</code> 时，它通常会非常大）。因此，<code>withdraw</code> 函数很可能会 revert，因为它不会包含 <code>uint(fibonacciLibrary)</code> 数量的以太币，而这是 <code>calculatedFibNumber</code> 将返回的。</p>
<p>更糟糕的是，<code>FibonacciBalance</code> 合约允许用户通过第 26 行的 fallback 函数调用所有 <code>fibonacciLibrary</code> 函数。正如我们之前讨论的，这包括 <code>setStart</code> 函数。我们讨论过这个函数允许任何人修改或设置 storage <code>slot[0]</code>。在这种情况下，storage <code>slot[0]</code> 是 <code>fibonacciLibrary</code> 地址。因此，攻击者可以创建恶意合约，将地址转换为 <code>uint</code>（这可以在 Python 中使用 <code>int(&#39;&lt;address&gt;&#39;,16)</code> 轻松完成），然后调用 <code>setStart(&lt;attack_contract_address_as_uint&gt;)</code>。这会将 <code>fibonacciLibrary</code> 更改为攻击合约的地址。然后，每当用户调用 <code>withdraw</code> 或 fallback 函数时，恶意合约就会运行（这会窃取合约的全部余额），因为我们已经修改了 <code>fibonacciLibrary</code> 的实际地址。这种攻击合约的一个例子是：</p>
<figure><div class="code-wrapper"><pre class="line-numbers language-solidity" data-language="solidity"><code class="language-solidity"><span class="token keyword">contract</span> <span class="token class-name">Attack</span> <span class="token punctuation">&#123;</span>
    <span class="token builtin">uint</span> storageSlot0<span class="token punctuation">;</span> <span class="token comment">// corresponds to fibonacciLibrary</span>
    <span class="token builtin">uint</span> storageSlot1<span class="token punctuation">;</span> <span class="token comment">// corresponds to calculatedFibNumber</span>

    <span class="token comment">// fallback - this will run if a specified function is not found</span>
    <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">public</span> <span class="token punctuation">&#123;</span>
        storageSlot1 <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> <span class="token comment">// we set calculatedFibNumber to 0, so if withdraw</span>
        <span class="token comment">// is called we don't send out any ether</span>
        <span class="token operator">&lt;</span>attacker_address<span class="token operator">></span><span class="token punctuation">.</span><span class="token function">transfer</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>balance<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// we take all the ether</span>
    <span class="token punctuation">&#125;</span>
 <span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></div></figure>

<p>请注意，此攻击合约通过更改 storage <code>slot[1]</code> 来修改 <code>calculatedFibNumber</code>。原则上，攻击者可以修改他们选择的任何其他 storage slots，以对该合约执行各种攻击。我们鼓励您将这些合约放入 Remix 中，并通过这些 <code>delegatecall</code> 函数尝试不同的攻击合约和状态更改。</p>
<p>同样重要的是要注意，<strong>当我们说 delegatecall 是状态保留时，我们不是在谈论合约的变量名称，而是这些名称指向的实际 storage slot。</strong>从这个例子可以看出，一个简单的错误可能导致攻击者劫持整个合约及其以太币。</p>
<h3 id="预防技术-3"><a href="#预防技术-3" class="headerlink" title="预防技术"></a>预防技术</h3><p>Solidity 为实现库合约提供了 <code>library</code> 关键字（有关详细信息，请参阅<a target="_blank" rel="noopener" href="https://docs.soliditylang.org/en/latest/contracts.html?highlight=library#libraries">文档</a>）。<strong>这确保了库合约是无状态且不可自毁的。强制库无状态可以减轻本节中展示的存储上下文的复杂性。无状态库还可以防止攻击者直接修改库的状态以影响依赖于库代码的合约。</strong>作为一般经验法则，在使用 <code>DELEGATECALL</code> 时，<strong>请仔细注意库合约和调用合约的可能的调用上下文，并尽可能构建无状态库。</strong></p>
<h3 id="真实世界的例子：Parity-Multisig-Wallet-Second-Hack"><a href="#真实世界的例子：Parity-Multisig-Wallet-Second-Hack" class="headerlink" title="真实世界的例子：Parity Multisig Wallet (Second Hack)"></a>真实世界的例子：Parity Multisig Wallet (Second Hack)</h3><p>Second Parity Multisig Wallet hack 是一个例子，来说明如果在其预期上下文之外运行编写良好的库代码可以被利用。对于这种攻击有很多很好的解释，例如“<a target="_blank" rel="noopener" href="https://medium.com/chain-cloud-company-blog/parity-multisig-hack-again-b46771eaa838">Parity Multisig Hacked. Again</a>”和“<a target="_blank" rel="noopener" href="https://hackingdistributed.com/2017/07/22/deep-dive-parity-bug/">深入了解 Parity Multisig Bug</a>”。</p>
<p>为了增加这些参考资料，让我们探索被利用的合约。库和钱包合约可以在 <a target="_blank" rel="noopener" href="https://github.com/openethereum/parity-ethereum/blob/b640df8fbb964da7538eef268dffc125b081a82f/js/src/contracts/snippets/enhanced-wallet.sol">GitHub</a>(Parity已被弃用) 上找到。</p>
<p>库合约如下：</p>
<figure><div class="code-wrapper"><pre class="line-numbers language-solidity" data-language="solidity"><code class="language-solidity"><span class="token keyword">contract</span> <span class="token class-name">WalletLibrary</span> <span class="token keyword">is</span> WalletEvents <span class="token punctuation">&#123;</span>

  <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>

  <span class="token comment">// throw unless the contract is not yet initialized.</span>
  <span class="token keyword">modifier</span> only_uninitialized <span class="token punctuation">&#123;</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>m_numOwners <span class="token operator">></span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token keyword">throw</span><span class="token punctuation">;</span> <span class="token keyword">_</span><span class="token punctuation">;</span> <span class="token punctuation">&#125;</span>

  <span class="token comment">// constructor - just pass on the owner array to multiowned and</span>
  <span class="token comment">// the limit to daylimit</span>
  <span class="token keyword">function</span> <span class="token function">initWallet</span><span class="token punctuation">(</span><span class="token builtin">address</span><span class="token punctuation">[</span><span class="token punctuation">]</span> _owners<span class="token punctuation">,</span> <span class="token builtin">uint</span> _required<span class="token punctuation">,</span> <span class="token builtin">uint</span> _daylimit<span class="token punctuation">)</span>
      only_uninitialized <span class="token punctuation">&#123;</span>
    <span class="token function">initDaylimit</span><span class="token punctuation">(</span>_daylimit<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">initMultiowned</span><span class="token punctuation">(</span>_owners<span class="token punctuation">,</span> _required<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">&#125;</span>

  <span class="token comment">// kills the contract sending everything to `_to`.</span>
  <span class="token keyword">function</span> <span class="token function">kill</span><span class="token punctuation">(</span><span class="token builtin">address</span> _to<span class="token punctuation">)</span> <span class="token function">onlymanyowners</span><span class="token punctuation">(</span><span class="token function">sha3</span><span class="token punctuation">(</span>msg<span class="token punctuation">.</span>data<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token keyword">external</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">suicide</span><span class="token punctuation">(</span>_to<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">&#125;</span>

  <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>

<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></div></figure>

<p>钱包合约：</p>
<figure><div class="code-wrapper"><pre class="line-numbers language-solidity" data-language="solidity"><code class="language-solidity"><span class="token keyword">contract</span> <span class="token class-name">Wallet</span> <span class="token keyword">is</span> WalletEvents <span class="token punctuation">&#123;</span>

  <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>

  <span class="token comment">// METHODS</span>

  <span class="token comment">// gets called when no other function matches</span>
  <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">payable</span> <span class="token punctuation">&#123;</span>
    <span class="token comment">// just being sent some cash?</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>msg<span class="token punctuation">.</span>value <span class="token operator">></span> <span class="token number">0</span><span class="token punctuation">)</span>
      <span class="token function">Deposit</span><span class="token punctuation">(</span>msg<span class="token punctuation">.</span>sender<span class="token punctuation">,</span> msg<span class="token punctuation">.</span>value<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>msg<span class="token punctuation">.</span>data<span class="token punctuation">.</span>length <span class="token operator">></span> <span class="token number">0</span><span class="token punctuation">)</span>
      _walletLibrary<span class="token punctuation">.</span><span class="token function">delegatecall</span><span class="token punctuation">(</span>msg<span class="token punctuation">.</span>data<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">&#125;</span>

  <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>

  <span class="token comment">// FIELDS</span>
  <span class="token builtin">address</span> <span class="token keyword">constant</span> _walletLibrary <span class="token operator">=</span>
    <span class="token number">0xcafecafecafecafecafecafecafecafecafecafe</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></div></figure>

<p>请注意，<code>Wallet</code> 合约本质上是通过 delegate call 将所有调用传递给 <code>WalletLibrary</code> 合约。此代码片段中的常量 <code>_walletLibrary</code> 地址充当实际部署的 <code>WalletLibrary</code> 合约的占位符（位于 <code>0x863DF6BFa4469f3ead0bE8f9F2AAE51c91A907b4</code>）。</p>
<p>这些合约的预期操作是拥有一个简单的低成本可部署钱包合约，其代码库和主要功能都在 <code>WalletLibrary</code> 合约中。不幸的是，<code>WalletLibrary</code> 合约本身就是一个合约，并保持着自己的状态。你能明白为什么这可能是一个问题吗？</p>
<p>可以向 <code>WalletLibrary</code> 合约本身发送调用。具体来说，<code>WalletLibrary</code> 合约可以被初始化并被拥有。事实上，用户就是这样做的，调用 <code>WalletLibrary</code> 合约上的 <code>initWallet</code> 函数并成为库合约的所有者。同一用户随后调用了 <code>kill</code> 函数。因为用户是库合约的所有者，所以 modifier 通过并且库合约自毁。由于现有的所有 <code>Wallet</code> 合约都引用此库合约并且不包含更改此引用的方法，因此它们的所有功能，包括提取以太币的能力，都与 <code>WalletLibrary</code> 合约一起丢失。结果，所有此类 Parity 多重签名钱包中的所有以太币立即丢失或永久无法恢复。</p>
<h2 id="默认可见性-Default-Visibilities"><a href="#默认可见性-Default-Visibilities" class="headerlink" title="默认可见性 (Default Visibilities)"></a>默认可见性 (Default Visibilities)</h2><p>Solidity 中的函数具有可见性说明符，指示如何调用它们。可见性决定了一个函数是否可以被用户、其他派生合约、仅在内部或仅在外部调用。有四个可见性说明符，在 <a target="_blank" rel="noopener" href="https://docs.soliditylang.org/en/latest/contracts.html?highlight=library#visibility-and-getters">Solidity 文档</a> 中有详细描述。<strong>函数默认为 public，允许用户在外部调用它们。</strong>我们现在将看到不正确地使用可见性说明符如何导致智能合约中的一些破坏性漏洞。</p>
<h3 id="漏洞-4"><a href="#漏洞-4" class="headerlink" title="漏洞"></a>漏洞</h3><p>函数的默认可见性是 <code>public</code>，因此外部用户可以调用未指定其可见性的函数。当开发人员错误地在应该是私有的（或只能在合约本身内调用）的函数上忽略可见性说明符时，就会出现问题。</p>
<p>让我们快速探索一个简单的例子：</p>
<figure><div class="code-wrapper"><pre class="line-numbers language-solidity" data-language="solidity"><code class="language-solidity"><span class="token keyword">contract</span> <span class="token class-name">HashForEther</span> <span class="token punctuation">&#123;</span>

    <span class="token keyword">function</span> <span class="token function">withdrawWinnings</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token comment">// Winner if the last 8 hex characters of the address are 0</span>
        <span class="token keyword">require</span><span class="token punctuation">(</span><span class="token builtin">uint32</span><span class="token punctuation">(</span>msg<span class="token punctuation">.</span>sender<span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">_sendWinnings</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
     <span class="token punctuation">&#125;</span>

     <span class="token keyword">function</span> <span class="token function">_sendWinnings</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
         msg<span class="token punctuation">.</span>sender<span class="token punctuation">.</span><span class="token function">transfer</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>balance<span class="token punctuation">)</span><span class="token punctuation">;</span>
     <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></div></figure>

<p>这个简单的合约旨在充当地址猜测赏金游戏。为了赢得合约的余额，用户必须生成一个最后 8 个十六进制字符为 0 的以太坊地址。一旦实现，他们可以调用<code>withdrawWinnings</code> 函数来获得他们的赏金。</p>
<p>不幸的是，尚未指定功能的可见性。特别是 <code>_sendWinnings</code> 函数是 <code>public</code>（默认），因此任何地址都可以调用此函数来窃取赏金。</p>
<h3 id="预防技术-4"><a href="#预防技术-4" class="headerlink" title="预防技术"></a>预防技术</h3><p><strong>始终指定合同中所有功能的可见性是一种很好的做法</strong>，即使它们是 <code>public</code>。最近版本的 solc 对没有明确可见性设置的函数显示警告，以鼓励这种做法。</p>
<p>注：当前版本的 Solidity 对没有指定可见性修饰符的函数显示 SyntaxError 错误。</p>
<h3 id="真实世界的例子：Parity-Multisig-Wallet-First-Hack"><a href="#真实世界的例子：Parity-Multisig-Wallet-First-Hack" class="headerlink" title="真实世界的例子：Parity Multisig Wallet (First Hack)"></a>真实世界的例子：Parity Multisig Wallet (First Hack)</h3><p>在第一次 Parity 多重签名攻击中，价值约 3100 万美元的以太币被盗，大部分来自三个钱包。 Haseeb Qureshi(<a target="_blank" rel="noopener" href="https://www.freecodecamp.org/news/a-hacker-stole-31m-of-ether-how-it-happened-and-what-it-means-for-ethereum-9e5dc29e33ce">A hacker stole $31M of Ether — how it happened, and what it means for Ethereum</a>) 很好地回顾了这是如何完成的。</p>
<p>本质上，多重签名钱包是由基本的 <code>Wallet</code> 合约构成的，该合约调用包含核心功能的库合约（如 真实世界的例子：Parity Multisig Wallet (Second Hack) 中所述）。库合约包含初始化钱包的代码，从以下代码片段可以看出：</p>
<figure><div class="code-wrapper"><pre class="line-numbers language-solidity" data-language="solidity"><code class="language-solidity"><span class="token keyword">contract</span> <span class="token class-name">WalletLibrary</span> <span class="token keyword">is</span> WalletEvents <span class="token punctuation">&#123;</span>

  <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>

  <span class="token comment">// METHODS</span>

  <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>

  <span class="token comment">// constructor is given number of sigs required to do protected</span>
  <span class="token comment">// "onlymanyowners" transactions as well as the selection of addresses</span>
  <span class="token comment">// capable of confirming them</span>
  <span class="token keyword">function</span> <span class="token function">initMultiowned</span><span class="token punctuation">(</span><span class="token builtin">address</span><span class="token punctuation">[</span><span class="token punctuation">]</span> _owners<span class="token punctuation">,</span> <span class="token builtin">uint</span> _required<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    m_numOwners <span class="token operator">=</span> _owners<span class="token punctuation">.</span>length <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">;</span>
    m_owners<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token builtin">uint</span><span class="token punctuation">(</span>msg<span class="token punctuation">.</span>sender<span class="token punctuation">)</span><span class="token punctuation">;</span>
    m_ownerIndex<span class="token punctuation">[</span><span class="token builtin">uint</span><span class="token punctuation">(</span>msg<span class="token punctuation">.</span>sender<span class="token punctuation">)</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token builtin">uint</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> _owners<span class="token punctuation">.</span>length<span class="token punctuation">;</span> <span class="token operator">++</span>i<span class="token punctuation">)</span>
    <span class="token punctuation">&#123;</span>
      m_owners<span class="token punctuation">[</span><span class="token number">2</span> <span class="token operator">+</span> i<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token builtin">uint</span><span class="token punctuation">(</span>_owners<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      m_ownerIndex<span class="token punctuation">[</span><span class="token builtin">uint</span><span class="token punctuation">(</span>_owners<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token number">2</span> <span class="token operator">+</span> i<span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
    m_required <span class="token operator">=</span> _required<span class="token punctuation">;</span>
  <span class="token punctuation">&#125;</span>

  <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>

  <span class="token comment">// constructor - just pass on the owner array to multiowned and</span>
  <span class="token comment">// the limit to daylimit</span>
  <span class="token keyword">function</span> <span class="token function">initWallet</span><span class="token punctuation">(</span><span class="token builtin">address</span><span class="token punctuation">[</span><span class="token punctuation">]</span> _owners<span class="token punctuation">,</span> <span class="token builtin">uint</span> _required<span class="token punctuation">,</span> <span class="token builtin">uint</span> _daylimit<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token function">initDaylimit</span><span class="token punctuation">(</span>_daylimit<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">initMultiowned</span><span class="token punctuation">(</span>_owners<span class="token punctuation">,</span> _required<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></div></figure>

<p>请注意，这两个函数都没有指定它们的可见性，因此它们都默认为 <code>public</code>。 <code>initWallet</code> 函数在钱包的构造函数中调用，并设置多重签名钱包的所有者，如 <code>initMultiowned</code> 函数所示。由于这些函数意外地被公开，攻击者能够在部署的合约上调用这些函数，将所有权重置为攻击者的地址。作为所有者，攻击者随后耗尽了所有以太币的钱包。</p>
<h2 id="熵错觉-Entropy-Illusion"><a href="#熵错觉-Entropy-Illusion" class="headerlink" title="熵错觉 (Entropy Illusion)"></a>熵错觉 (Entropy Illusion)</h2><p><strong>以太坊区块链上的所有交易都是确定性的状态转换操作。这意味着每笔交易都以可计算的方式修改以太坊生态系统的全局状态，没有不确定性。</strong>这具有基本含义，即以太坊中没有熵或随机性的来源。实现去中心化熵（随机性）是一个众所周知的问题，已经提出了许多解决方案，包括 <a target="_blank" rel="noopener" href="https://github.com/randao/randao">RANDAO</a> 或使用哈希链，正如 Vitalik Buterin 在博客文章“Validator Ordering and Randomness in PoS”中所描述的那样。</p>
<h3 id="漏洞-5"><a href="#漏洞-5" class="headerlink" title="漏洞"></a>漏洞</h3><p>在以太坊平台上建立的一些第一批合约是基于赌博的。从根本上说，赌博需要不确定性（赌注），这使得在区块链（确定性系统）上构建赌博系统相当困难。很明显，不确定性必须来自区块链外部的来源。这对于玩家之间的赌注是可能的（例如<a target="_blank" rel="noopener" href="https://ethereum.stackexchange.com/questions/191/how-can-i-securely-generate-a-random-number-in-my-smart-contract">commit–reveal 技术</a>）；但是，如果您想实现一个合约来充当“the house”（如二十一点或轮盘赌），则要困难得多。一个常见的陷阱是使用未来区块变量 —— 即包含有关交易区块的信息的变量，其值尚不清楚，例如哈希、时间戳、区块编号或gas限制。这些问题是它们由开采区块的矿工控制，因此并不是真正随机的。例如，考虑一个轮盘赌智能合约，如果下一个块哈希以偶数结尾，则返回一个黑色数字的逻辑。一个矿工（或矿工池）可以在黑色上下注 100 万美元。如果他们解决下一个块并发现哈希以奇数结尾，他们可以很高兴地不发布他们的块并挖掘另一个块，直到他们找到块哈希为偶数的解决方案（假设块奖励和费用小于100 万美元）。正如 Martin Swende 在他出色的<a target="_blank" rel="noopener" href="http://martin.swende.se/blog/Breaking_the_house.html">博客文章</a>中所展示的那样，使用过去或现在的变量可能更具破坏性。此外，单独使用区块变量意味着一个区块中所有交易的伪随机数都是相同的，因此攻击者可以通过在一个区块内进行许多交易来倍增他们的胜利（应该有一个最大赌注）。</p>
<h3 id="预防技术-5"><a href="#预防技术-5" class="headerlink" title="预防技术"></a>预防技术</h3><p><strong>熵（随机性）的来源必须在区块链之外。</strong>这可以在具有诸如 <a target="_blank" rel="noopener" href="https://ethereum.stackexchange.com/questions/191/how-can-i-securely-generate-a-random-number-in-my-smart-contract">commit–reveal 技术</a> 等系统的对等点之间完成，或者通过将信任模型更改为一组参与者（如在 <a target="_blank" rel="noopener" href="https://github.com/randao/randao">RANDAO</a> 中）。这也可以通过充当随机预言机的中心化实体来完成。块变量（通常有一些例外）不应该用于获取熵，因为它们可以被矿工操纵。</p>
<h3 id="现实世界的例子：PRNG-合约"><a href="#现实世界的例子：PRNG-合约" class="headerlink" title="现实世界的例子：PRNG 合约"></a>现实世界的例子：PRNG 合约</h3><p>2018 年 2 月，Arseny Reutov 在博客(<a target="_blank" rel="noopener" href="https://blog.positive.com/predicting-random-numbers-in-ethereum-smart-contracts-e5358c6b8620">Predicting Random Numbers in Ethereum Smart Contracts</a>)中介绍了他对使用某种伪随机数生成器 (PRNG) 的 3,649 个实时智能合约的分析；他发现了 43 份可以利用的合约。</p>
<h2 id="外部合约引用-External-Contract-Referencing"><a href="#外部合约引用-External-Contract-Referencing" class="headerlink" title="外部合约引用 (External Contract Referencing)"></a>外部合约引用 (External Contract Referencing)</h2><p>以太坊“世界计算机”的好处之一是能够重用代码并与已经部署在网络上的合约进行交互。因此，<strong>大量合约引用外部合约，通常是通过外部消息调用。这些外部消息调用可以以一些不明显的方式掩盖恶意行为者的意图</strong>，我们现在将对其进行检查。</p>
<h3 id="漏洞-6"><a href="#漏洞-6" class="headerlink" title="漏洞"></a>漏洞</h3><p>在 Solidity 中，任何地址都可以转换为合约，无论该地址处的代码是否代表正在转换的合约类型。这可能会导致问题，尤其是当合约的作者试图隐藏恶意代码时。让我们用一个例子来说明这一点。</p>
<p>考虑一段像 Rot13Encryption.sol 这样的代码，它初步实现了 <a target="_blank" rel="noopener" href="https://en.wikipedia.org/wiki/ROT13">ROT13 密码</a>。</p>
<p>示例8. Rot13Encryption.sol</p>
<figure><div class="code-wrapper"><pre class="line-numbers language-solidity" data-language="solidity"><code class="language-solidity"><span class="token comment">// encryption contract</span>
<span class="token keyword">contract</span> <span class="token class-name">Rot13Encryption</span> <span class="token punctuation">&#123;</span>

   <span class="token keyword">event</span> <span class="token function">Result</span><span class="token punctuation">(</span><span class="token builtin">string</span> convertedString<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// rot13-encrypt a string</span>
    <span class="token keyword">function</span> rot13Encrypt <span class="token punctuation">(</span><span class="token builtin">string</span> text<span class="token punctuation">)</span> <span class="token keyword">public</span> <span class="token punctuation">&#123;</span>
        <span class="token builtin">uint256</span> length <span class="token operator">=</span> <span class="token builtin">bytes</span><span class="token punctuation">(</span>text<span class="token punctuation">)</span><span class="token punctuation">.</span>length<span class="token punctuation">;</span>
        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">var</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> length<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
            <span class="token builtin">byte</span> char <span class="token operator">=</span> <span class="token builtin">bytes</span><span class="token punctuation">(</span>text<span class="token punctuation">)</span><span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">;</span>
            <span class="token comment">// inline assembly to modify the string</span>
            <span class="token keyword">assembly</span> <span class="token punctuation">&#123;</span>
                <span class="token comment">// get the first byte</span>
                char <span class="token operator">:=</span> <span class="token builtin">byte</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span>char<span class="token punctuation">)</span>
                <span class="token comment">// if the character is in [n,z], i.e. wrapping</span>
                <span class="token keyword">if</span> <span class="token function">and</span><span class="token punctuation">(</span><span class="token function">gt</span><span class="token punctuation">(</span>char<span class="token punctuation">,</span><span class="token number">0x6D</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token function">lt</span><span class="token punctuation">(</span>char<span class="token punctuation">,</span><span class="token number">0x7B</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
                <span class="token comment">// subtract from the ASCII number 'a',</span>
                <span class="token comment">// the difference between character &lt;char> and 'z'</span>
                <span class="token punctuation">&#123;</span> char<span class="token operator">:=</span> <span class="token function">sub</span><span class="token punctuation">(</span><span class="token number">0x60</span><span class="token punctuation">,</span> <span class="token function">sub</span><span class="token punctuation">(</span><span class="token number">0x7A</span><span class="token punctuation">,</span>char<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#125;</span>
                <span class="token keyword">if</span> <span class="token function">iszero</span><span class="token punctuation">(</span><span class="token function">eq</span><span class="token punctuation">(</span>char<span class="token punctuation">,</span> <span class="token number">0x20</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token comment">// ignore spaces</span>
                <span class="token comment">// add 13 to char</span>
                <span class="token punctuation">&#123;</span><span class="token function">mstore8</span><span class="token punctuation">(</span><span class="token function">add</span><span class="token punctuation">(</span><span class="token function">add</span><span class="token punctuation">(</span>text<span class="token punctuation">,</span><span class="token number">0x20</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token function">mul</span><span class="token punctuation">(</span>i<span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token function">add</span><span class="token punctuation">(</span>char<span class="token punctuation">,</span><span class="token number">13</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">&#125;</span>
            <span class="token punctuation">&#125;</span>
        <span class="token punctuation">&#125;</span>
        <span class="token keyword">emit</span> <span class="token function">Result</span><span class="token punctuation">(</span>text<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>

    <span class="token comment">// rot13-decrypt a string</span>
    <span class="token keyword">function</span> rot13Decrypt <span class="token punctuation">(</span><span class="token builtin">string</span> text<span class="token punctuation">)</span> <span class="token keyword">public</span> <span class="token punctuation">&#123;</span>
        <span class="token builtin">uint256</span> length <span class="token operator">=</span> <span class="token builtin">bytes</span><span class="token punctuation">(</span>text<span class="token punctuation">)</span><span class="token punctuation">.</span>length<span class="token punctuation">;</span>
        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">var</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> length<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
            <span class="token builtin">byte</span> char <span class="token operator">=</span> <span class="token builtin">bytes</span><span class="token punctuation">(</span>text<span class="token punctuation">)</span><span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">;</span>
            <span class="token keyword">assembly</span> <span class="token punctuation">&#123;</span>
                char <span class="token operator">:=</span> <span class="token builtin">byte</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span>char<span class="token punctuation">)</span>
                <span class="token keyword">if</span> <span class="token function">and</span><span class="token punctuation">(</span><span class="token function">gt</span><span class="token punctuation">(</span>char<span class="token punctuation">,</span><span class="token number">0x60</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token function">lt</span><span class="token punctuation">(</span>char<span class="token punctuation">,</span><span class="token number">0x6E</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
                <span class="token punctuation">&#123;</span> char<span class="token operator">:=</span> <span class="token function">add</span><span class="token punctuation">(</span><span class="token number">0x7B</span><span class="token punctuation">,</span> <span class="token function">sub</span><span class="token punctuation">(</span>char<span class="token punctuation">,</span><span class="token number">0x61</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#125;</span>
                <span class="token keyword">if</span> <span class="token function">iszero</span><span class="token punctuation">(</span><span class="token function">eq</span><span class="token punctuation">(</span>char<span class="token punctuation">,</span> <span class="token number">0x20</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
                <span class="token punctuation">&#123;</span><span class="token function">mstore8</span><span class="token punctuation">(</span><span class="token function">add</span><span class="token punctuation">(</span><span class="token function">add</span><span class="token punctuation">(</span>text<span class="token punctuation">,</span><span class="token number">0x20</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token function">mul</span><span class="token punctuation">(</span>i<span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token function">sub</span><span class="token punctuation">(</span>char<span class="token punctuation">,</span><span class="token number">13</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">&#125;</span>
            <span class="token punctuation">&#125;</span>
        <span class="token punctuation">&#125;</span>
        <span class="token keyword">emit</span> <span class="token function">Result</span><span class="token punctuation">(</span>text<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></div></figure>

<p>这段代码只接受一个字符串（字母 a-z，没有验证）并通过将每个字符向右移动 13 位（环绕 <code>z</code>）对其进行加密；即，<code>a</code> 转移到 <code>n</code> 和 <code>x</code> 转移到 <code>k</code>。不需要理解前面合约中的组件来理解正在讨论的问题，因此不熟悉组件的读者可以放心地忽略它。</p>
<p>现在考虑以下合约，它使用此代码进行加密：</p>
<figure><div class="code-wrapper"><pre class="line-numbers language-solidity" data-language="solidity"><code class="language-solidity"><span class="token keyword">import</span> <span class="token string">"Rot13Encryption.sol"</span><span class="token punctuation">;</span>

<span class="token comment">// encrypt your top-secret info</span>
<span class="token keyword">contract</span> <span class="token class-name">EncryptionContract</span> <span class="token punctuation">&#123;</span>
    <span class="token comment">// library for encryption</span>
    Rot13Encryption encryptionLibrary<span class="token punctuation">;</span>

    <span class="token comment">// constructor - initialize the library</span>
    <span class="token keyword">constructor</span><span class="token punctuation">(</span>Rot13Encryption _encryptionLibrary<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        encryptionLibrary <span class="token operator">=</span> _encryptionLibrary<span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>

    <span class="token keyword">function</span> <span class="token function">encryptPrivateData</span><span class="token punctuation">(</span><span class="token builtin">string</span> privateInfo<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token comment">// potentially do some operations here</span>
        encryptionLibrary<span class="token punctuation">.</span><span class="token function">rot13Encrypt</span><span class="token punctuation">(</span>privateInfo<span class="token punctuation">)</span><span class="token punctuation">;</span>
     <span class="token punctuation">&#125;</span>
 <span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></div></figure>

<p>该合约的问题是 <code>encryptionLibrary</code> 地址不是公开的或恒定的。因此，合约的部署者可以在构造函数中给出一个指向该合约的地址：</p>
<figure><div class="code-wrapper"><pre class="line-numbers language-solidity" data-language="solidity"><code class="language-solidity"><span class="token comment">// encryption contract</span>
<span class="token keyword">contract</span> <span class="token class-name">Rot26Encryption</span> <span class="token punctuation">&#123;</span>

   <span class="token keyword">event</span> <span class="token function">Result</span><span class="token punctuation">(</span><span class="token builtin">string</span> convertedString<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// rot13-encrypt a string</span>
    <span class="token keyword">function</span> rot13Encrypt <span class="token punctuation">(</span><span class="token builtin">string</span> text<span class="token punctuation">)</span> <span class="token keyword">public</span> <span class="token punctuation">&#123;</span>
        <span class="token builtin">uint256</span> length <span class="token operator">=</span> <span class="token builtin">bytes</span><span class="token punctuation">(</span>text<span class="token punctuation">)</span><span class="token punctuation">.</span>length<span class="token punctuation">;</span>
        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">var</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> length<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
            <span class="token builtin">byte</span> char <span class="token operator">=</span> <span class="token builtin">bytes</span><span class="token punctuation">(</span>text<span class="token punctuation">)</span><span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">;</span>
            <span class="token comment">// inline assembly to modify the string</span>
            <span class="token keyword">assembly</span> <span class="token punctuation">&#123;</span>
                <span class="token comment">// get the first byte</span>
                char <span class="token operator">:=</span> <span class="token builtin">byte</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span>char<span class="token punctuation">)</span>
                <span class="token comment">// if the character is in [n,z], i.e. wrapping</span>
                <span class="token keyword">if</span> <span class="token function">and</span><span class="token punctuation">(</span><span class="token function">gt</span><span class="token punctuation">(</span>char<span class="token punctuation">,</span><span class="token number">0x6D</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token function">lt</span><span class="token punctuation">(</span>char<span class="token punctuation">,</span><span class="token number">0x7B</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
                <span class="token comment">// subtract from the ASCII number 'a',</span>
                <span class="token comment">// the difference between character &lt;char> and 'z'</span>
                <span class="token punctuation">&#123;</span> char<span class="token operator">:=</span> <span class="token function">sub</span><span class="token punctuation">(</span><span class="token number">0x60</span><span class="token punctuation">,</span> <span class="token function">sub</span><span class="token punctuation">(</span><span class="token number">0x7A</span><span class="token punctuation">,</span>char<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#125;</span>
                <span class="token comment">// ignore spaces</span>
                <span class="token keyword">if</span> <span class="token function">iszero</span><span class="token punctuation">(</span><span class="token function">eq</span><span class="token punctuation">(</span>char<span class="token punctuation">,</span> <span class="token number">0x20</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
                <span class="token comment">// add 26 to char!</span>
                <span class="token punctuation">&#123;</span><span class="token function">mstore8</span><span class="token punctuation">(</span><span class="token function">add</span><span class="token punctuation">(</span><span class="token function">add</span><span class="token punctuation">(</span>text<span class="token punctuation">,</span><span class="token number">0x20</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token function">mul</span><span class="token punctuation">(</span>i<span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token function">add</span><span class="token punctuation">(</span>char<span class="token punctuation">,</span><span class="token number">26</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">&#125;</span>
            <span class="token punctuation">&#125;</span>
        <span class="token punctuation">&#125;</span>
        <span class="token keyword">emit</span> <span class="token function">Result</span><span class="token punctuation">(</span>text<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>

    <span class="token comment">// rot13-decrypt a string</span>
    <span class="token keyword">function</span> rot13Decrypt <span class="token punctuation">(</span><span class="token builtin">string</span> text<span class="token punctuation">)</span> <span class="token keyword">public</span> <span class="token punctuation">&#123;</span>
        <span class="token builtin">uint256</span> length <span class="token operator">=</span> <span class="token builtin">bytes</span><span class="token punctuation">(</span>text<span class="token punctuation">)</span><span class="token punctuation">.</span>length<span class="token punctuation">;</span>
        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">var</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> length<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
            <span class="token builtin">byte</span> char <span class="token operator">=</span> <span class="token builtin">bytes</span><span class="token punctuation">(</span>text<span class="token punctuation">)</span><span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">;</span>
            <span class="token keyword">assembly</span> <span class="token punctuation">&#123;</span>
                char <span class="token operator">:=</span> <span class="token builtin">byte</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span>char<span class="token punctuation">)</span>
                <span class="token keyword">if</span> <span class="token function">and</span><span class="token punctuation">(</span><span class="token function">gt</span><span class="token punctuation">(</span>char<span class="token punctuation">,</span><span class="token number">0x60</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token function">lt</span><span class="token punctuation">(</span>char<span class="token punctuation">,</span><span class="token number">0x6E</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
                <span class="token punctuation">&#123;</span> char<span class="token operator">:=</span> <span class="token function">add</span><span class="token punctuation">(</span><span class="token number">0x7B</span><span class="token punctuation">,</span> <span class="token function">sub</span><span class="token punctuation">(</span>char<span class="token punctuation">,</span><span class="token number">0x61</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#125;</span>
                <span class="token keyword">if</span> <span class="token function">iszero</span><span class="token punctuation">(</span><span class="token function">eq</span><span class="token punctuation">(</span>char<span class="token punctuation">,</span> <span class="token number">0x20</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
                <span class="token punctuation">&#123;</span><span class="token function">mstore8</span><span class="token punctuation">(</span><span class="token function">add</span><span class="token punctuation">(</span><span class="token function">add</span><span class="token punctuation">(</span>text<span class="token punctuation">,</span><span class="token number">0x20</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token function">mul</span><span class="token punctuation">(</span>i<span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token function">sub</span><span class="token punctuation">(</span>char<span class="token punctuation">,</span><span class="token number">26</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">&#125;</span>
            <span class="token punctuation">&#125;</span>
        <span class="token punctuation">&#125;</span>
        <span class="token keyword">emit</span> <span class="token function">Result</span><span class="token punctuation">(</span>text<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></div></figure>

<p>该合约实现了 ROT26 密码，它将每个字符移动 26 个位置（即，什么都不做）。同样，无需了解本合同中的组件。更简单地说，攻击者可以将以下合约链接到相同的效果：</p>
<figure><div class="code-wrapper"><pre class="line-numbers language-solidity" data-language="solidity"><code class="language-solidity"><span class="token keyword">contract</span> <span class="token class-name">Print</span><span class="token punctuation">&#123;</span>
    <span class="token keyword">event</span> <span class="token function">Print</span><span class="token punctuation">(</span><span class="token builtin">string</span> text<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">function</span> <span class="token function">rot13Encrypt</span><span class="token punctuation">(</span><span class="token builtin">string</span> text<span class="token punctuation">)</span> <span class="token keyword">public</span> <span class="token punctuation">&#123;</span>
        <span class="token keyword">emit</span> <span class="token function">Print</span><span class="token punctuation">(</span>text<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
 <span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></div></figure>

<p>如果在构造函数中给出了这些合约中的任何一个的地址，则 <code>encryptPrivateData</code> 函数将简单地生成一个打印未加密私有数据的事件。</p>
<p>尽管在此示例中，在构造函数中设置了类似库的合约，但通常情况下，特权用户（例如所有者）可以更改库合约地址。如果链接的合约不包含被调用的函数，则将执行回退函数。例如，使用行 <code>encryptionLibrary.rot13Encrypt()</code>，如果由 <code>encryptionLibrary</code> 指定的合约是：</p>
<figure><div class="code-wrapper"><pre class="line-numbers language-solidity" data-language="solidity"><code class="language-solidity"><span class="token keyword">contract</span> <span class="token class-name">Blank</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">event</span> <span class="token function">Print</span><span class="token punctuation">(</span><span class="token builtin">string</span> text<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token keyword">emit</span> <span class="token function">Print</span><span class="token punctuation">(</span><span class="token string">"Here"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// put malicious code here and it will run</span>
    <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></div></figure>

<p>然后将发出带有文本 <code>Here</code> 的事件。因此，如果用户可以更改合约库，他们原则上可以让其他用户在不知不觉中运行任意代码。</p>
<table>
<thead>
<tr>
<th>警告</th>
<th>此处表示的合约仅用于演示目的，并不代表适当的加密。它们不应该用于加密。</th>
</tr>
</thead>
</table>
<h3 id="预防技术-6"><a href="#预防技术-6" class="headerlink" title="预防技术"></a>预防技术</h3><p>如前所述，可以（在某些情况下）以恶意行为的方式部署安全合约。审计员可以公开验证合约并让其所有者以恶意方式部署它，从而导致公开审计的合约具有漏洞或恶意意图。</p>
<p>有许多技术可以防止这些情况。</p>
<p><strong>一种技术是使用 new 关键字来创建合同。</strong>在前面的例子中，构造函数可以写成：</p>
<figure><div class="code-wrapper"><pre class="line-numbers language-solidity" data-language="solidity"><code class="language-solidity"><span class="token keyword">constructor</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    encryptionLibrary <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Rot13Encryption</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre></div></figure>

<p>这样，在部署时会创建引用合约的实例，部署者无法在不更改的情况下替换 <code>Rot13Encryption</code> 合约。</p>
<p><strong>另一种解决方案是硬编码外部合约地址。</strong></p>
<p>一般来说，调用外部合约的代码应该总是被仔细审计。作为开发人员，在定义外部合约时，最好将合约地址公开（在下一节的 honey-pot 示例中不是这种情况），以便用户轻松检查合约引用的代码。相反，如果合约有一个私有变量合约地址，它可能是某人恶意行为的迹象（如现实世界示例所示）。如果用户可以更改用于调用外部函数的合约地址，那么（在分散的系统环境中）实施时间锁定和&#x2F;或投票机制以允许用户查看正在更改的代码可能很重要，或者让参与者有机会选择加入&#x2F;退出新的合约地址。</p>
<h3 id="现实世界的例子：Reentrancy-Honey-Pot"><a href="#现实世界的例子：Reentrancy-Honey-Pot" class="headerlink" title="现实世界的例子：Reentrancy Honey Pot"></a>现实世界的例子：Reentrancy Honey Pot</h3><p>最近在主网上发布了一些 honey pot。这些合约试图比试图利用这些合约的以太坊黑客更聪明，但他们最终会因他们期望利用的合约而失去以太币。一个示例通过在构造函数中用恶意合约替换预期合约来使用这种攻击。代码可以在<a target="_blank" rel="noopener" href="https://etherscan.io/address/0x95d34980095380851902ccd9a1fb4c813c2cb639">这里</a>找到：</p>
<figure><div class="code-wrapper"><pre class="line-numbers language-solidity" data-language="solidity"><code class="language-solidity"><span class="token keyword">pragma</span> <span class="token keyword">solidity</span> <span class="token operator">^</span><span class="token version number">0.4.19</span><span class="token punctuation">;</span>

<span class="token keyword">contract</span> <span class="token class-name">Private_Bank</span>
<span class="token punctuation">&#123;</span>
    <span class="token keyword">mapping</span> <span class="token punctuation">(</span><span class="token builtin">address</span> <span class="token operator">=></span> <span class="token builtin">uint</span><span class="token punctuation">)</span> <span class="token keyword">public</span> balances<span class="token punctuation">;</span>
    <span class="token builtin">uint</span> <span class="token keyword">public</span> MinDeposit <span class="token operator">=</span> <span class="token number">1</span> ether<span class="token punctuation">;</span>
    Log TransferLog<span class="token punctuation">;</span>

    <span class="token keyword">function</span> <span class="token function">Private_Bank</span><span class="token punctuation">(</span><span class="token builtin">address</span> _log<span class="token punctuation">)</span>
    <span class="token punctuation">&#123;</span>
        TransferLog <span class="token operator">=</span> <span class="token function">Log</span><span class="token punctuation">(</span>_log<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>

    <span class="token keyword">function</span> <span class="token function">Deposit</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token keyword">public</span>
    <span class="token keyword">payable</span>
    <span class="token punctuation">&#123;</span>
        <span class="token keyword">if</span><span class="token punctuation">(</span>msg<span class="token punctuation">.</span>value <span class="token operator">>=</span> MinDeposit<span class="token punctuation">)</span>
        <span class="token punctuation">&#123;</span>
            balances<span class="token punctuation">[</span>msg<span class="token punctuation">.</span>sender<span class="token punctuation">]</span><span class="token operator">+=</span>msg<span class="token punctuation">.</span>value<span class="token punctuation">;</span>
            TransferLog<span class="token punctuation">.</span><span class="token function">AddMessage</span><span class="token punctuation">(</span>msg<span class="token punctuation">.</span>sender<span class="token punctuation">,</span>msg<span class="token punctuation">.</span>value<span class="token punctuation">,</span><span class="token string">"Deposit"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span>
    <span class="token punctuation">&#125;</span>

    <span class="token keyword">function</span> <span class="token function">CashOut</span><span class="token punctuation">(</span><span class="token builtin">uint</span> _am<span class="token punctuation">)</span>
    <span class="token punctuation">&#123;</span>
        <span class="token keyword">if</span><span class="token punctuation">(</span>_am<span class="token operator">&lt;=</span>balances<span class="token punctuation">[</span>msg<span class="token punctuation">.</span>sender<span class="token punctuation">]</span><span class="token punctuation">)</span>
        <span class="token punctuation">&#123;</span>
            <span class="token keyword">if</span><span class="token punctuation">(</span>msg<span class="token punctuation">.</span>sender<span class="token punctuation">.</span>call<span class="token punctuation">.</span><span class="token function">value</span><span class="token punctuation">(</span>_am<span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
            <span class="token punctuation">&#123;</span>
                balances<span class="token punctuation">[</span>msg<span class="token punctuation">.</span>sender<span class="token punctuation">]</span><span class="token operator">-=</span>_am<span class="token punctuation">;</span>
                TransferLog<span class="token punctuation">.</span><span class="token function">AddMessage</span><span class="token punctuation">(</span>msg<span class="token punctuation">.</span>sender<span class="token punctuation">,</span>_am<span class="token punctuation">,</span><span class="token string">"CashOut"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">&#125;</span>
        <span class="token punctuation">&#125;</span>
    <span class="token punctuation">&#125;</span>

    <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">external</span> <span class="token keyword">payable</span><span class="token punctuation">&#123;</span><span class="token punctuation">&#125;</span>

<span class="token punctuation">&#125;</span>

<span class="token keyword">contract</span> <span class="token class-name">Log</span>
<span class="token punctuation">&#123;</span>
    <span class="token keyword">struct</span> <span class="token class-name">Message</span>
    <span class="token punctuation">&#123;</span>
        <span class="token builtin">address</span> Sender<span class="token punctuation">;</span>
        <span class="token builtin">string</span>  Data<span class="token punctuation">;</span>
        <span class="token builtin">uint</span> Val<span class="token punctuation">;</span>
        <span class="token builtin">uint</span>  Time<span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>

    Message<span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token keyword">public</span> History<span class="token punctuation">;</span>
    Message LastMsg<span class="token punctuation">;</span>

    <span class="token keyword">function</span> <span class="token function">AddMessage</span><span class="token punctuation">(</span><span class="token builtin">address</span> _adr<span class="token punctuation">,</span><span class="token builtin">uint</span> _val<span class="token punctuation">,</span><span class="token builtin">string</span> _data<span class="token punctuation">)</span>
    <span class="token keyword">public</span>
    <span class="token punctuation">&#123;</span>
        LastMsg<span class="token punctuation">.</span>Sender <span class="token operator">=</span> _adr<span class="token punctuation">;</span>
        LastMsg<span class="token punctuation">.</span>Time <span class="token operator">=</span> now<span class="token punctuation">;</span>
        LastMsg<span class="token punctuation">.</span>Val <span class="token operator">=</span> _val<span class="token punctuation">;</span>
        LastMsg<span class="token punctuation">.</span>Data <span class="token operator">=</span> _data<span class="token punctuation">;</span>
        History<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>LastMsg<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></div></figure>

<p>一位 reddit 用户的<a target="_blank" rel="noopener" href="https://www.reddit.com/r/ethdev/comments/7x5rwr/tricked_by_a_honeypot_contract_or_beaten_by/">这篇文章</a>解释了他们是如何通过试图利用他们预计会出现在合约中的可重入性错误来为该合约损失 1 个以太币的。</p>
<h2 id="短地址-x2F-参数攻击-Short-Address-x2F-Parameter-Attack"><a href="#短地址-x2F-参数攻击-Short-Address-x2F-Parameter-Attack" class="headerlink" title="短地址&#x2F;参数攻击 (Short Address&#x2F;Parameter Attack)"></a>短地址&#x2F;参数攻击 (Short Address&#x2F;Parameter Attack)</h2><p>这种攻击不是针对 Solidity 合约本身，而是针对可能与其交互的第三方应用程序。添加此部分是为了完整性，并让读者了解如何在合约中操纵参数。</p>
<p>如需进一步阅读，请参阅“<a target="_blank" rel="noopener" href="https://medium.com/huzzle/ico-smart-contract-vulnerability-short-address-attack-31ac9177eb6b">ICO 智能合约漏洞：短地址攻击</a>”或此 <a target="_blank" rel="noopener" href="https://www.reddit.com/r/ethereum/comments/6r9nhj/cant_understand_the_erc20_short_address_attack/">Reddit 帖子</a>。</p>
<h3 id="漏洞-7"><a href="#漏洞-7" class="headerlink" title="漏洞"></a>漏洞</h3><p>将参数传递给智能合约时，参数根据 <a target="_blank" rel="noopener" href="https://docs.soliditylang.org/en/latest/abi-spec.html">ABI 规范</a> 进行编码。可以发送比预期参数长度短的编码参数（例如，发送一个只有 38 个十六进制字符（19 个字节）而不是标准的 40 个十六进制字符（20 个字节）的地址）。在这种情况下，EVM 将在编码参数的末尾添加零以构成预期长度。</p>
<p>当第三方应用程序不验证输入时，这会成为一个问题。最明显的例子是当用户请求提款时不验证 ERC20 代币地址的交易所。这个例子在 Peter Vessenes 的文章“The ERC20 Short Address Attack Explained”中有更详细的介绍。</p>
<p>考虑标准 ERC20 transfer 函数接口，注意参数的顺序：</p>
<figure><div class="code-wrapper"><pre class="line-numbers language-solidity" data-language="solidity"><code class="language-solidity"><span class="token keyword">function</span> <span class="token function">transfer</span><span class="token punctuation">(</span><span class="token builtin">address</span> to<span class="token punctuation">,</span> <span class="token builtin">uint</span> tokens<span class="token punctuation">)</span> <span class="token keyword">public</span> <span class="token keyword">returns</span> <span class="token punctuation">(</span><span class="token builtin">bool</span> success<span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre></div></figure>

<p>现在考虑一个持有大量代币（比方说 <code>REP</code>）的交易所和一个希望提取其 100 个代币份额的用户。用户将提交他们的地址 <code>0xdeaddeaddeaddeaddeaddeaddeaddeaddeaddeaddead</code> 和代币数量 100。交易所将按照 <code>transfer</code> 函数指定的顺序对这些参数进行编码；也就是说，先 <code>address</code> 然后 <code>token</code>。编码结果将是：</p>
<figure><div class="code-wrapper"><pre class="line-numbers language-markdown" data-language="markdown"><code class="language-markdown">a9059cbb000000000000000000000000deaddeaddea \
ddeaddeaddeaddeaddeaddeaddead0000000000000
000000000000000000000000000000000056bc75e2d63100000<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre></div></figure>

<p>前 4 个字节（<code>a9059cbb</code>）是 <code>transfer</code> <a target="_blank" rel="noopener" href="https://docs.soliditylang.org/en/latest/abi-spec.html#function-selector">函数签名&#x2F;选择器</a>，接下来的 32 个字节是地址，最后 32 个字节代表 <code>uint256</code> token数。请注意，末尾的十六进制 <code>56bc75e2d63100000</code> 对应于 100 个代币（小数点后 18 位，由 <code>REP</code> 代币合约指定）。</p>
<p>现在让我们看看如果发送一个缺少 1 个字节（2 个十六进制数字）的地址会发生什么。具体来说，假设攻击者发送 <code>0xdeaddeaddeaddeaddeaddeaddeaddeaddeaddeadde</code> 作为地址（缺少最后两位数字）和相同的 100 个令牌以提取。如果交易所不验证此输入，它将被编码为：</p>
<figure><div class="code-wrapper"><pre class="line-numbers language-markdown" data-language="markdown"><code class="language-markdown">a9059cbb000000000000000000000000deaddeaddea \
ddeaddeaddeaddeaddeaddeadde00000000000000
00000000000000000000000000000000056bc75e2d6310000000<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre></div></figure>

<p>差异是微妙的。请注意，<code>00</code> 已添加到编码的末尾，以弥补发送的短地址。当它被发送到智能合约时，地址参数将被读取为 <code>0xdeaddeaddeaddeaddeaddeaddeaddeaddeadde00</code> 并且值将被读取为 <code>56bc75e2d6310000000</code>（注意两个额外的 0）。该值现在是 <code>25600</code> 个令牌（该值已乘以 <code>256</code>）。在这个例子中，如果交易所持有这么多代币，用户将提取 <code>25600</code> 个代币（而交易所认为用户只提取了 <code>100</code> 个）到修改后的地址。显然，在这个例子中，攻击者不会拥有修改后的地址，但是如果攻击者要生成任何以 0 结尾的地址（这很容易被暴力破解）并使用这个生成的地址，他们就可以从毫无戒心的交易所窃取代币.</p>
<h3 id="预防技术-7"><a href="#预防技术-7" class="headerlink" title="预防技术"></a>预防技术</h3><p><strong>外部应用程序中的所有输入参数都应在发送到区块链之前进行验证。</strong>还应注意，<strong>参数排序在这里起着重要作用。</strong>由于填充只发生在最后，智能合约中参数的仔细排序可以减轻这种攻击的某些形式。</p>
<h2 id="未检查的-CALL-返回值-Unchecked-CALL-Return-Values"><a href="#未检查的-CALL-返回值-Unchecked-CALL-Return-Values" class="headerlink" title="未检查的 CALL 返回值 (Unchecked CALL Return Values)"></a>未检查的 CALL 返回值 (Unchecked CALL Return Values)</h2><p>在 Solidity 中有多种执行外部调用的方法。向外部账户发送以太币通常是通过转账方式进行的。但是，也可以使用 <code>send</code> 函数，对于更通用的外部调用，可以在 Solidity 中直接使用 <code>CALL</code> 操作码。 <code>call</code> 和 <code>send</code> 函数返回一个布尔值，指示调用是成功还是失败。因此，这些函数有一个简单的警告(caveat)，如果外部调用（由 <code>call</code> 或 <code>send</code> 初始化）失败，执行这些函数的交易将不会 revert；相反，这些函数只会返回 <code>false</code>。一个常见的错误是开发人员希望(expect)在外部调用失败时发生revert，并且没有检查返回值。</p>
<p>如需进一步阅读，请参阅 <a target="_blank" rel="noopener" href="https://www.dasp.co/#item-4">DASP - TOP 10</a> 和 <a target="_blank" rel="noopener" href="https://hackingdistributed.com/2016/06/16/scanning-live-ethereum-contracts-for-bugs/">“Scanning Live Ethereum Contracts for the ‘Unchecked-Send’ Bug”</a>。</p>
<h3 id="漏洞-8"><a href="#漏洞-8" class="headerlink" title="漏洞"></a>漏洞</h3><p>考虑以下示例：</p>
<figure><div class="code-wrapper"><pre class="line-numbers language-solidity" data-language="solidity"><code class="language-solidity"><span class="token keyword">contract</span> <span class="token class-name">Lotto</span> <span class="token punctuation">&#123;</span>

    <span class="token builtin">bool</span> <span class="token keyword">public</span> payedOut <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
    <span class="token builtin">address</span> <span class="token keyword">public</span> winner<span class="token punctuation">;</span>
    <span class="token builtin">uint</span> <span class="token keyword">public</span> winAmount<span class="token punctuation">;</span>

    <span class="token comment">// ... extra functionality here</span>

    <span class="token keyword">function</span> <span class="token function">sendToWinner</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">public</span> <span class="token punctuation">&#123;</span>
        <span class="token keyword">require</span><span class="token punctuation">(</span><span class="token operator">!</span>payedOut<span class="token punctuation">)</span><span class="token punctuation">;</span>
        winner<span class="token punctuation">.</span><span class="token function">send</span><span class="token punctuation">(</span>winAmount<span class="token punctuation">)</span><span class="token punctuation">;</span>
        payedOut <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>

    <span class="token keyword">function</span> <span class="token function">withdrawLeftOver</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">public</span> <span class="token punctuation">&#123;</span>
        <span class="token keyword">require</span><span class="token punctuation">(</span>payedOut<span class="token punctuation">)</span><span class="token punctuation">;</span>
        msg<span class="token punctuation">.</span>sender<span class="token punctuation">.</span><span class="token function">send</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>balance<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></div></figure>

<p>这代表了一个类似于 Lotto 的合约，<code>winner</code> 将获得 <code>winAmount</code> 的以太币，这通常会留下一些剩余的以太币供任何人提取。</p>
<p>该漏洞存在于第 11 行，其中使用了 <code>send</code> 而没有检查响应。在这个简单的例子中，无论是否发送了以太币，交易失败的 <code>winner</code>（无论是因为耗尽了 gas 还是因为合约故意抛出了 fallback 函数）都允许将 <code>payedOut</code> 设置为 <code>true</code>。在这种情况下，任何人都可以通过 <code>withdrawLeftOver</code>  函数提取获胜者的奖金。</p>
<h3 id="预防技术-8"><a href="#预防技术-8" class="headerlink" title="预防技术"></a>预防技术</h3><p>尽可能使用 <code>transfer</code> 函数而不是 <code>send</code>，因为如果外部交易 revert，<code>transfer</code> 将会 revert。如果需要使用 <code>send</code>，请始终检查返回值。</p>
<p>更有力的<a target="_blank" rel="noopener" href="https://docs.soliditylang.org/en/latest/common-patterns.html#withdrawal-from-contracts">建议</a>是采用 <em>withdrawal pattern</em>。在这个解决方案中，每个用户都必须调用一个独立的 withdraw 函数来处理从合约中发送以太币并处理发送交易失败的后果。这个想法是在逻辑上将外部发送功能与代码库的其余部分隔离开来，并将可能失败的交易的负担放在调用 withdraw 函数的最终的用户身上。</p>
<h3 id="现实世界的例子：Etherpot-and-King-of-Ether"><a href="#现实世界的例子：Etherpot-and-King-of-Ether" class="headerlink" title="现实世界的例子：Etherpot and King of Ether"></a>现实世界的例子：Etherpot and King of Ether</h3><p><a target="_blank" rel="noopener" href="https://github.com/etherpot/contract/blob/master/app/contracts/lotto.sol">Etherpot</a> 是一种智能合约彩票，与前面提到的示例合约没有太大区别。该合约的失败主要是由于不正确使用区块哈希（只有最后 256 个区块哈希可用；请参阅 Aakil Fernandes 的帖子，了解 Etherpot 如何未能正确考虑这一点）。但是，该合约也遭受了未经检查的看涨期权价值。考虑 lotto.sol: Code snippet 中的函数 <code>cash</code>：代码片段。</p>
<p>示例9. lotto.sol: Code snippet</p>
<figure><div class="code-wrapper"><pre class="line-numbers language-solidity" data-language="solidity"><code class="language-solidity"><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
  <span class="token keyword">function</span> <span class="token function">cash</span><span class="token punctuation">(</span><span class="token builtin">uint</span> roundIndex<span class="token punctuation">,</span> <span class="token builtin">uint</span> subpotIndex<span class="token punctuation">)</span><span class="token punctuation">&#123;</span>

        <span class="token keyword">var</span> subpotsCount <span class="token operator">=</span> <span class="token function">getSubpotsCount</span><span class="token punctuation">(</span>roundIndex<span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token keyword">if</span><span class="token punctuation">(</span>subpotIndex<span class="token operator">>=</span>subpotsCount<span class="token punctuation">)</span>
            <span class="token keyword">return</span><span class="token punctuation">;</span>

        <span class="token keyword">var</span> decisionBlockNumber <span class="token operator">=</span> <span class="token function">getDecisionBlockNumber</span><span class="token punctuation">(</span>roundIndex<span class="token punctuation">,</span>subpotIndex<span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token keyword">if</span><span class="token punctuation">(</span>decisionBlockNumber<span class="token operator">></span>block<span class="token punctuation">.</span>number<span class="token punctuation">)</span>
            <span class="token keyword">return</span><span class="token punctuation">;</span>

        <span class="token keyword">if</span><span class="token punctuation">(</span>rounds<span class="token punctuation">[</span>roundIndex<span class="token punctuation">]</span><span class="token punctuation">.</span>isCashed<span class="token punctuation">[</span>subpotIndex<span class="token punctuation">]</span><span class="token punctuation">)</span>
            <span class="token keyword">return</span><span class="token punctuation">;</span>
        <span class="token comment">//Subpots can only be cashed once. This is to prevent double payouts</span>

        <span class="token keyword">var</span> winner <span class="token operator">=</span> <span class="token function">calculateWinner</span><span class="token punctuation">(</span>roundIndex<span class="token punctuation">,</span>subpotIndex<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">var</span> subpot <span class="token operator">=</span> <span class="token function">getSubpot</span><span class="token punctuation">(</span>roundIndex<span class="token punctuation">)</span><span class="token punctuation">;</span>

        winner<span class="token punctuation">.</span><span class="token function">send</span><span class="token punctuation">(</span>subpot<span class="token punctuation">)</span><span class="token punctuation">;</span>

        rounds<span class="token punctuation">[</span>roundIndex<span class="token punctuation">]</span><span class="token punctuation">.</span>isCashed<span class="token punctuation">[</span>subpotIndex<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
        <span class="token comment">//Mark the round as cashed</span>
<span class="token punctuation">&#125;</span>
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></div></figure>

<p>请注意，在第 21 行，<code>send</code> 函数的返回值没有被检查，接下来的行设置了一个布尔值，表示获胜者已经收到了他们的资金。这个错误可能允许获胜者没有收到他们的以太币的状态，但合约的状态可以表明获胜者已经被支付。</p>
<p>此错误的更严重版本发生在 <a target="_blank" rel="noopener" href="https://www.kingoftheether.com/thrones/kingoftheether/index.html">King of the Ether</a> 中。该合约的 <a target="_blank" rel="noopener" href="https://www.kingoftheether.com/postmortem.html">Post-Mortem Investigation</a> 详细说明了如何使用未经检查的失败发送来攻击合约。</p>
<h2 id="竞争条件-x2F-抢跑-Race-Conditions-x2F-Front-Running"><a href="#竞争条件-x2F-抢跑-Race-Conditions-x2F-Front-Running" class="headerlink" title="竞争条件&#x2F;抢跑 (Race Conditions&#x2F;Front Running)"></a>竞争条件&#x2F;抢跑 (Race Conditions&#x2F;Front Running)</h2><p>对其他合约的外部调用和底层区块链的多用户性质相结合，导致了各种潜在的 Solidity 陷阱，用户竞相(<em>race</em>)执行代码来获得意外状态(<em>unexpected states</em>)。重入（本章前面讨论过）就是这种竞争条件的一个例子。在本节中，我们将讨论以太坊区块链上可能发生的其他类型的竞争条件。关于这个主题有很多很好的帖子，包括 <a target="_blank" rel="noopener" href="https://github.com/ethereum/wiki/wiki/Safety#race-conditions">以太坊 Wiki</a> 上的“Race Conditions”、<a target="_blank" rel="noopener" href="https://www.dasp.co/#item-7">DASP - TOP 10</a> 以及 <a target="_blank" rel="noopener" href="https://consensys.github.io/smart-contract-best-practices/">Ethereum Smart Contract Best Practices</a>。</p>
<h3 id="漏洞-9"><a href="#漏洞-9" class="headerlink" title="漏洞"></a>漏洞</h3><p>与大多数区块链一样，以太坊节点汇集交易并将它们形成区块。只有当矿工解决了共识机制（目前是以太坊的 Ethash PoW）后，这些交易才被认为是有效的。解决区块的矿工还选择池中的哪些交易将包含在区块中，通常按每笔交易的 <code>gasPrice</code> 排序。这是一个潜在的攻击向量。攻击者可以查看交易池中可能包含问题解决方案的交易，并修改或撤销求解器的权限或更改对求解器不利的合约状态。然后，攻击者可以从该交易中获取数据并创建自己的具有更高 <code>gasPrice</code> 的交易，以便他们的交易包含在原始交易之前的块中。</p>
<p>让我们用一个简单的例子来看看它是如何工作的。考虑 FindThisHash.sol 中显示的合约。</p>
<p>示例10. FindThisHash.sol</p>
<figure><div class="code-wrapper"><pre class="line-numbers language-solidity" data-language="solidity"><code class="language-solidity"><span class="token keyword">contract</span> <span class="token class-name">FindThisHash</span> <span class="token punctuation">&#123;</span>
    <span class="token builtin">bytes32</span> <span class="token keyword">constant</span> <span class="token keyword">public</span> hash <span class="token operator">=</span>
      <span class="token number">0xb5b5b97fafd9855eec9b41f74dfb6c38f5951141f9a3ecd7f44d5479b630ee0a</span><span class="token punctuation">;</span>

    <span class="token keyword">constructor</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">external</span> <span class="token keyword">payable</span> <span class="token punctuation">&#123;</span><span class="token punctuation">&#125;</span> <span class="token comment">// load with ether</span>

    <span class="token keyword">function</span> <span class="token function">solve</span><span class="token punctuation">(</span><span class="token builtin">string</span> solution<span class="token punctuation">)</span> <span class="token keyword">public</span> <span class="token punctuation">&#123;</span>
        <span class="token comment">// If you can find the pre-image of the hash, receive 1000 ether</span>
        <span class="token keyword">require</span><span class="token punctuation">(</span>hash <span class="token operator">==</span> <span class="token function">sha3</span><span class="token punctuation">(</span>solution<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        msg<span class="token punctuation">.</span>sender<span class="token punctuation">.</span><span class="token function">transfer</span><span class="token punctuation">(</span><span class="token number">1000</span> ether<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></div></figure>

<p>假设该合约包含 1,000 个以太币。可以找到以下 SHA-3 哈希的原像的用户可以提交解决方案并取回 1,000 以太币：</p>
<figure><div class="code-wrapper"><pre class="line-numbers language-markdown" data-language="markdown"><code class="language-markdown">0xb5b5b97fafd9855eec9b41f74dfb6c38f5951141f9a3ecd7f44d5479b630ee0a<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre></div></figure>

<p>假设一位用户发现解决方案是 <code>Ethereum!</code> 他们用 <code>Ethereum!</code>  作为参数来调用 <code>solve</code>。不幸的是，攻击者已经足够聪明，可以监视任何提交解决方案的交易池。他们看到这个解决方案，检查它的有效性，然后提交一个比原始交易高得多的 <code>gasPrice</code> 的等价交易。由于 <code>gasPrice</code> 较高，解决区块的矿工可能会优先考虑攻击者，并在原始解决者之前挖掘他们的交易。攻击者将拿走 1,000 个以太币，而解决问题的用户将一无所获。请记住，在这种类型的“抢先运行(<em>front-running</em>)”漏洞中，矿工被独特地激励来自己运行攻击（或者可以被贿赂以高昂的费用运行这些攻击）。不应低估攻击者本身就是矿工的可能性。</p>
<h3 id="预防技术-9"><a href="#预防技术-9" class="headerlink" title="预防技术"></a>预防技术</h3><p>有两类参与者可以执行这些类型的抢先攻击：用户（修改其交易的 <code>gasPrice</code>）和矿工自己（他们可以按照他们认为合适的方式对区块中的交易进行重新排序）。易受第一类（用户）攻击的合约比易受第二类（矿工）攻击的合约要糟糕得多，因为矿工只能在解决区块时执行攻击，这对于任何针对特定区块的单个矿工来说都不太可能。在这里，我们将列出与这两类攻击者相关的一些缓解措施。</p>
<p>一种方法是在 <code>gasPrice</code> 上设置一个上限。这可以防止用户增加 <code>gasPrice</code> 并获得超出上限的优惠交易排序。该措施只防范第一类攻击者（任意用户）。在这种情况下，矿工仍然可以攻击合约，因为他们可以随意对区块中的交易进行排序，而不管 gas 价格如何。</p>
<p>一种更稳健的方法是使用 <a target="_blank" rel="noopener" href="https://ethereum.stackexchange.com/questions/191/how-can-i-securely-generate-a-random-number-in-my-smart-contract">commit-reveal</a> 方案。这种方案要求用户发送带有隐藏信息（通常是散列）的交易。在交易被包含在一个块中之后，用户发送一个交易来揭示所发送的数据（reveal 阶段）。这种方法可以防止矿工和用户抢先交易，因为他们无法确定交易的内容。但是，这种方法无法隐藏交易价值(transaction value)（在某些情况下，交易价值是需要隐藏的有价值的信息）。 <a target="_blank" rel="noopener" href="https://ens.domains/">ENS</a> 智能合约允许用户发送交易，其提交的数据(<em>committed data</em>)包括他们愿意花费的以太币数量。然后，用户可以发送任意价值的交易。在 reveal 阶段，用户会获得交易中发送的金额与他们愿意花费的金额之间的差额退款。</p>
<p>Lorenz Breidenbach、Phil Daian、Ari Juels 和 Florian Tramèr 的进一步建议是使用“<a target="_blank" rel="noopener" href="https://hackingdistributed.com/2017/08/28/submarine-sends/">submarine sends</a>”。这个想法的有效实现需要 <code>CREATE2</code> 操作码，该操作码目前尚未被采用，但似乎可能会出现在即将到来的硬分叉中。</p>
<h3 id="现实世界的例子：ERC20-和-Bancor"><a href="#现实世界的例子：ERC20-和-Bancor" class="headerlink" title="现实世界的例子：ERC20 和 Bancor"></a>现实世界的例子：ERC20 和 Bancor</h3><p><a target="_blank" rel="noopener" href="https://github.com/ethereum/EIPs/blob/master/EIPS/eip-20.md">ERC20 标准</a> 以在以太坊上构建代币而闻名。由于 <code>approve</code> 函数，该标准存在潜在的抢跑漏洞。<a target="_blank" rel="noopener" href="https://docs.google.com/document/d/1YLPtQxZu1UAvO9cZ1O2RPXBbT0mooh4DYKjA_jp-RLM/edit">Mikhail Vladimirov 和 Dmitry Khovratovich</a> 对此漏洞（以及减轻攻击的方法）进行了很好的解释。</p>
<p>该标准将 <code>approve</code> 函数指定为：</p>
<figure><div class="code-wrapper"><pre class="line-numbers language-solidity" data-language="solidity"><code class="language-solidity"><span class="token keyword">function</span> <span class="token function">approve</span><span class="token punctuation">(</span><span class="token builtin">address</span> _spender<span class="token punctuation">,</span> <span class="token builtin">uint256</span> _value<span class="token punctuation">)</span> <span class="token keyword">returns</span> <span class="token punctuation">(</span><span class="token builtin">bool</span> success<span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre></div></figure>

<p>此函数允许用户批准其他用户代表他们转移代币。抢跑漏洞发生在用户 Alice 批准她的朋友 Bob 花费 100 个代币的场景中。 Alice 后来决定她想撤销 Bob 对花费 100 个代币的批准，因此她创建了一个交易，将 Bob 的分配设置为 50 个代币。一直在仔细观察链的 Bob 看到了这个交易并建立了一个他自己花费 100 个代币的交易。他为他的交易设置了比 Alice 更高的 <code>gasPrice</code>，因此他的交易优先于她的交易。<code>approve</code> 的一些实现将允许 Bob 转移他的 100 个代币，然后，当 Alice 的交易被提交时，将 Bob 的批准重置为 50 个代币，实际上让 Bob 可以访问 150 个令牌。</p>
<p>另一个突出的现实世界例子是 <a target="_blank" rel="noopener" href="https://home.bancor.network/">Bancor</a>。 Ivan Bogatyy 和他的团队记录了对 Bancor 初始实施的一次有利可图的攻击。他的博客文章(<a target="_blank" rel="noopener" href="https://hackernoon.com/front-running-bancor-in-150-lines-of-python-with-ethereum-api-d5e2bfd0d798">Implementing Ethereum trading front-runs on the Bancor exchange in Python</a>) 和 <a target="_blank" rel="noopener" href="https://www.youtube.com/watch?v=RL2nE3huNiI">DevCon3 演讲</a> 详细讨论了这是如何完成的。本质上，代币的价格是根据交易价值确定的；用户可以查看 Bancor 交易的交易池，并提前运行它们以从价格差异中获利。 Bancor 团队已经解决了这种攻击。</p>
<h2 id="拒绝服务-Denial-of-Service-DoS"><a href="#拒绝服务-Denial-of-Service-DoS" class="headerlink" title="拒绝服务 (Denial of Service, DoS)"></a>拒绝服务 (Denial of Service, DoS)</h2><p>此类别非常广泛，但基本上包括用户可以使合约在一段时间内或在某些情况下永久无法操作的攻击。这可能会永远将以太币困在这些合约中，就像上面提到的 Parity Multisig Wallet (Second Hack) 一样。</p>
<h3 id="漏洞-10"><a href="#漏洞-10" class="headerlink" title="漏洞"></a>漏洞</h3><p>有多种方式可以使合同无法操作。在这里，我们只强调一些可能导致 DoS 漏洞的不太明显的 Solidity 编码模式：</p>
<p><em>通过外部操作的映射或数组的循环 (Looping through externally manipulated mappings or arrays)</em></p>
<p>这种模式通常出现在所有者希望通过类似 <code>distribute</code> 的功能向投资者分发代币时，如本示例合约中所示：</p>
<figure><div class="code-wrapper"><pre class="line-numbers language-solidity" data-language="solidity"><code class="language-solidity"><span class="token keyword">contract</span> <span class="token class-name">DistributeTokens</span> <span class="token punctuation">&#123;</span>
    <span class="token builtin">address</span> <span class="token keyword">public</span> owner<span class="token punctuation">;</span> <span class="token comment">// gets set somewhere</span>
    <span class="token builtin">address</span><span class="token punctuation">[</span><span class="token punctuation">]</span> investors<span class="token punctuation">;</span> <span class="token comment">// array of investors</span>
    <span class="token builtin">uint</span><span class="token punctuation">[</span><span class="token punctuation">]</span> investorTokens<span class="token punctuation">;</span> <span class="token comment">// the amount of tokens each investor gets</span>

    <span class="token comment">// ... extra functionality, including transfertoken()</span>

    <span class="token keyword">function</span> <span class="token function">invest</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">external</span> <span class="token keyword">payable</span> <span class="token punctuation">&#123;</span>
        investors<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>msg<span class="token punctuation">.</span>sender<span class="token punctuation">)</span><span class="token punctuation">;</span>
        investorTokens<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>msg<span class="token punctuation">.</span>value <span class="token operator">*</span> <span class="token number">5</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 5 times the wei sent</span>
        <span class="token punctuation">&#125;</span>

    <span class="token keyword">function</span> <span class="token function">distribute</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">public</span> <span class="token punctuation">&#123;</span>
        <span class="token keyword">require</span><span class="token punctuation">(</span>msg<span class="token punctuation">.</span>sender <span class="token operator">==</span> owner<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// only owner</span>
        <span class="token keyword">for</span><span class="token punctuation">(</span><span class="token builtin">uint</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> investors<span class="token punctuation">.</span>length<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
            <span class="token comment">// here transferToken(to,amount) transfers "amount" of</span>
            <span class="token comment">// tokens to the address "to"</span>
            <span class="token function">transferToken</span><span class="token punctuation">(</span>investors<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">,</span>investorTokens<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span>
    <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></div></figure>

<p>请注意，此合约中的循环运行在一个可以人为膨胀的数组上。攻击者可以创建许多用户帐户，从而使 <code>investor</code> 数组变大。原则上，可以这样做，以使执行 for 循环所需的 gas 超过区块的 gas limit，本质上使 <code>distribute</code> 函数无法运行。</p>
<p><em>所有者操作 (Owner operations)</em></p>
<p>另一种常见的模式是所有者在合约中拥有特定特权，并且必须执行某些任务才能使合约进入下一个状态。一个例子是初始货币发行 (ICO) 合约，该合同要求所有者 <code>finalize</code> 合约，然后允许代币转让。例如：</p>
<figure><div class="code-wrapper"><pre class="line-numbers language-solidity" data-language="solidity"><code class="language-solidity"><span class="token builtin">bool</span> <span class="token keyword">public</span> isFinalized <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
<span class="token builtin">address</span> <span class="token keyword">public</span> owner<span class="token punctuation">;</span> <span class="token comment">// gets set somewhere</span>

<span class="token keyword">function</span> <span class="token function">finalize</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">public</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">require</span><span class="token punctuation">(</span>msg<span class="token punctuation">.</span>sender <span class="token operator">==</span> owner<span class="token punctuation">)</span><span class="token punctuation">;</span>
    isFinalized <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span>

<span class="token comment">// ... extra ICO functionality</span>

<span class="token comment">// overloaded transfer function</span>
<span class="token keyword">function</span> <span class="token function">transfer</span><span class="token punctuation">(</span><span class="token builtin">address</span> _to<span class="token punctuation">,</span> <span class="token builtin">uint</span> _value<span class="token punctuation">)</span> <span class="token keyword">returns</span> <span class="token punctuation">(</span><span class="token builtin">bool</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">require</span><span class="token punctuation">(</span>isFinalized<span class="token punctuation">)</span><span class="token punctuation">;</span>
    super<span class="token punctuation">.</span><span class="token function">transfer</span><span class="token punctuation">(</span>_to<span class="token punctuation">,</span>_value<span class="token punctuation">)</span>
<span class="token punctuation">&#125;</span>

<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></div></figure>

<p>在这种情况下，如果特权用户丢失了他们的私钥或变得不活跃，整个代币合约将变得无法操作。在这种情况下，如果所有者无法调用 <code>finalize</code>，则无法转移代币；代币生态系统的整个运作取决于一个地址。</p>
<p><em>基于外部调用的进展状态 (Progressing state based on external calls)</em></p>
<p>有时会编写合约，以便进入新状态需要将以太币发送到一个地址，或者等待来自外部来源的一些输入。当外部调用失败或因外部原因被阻止时，这些模式可能导致 DoS 攻击。在发送以太币的例子中，用户可以创建一个不接受以太币的合约。如果合约要求以太币被撤回以进入新状态（考虑一个时间锁定合约，要求所有以太币在再次可用之前被撤回），该合约将永远不会达到新状态，因为以太币永远不会发送到不接受以太币的用户合约。</p>
<h3 id="预防技术-10"><a href="#预防技术-10" class="headerlink" title="预防技术"></a>预防技术</h3><p>在第一个例子中，合约不应该循环访问可以被外部用户人为操作的数据结构。建议使用提款模式，每个投资者都调用提款功能来独立索取代币。</p>
<p>在第二个示例中，需要特权用户来更改合约的状态。在这样的示例中，可以在所有者失去能力的情况下使用故障保护。一种解决方案是让所有者成为一个多重签名合约。另一种解决方案是使用时间锁定：在示例中，第 5 行的 require 可以包括基于时间的机制，例如 <code>require(msg.sender == owner || now &gt; unlockTime)</code>，它允许任何用户完成在 <code>unlockTime</code> 指定的一段时间后。这种缓解技术也可以用在第三个例子中。如果需要外部调用进入新状态，请考虑它们可能的失败，并可能在所需调用永远不会到来的情况下添加基于时间的状态进展。</p>
<table>
<thead>
<tr>
<th>Note</th>
<th>当然，这些建议还有集中的替代方案：可以添加一个维护用户，如果需要，他可以一起解决基于 DoS 的攻击向量的问题。由于此类实体的权力，这些类型的合同通常存在信任问题。​</th>
</tr>
</thead>
</table>
<h3 id="现实世界的例子：GovernMental"><a href="#现实世界的例子：GovernMental" class="headerlink" title="现实世界的例子：GovernMental"></a>现实世界的例子：GovernMental</h3><p><a target="_blank" rel="noopener" href="http://governmental.github.io/GovernMental/">GovernMental</a> 是一个古老的庞氏骗局，积累了大量的以太币（1,100 以太币，一次）。不幸的是，它容易受到本节中提到的 DoS 漏洞的影响。 etherik 的 <a target="_blank" rel="noopener" href="https://www.reddit.com/r/ethereum/comments/4ghzhv/governmentals_1100_eth_jackpot_payout_is_stuck/">Reddit 帖子</a> 描述了合约如何要求删除大型映射以提取以太币。删除此映射的 gas 成本超过了当时的区块 gas 限制，因此无法提取 1,100 个以太币。合约地址是 <a target="_blank" rel="noopener" href="https://etherscan.io/address/0xf45717552f12ef7cb65e95476f217ea008167ae3">0xf45717552f12ef7cb65e95476f217ea008167ae3</a>，并且你可以从交易 <a target="_blank" rel="noopener" href="https://etherscan.io/tx/0x0d80d67202bd9cb6773df8dd2020e7190a1b0793e8ec4fc105257e8128f0506b">0x0d80d67202bd9cb6773df8dd2020e7190a1b0793e8ec4fc105257e8128f0506b</a> 看到 1,100 以太币最终通过 250 万 gas 的交易获取了（在区块 gas limit 上升到足以允许此类交易时）。</p>
<h2 id="区块时间戳操作-Block-Timestamp-Manipulation"><a href="#区块时间戳操作-Block-Timestamp-Manipulation" class="headerlink" title="区块时间戳操作 (Block Timestamp Manipulation)"></a>区块时间戳操作 (Block Timestamp Manipulation)</h2><p>区块时间戳历来被用于各种应用，例如随机数的熵（有关更多详细信息，请参阅熵错觉），在一段时间内锁定资金，以及各种与时间相关的状态变化条件语句。矿工有能力稍微调整时间戳，如果在智能合约中错误地使用区块时间戳，这可能会很危险。</p>
<p>对此有用的参考资料包括 <a target="_blank" rel="noopener" href="https://docs.soliditylang.org/en/latest/units-and-global-variables.html#block-and-transaction-properties">Solidity 文档</a> 和 <a target="_blank" rel="noopener" href="https://ethereum.stackexchange.com/questions/413/can-a-contract-safely-rely-on-block-timestamp?utm_medium=organic&utm_source=google_rich_qa&utm_campaign=google_rich_qa">Joris Bontje 关于该主题的 Ethereum Stack Exchange 问题</a>。</p>
<h3 id="漏洞-11"><a href="#漏洞-11" class="headerlink" title="漏洞"></a>漏洞</h3><p><code>block.timestamp</code> 及其别名 <code>now</code> 可以被矿工操纵，如果他们有这样做的动机的话。让我们构建一个简单的游戏，显示在 roulette.sol 中，它很容易受到矿工利用。</p>
<p>示例11. roulette.sol</p>
<figure><div class="code-wrapper"><pre class="line-numbers language-solidity" data-language="solidity"><code class="language-solidity"><span class="token keyword">contract</span> <span class="token class-name">Roulette</span> <span class="token punctuation">&#123;</span>
    <span class="token builtin">uint</span> <span class="token keyword">public</span> pastBlockTime<span class="token punctuation">;</span> <span class="token comment">// forces one bet per block</span>

    <span class="token keyword">constructor</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">external</span> <span class="token keyword">payable</span> <span class="token punctuation">&#123;</span><span class="token punctuation">&#125;</span> <span class="token comment">// initially fund contract</span>

    <span class="token comment">// fallback function used to make a bet</span>
    <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">external</span> <span class="token keyword">payable</span> <span class="token punctuation">&#123;</span>
        <span class="token keyword">require</span><span class="token punctuation">(</span>msg<span class="token punctuation">.</span>value <span class="token operator">==</span> <span class="token number">10</span> ether<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// must send 10 ether to play</span>
        <span class="token keyword">require</span><span class="token punctuation">(</span>now <span class="token operator">!=</span> pastBlockTime<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// only 1 transaction per block</span>
        pastBlockTime <span class="token operator">=</span> now<span class="token punctuation">;</span>
        <span class="token keyword">if</span><span class="token punctuation">(</span>now <span class="token operator">%</span> <span class="token number">15</span> <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span> <span class="token comment">// winner</span>
            msg<span class="token punctuation">.</span>sender<span class="token punctuation">.</span><span class="token function">transfer</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>balance<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span>
    <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></div></figure>

<p>该合约的行为就像一个简单的彩票。每块一笔交易可以下注 10 以太币，就有机会赢得合约余额。这里的假设是<code>block.timestamp</code> 的最后两位数字是均匀分布的。如果是这样的话，中奖的机会将是 15 分之一。</p>
<p>但是，正如我们所知，矿工可以根据需要调整时间戳。在这种特殊情况下，如果合约中有足够多的以太币池，则会激励解决区块的矿工选择一个时间戳，使得 <code>block.timestamp</code> 或 <code>now</code> 模 15 为 0。这样做他们可能会赢得锁定在该合约中的以太币与块奖励。由于每个区块只允许一个人下注，这也容易受到抢跑攻击（请参阅竞争条件&#x2F;抢跑了解更多详细信息）。</p>
<p>在实践中，区块时间戳是单调递增的，因此矿工不能选择任意区块时间戳（它们必须晚于其前辈）。它们还仅限于将块时间设置在不太远的将来，因为这些块可能会被网络拒绝（节点不会验证时间戳在未来的块）。</p>
<h3 id="预防技术-11"><a href="#预防技术-11" class="headerlink" title="预防技术"></a>预防技术</h3><p>区块时间戳不应该用于熵或生成随机数——也就是说，它们不应该是赢得游戏或改变重要状态的决定因素（直接或通过某种推导）。</p>
<p>有时需要时间敏感的逻辑；例如，用于解锁合约（时间锁定），几周后完成 ICO 或执行到期日期。有时建议使用 <code>block.number</code> 和平均块时间来估计时间；<code>10 second</code> 的出块时间，<code>1 week</code> 大约相当于 <code>60480 blocks</code>。因此，指定更改合约状态的区块号可能更安全，因为矿工无法轻松操纵区块号。<a target="_blank" rel="noopener" href="https://etherscan.io/address/0x0d8775f648430679a709e98d2b0cb6250d2887ef#code">BAT ICO</a> 合约采用了这种策略。</p>
<p>如果合约不是特别关注矿工对区块时间戳的操作，这可能是不必要的，但在开发合约时需要注意这一点。</p>
<h3 id="现实世界的例子：GovernMental-1"><a href="#现实世界的例子：GovernMental-1" class="headerlink" title="现实世界的例子：GovernMental"></a>现实世界的例子：GovernMental</h3><p>上面提到的古老庞氏骗局 <a target="_blank" rel="noopener" href="http://governmental.github.io/GovernMental/">GovernMental</a> 也容易受到基于时间戳的攻击。合约支付给最后一个加入（至少一分钟）的球员。因此，作为玩家的矿工可以调整时间戳（到未来时间，使其看起来像一分钟过去了），以使其看起来是最后一个加入超过一分钟的玩家（即使现实中不是真的）。有关这方面的更多详细信息，请参阅 Tanya Bahrynovska 的“<a target="_blank" rel="noopener" href="http://bit.ly/2Q1AMA6">History of Ethereum Security Vulnerabilities, Hacks and Their Fixes</a>”一文。</p>
<h2 id="小心的构造函数-Constructors-with-Care"><a href="#小心的构造函数-Constructors-with-Care" class="headerlink" title="小心的构造函数 (Constructors with Care)"></a>小心的构造函数 (Constructors with Care)</h2><p>构造函数是在初始化合约时经常执行关键的特权任务的特殊函数。在 Solidity v0.4.22 之前，构造函数被定义为与包含它们的合约同名的函数。在这种情况下，当在开发中更改合约名称时，如果构造函数名称也没有更改，它将成为一个正常的可调用函数。正如你可以想象的那样，这可能会导致（并且已经）一些有趣的合约攻击。</p>
<p>为了进一步了解，读者可能有兴趣尝试 <a target="_blank" rel="noopener" href="https://github.com/OpenZeppelin/ethernaut">Ethernaut challenges</a>（特别是 Fallout 级别）。</p>
<h3 id="漏洞-12"><a href="#漏洞-12" class="headerlink" title="漏洞"></a>漏洞</h3><p>如果合约名称被修改，或者构造函数名称中存在拼写错误以至于它与合约名称不匹配，则构造函数将像普通函数一样运行。这可能会导致可怕的后果，尤其是在构造函数执行特权操作时。考虑以下合约：</p>
<figure><div class="code-wrapper"><pre class="line-numbers language-solidity" data-language="solidity"><code class="language-solidity"><span class="token keyword">contract</span> <span class="token class-name">OwnerWallet</span> <span class="token punctuation">&#123;</span>
    <span class="token builtin">address</span> <span class="token keyword">public</span> owner<span class="token punctuation">;</span>

    <span class="token comment">// constructor</span>
    <span class="token keyword">function</span> <span class="token function">ownerWallet</span><span class="token punctuation">(</span><span class="token builtin">address</span> _owner<span class="token punctuation">)</span> <span class="token keyword">public</span> <span class="token punctuation">&#123;</span>
        owner <span class="token operator">=</span> _owner<span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>

    <span class="token comment">// Fallback. Collect ether.</span>
    <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">payable</span> <span class="token punctuation">&#123;</span><span class="token punctuation">&#125;</span>

    <span class="token keyword">function</span> <span class="token function">withdraw</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">public</span> <span class="token punctuation">&#123;</span>
        <span class="token keyword">require</span><span class="token punctuation">(</span>msg<span class="token punctuation">.</span>sender <span class="token operator">==</span> owner<span class="token punctuation">)</span><span class="token punctuation">;</span>
        msg<span class="token punctuation">.</span>sender<span class="token punctuation">.</span><span class="token function">transfer</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>balance<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></div></figure>

<p>该合约通过调用 <code>withdraw</code> 函数收集以太币并只允许所有者提取它。出现问题是因为构造函数的名称与合同的名称不完全相同：第一个字母不同！因此，任何用户都可以调用 <code>ownerWallet</code> 函数，将自己设置为所有者，然后通过调用 <code>withdraw</code> 来获取合约中的所有以太币。</p>
<h3 id="预防技术-12"><a href="#预防技术-12" class="headerlink" title="预防技术"></a>预防技术</h3><p>此问题已在 Solidity 编译器的 0.4.22 版本中得到解决。该版本引入了指定构造函数的 <code>constructor</code> 关键字，而不是要求函数名称与合约名称匹配。建议使用此关键字指定构造函数以防止命名问题。</p>
<h3 id="真实世界的例子：Rubixi"><a href="#真实世界的例子：Rubixi" class="headerlink" title="真实世界的例子：Rubixi"></a>真实世界的例子：Rubixi</h3><p><a target="_blank" rel="noopener" href="https://etherscan.io/address/0xe82719202e5965Cf5D9B6673B7503a3b92DE20be#code">Rubixi</a> 是另一个表现出这种脆弱性的金字塔计划。它最初被称为 <code>DynamicPyramid</code>，但在部署到 <code>Rubixi</code> 之前更改了合约名称。构造函数的名称没有改变，这允许任何用户成为创建者(<em>creator</em>)。可以在 <a target="_blank" rel="noopener" href="https://bitcointalk.org/index.php?topic=1400536.60">Bitcointalk</a> 上找到与此错误相关的一些有趣的讨论。最终，它允许用户争夺创建者身份，以从金字塔计划中索取费用。</p>
<h2 id="未初始化的存储指针-Uninitialized-Storage-Pointers"><a href="#未初始化的存储指针-Uninitialized-Storage-Pointers" class="headerlink" title="未初始化的存储指针 (Uninitialized Storage Pointers)"></a>未初始化的存储指针 (Uninitialized Storage Pointers)</h2><p><strong>EVM 将数据存储到 storage 或 memory。在开发合约时，强烈建议准确了解这是如何完成的以及函数局部变量的默认类型。</strong>这是因为不恰当地初始化变量可能会产生易受攻击的合约。</p>
<p>要了解有关 EVM 中存储和内存的更多信息，请参阅 Solidity 文档中的 <a target="_blank" rel="noopener" href="https://docs.soliditylang.org/en/latest/types.html#data-location">data location</a>，<a target="_blank" rel="noopener" href="https://docs.soliditylang.org/en/latest/internals/layout_in_storage.html?highlight=%20layout%20of%20state%20variables%20in%20storage">layout of state variables in storage</a> 和 <a target="_blank" rel="noopener" href="https://docs.soliditylang.org/en/latest/internals/layout_in_memory.html?highlight=layout%20in%20memory">layout in memory</a>。</p>
<table>
<thead>
<tr>
<th>Note</th>
<th>本部分基于 Stefan Beyer 的<a target="_blank" rel="noopener" href="https://medium.com/cryptronics/storage-allocation-exploits-in-ethereum-smart-contracts-16c2aa312743">一篇出色的文章</a>。受 Stefan 启发，关于这个主题的进一步阅读可以在这个 <a target="_blank" rel="noopener" href="https://www.reddit.com/r/ethdev/comments/7wp363/how_does_this_honeypot_work_it_seems_like_a/">Reddit thread</a> 中找到。</th>
</tr>
</thead>
</table>
<h3 id="漏洞-13"><a href="#漏洞-13" class="headerlink" title="漏洞"></a>漏洞</h3><p>函数中的局部变量默认为存储或内存，具体取决于它们的类型。未初始化的本地存储变量可能包含合约中其他存储变量的值；这一事实可能会导致无意的漏洞，或被故意利用。</p>
<p>让我们考虑 NameRegistrar.sol 中相对简单的名称注册商合约。</p>
<p>示例12. NameRegistrar.sol</p>
<figure><div class="code-wrapper"><pre class="line-numbers language-solidity" data-language="solidity"><code class="language-solidity"><span class="token comment">// A locked name registrar</span>
<span class="token keyword">contract</span> <span class="token class-name">NameRegistrar</span> <span class="token punctuation">&#123;</span>

    <span class="token builtin">bool</span> <span class="token keyword">public</span> unlocked <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>  <span class="token comment">// registrar locked, no name updates</span>

    <span class="token keyword">struct</span> <span class="token class-name">NameRecord</span> <span class="token punctuation">&#123;</span> <span class="token comment">// map hashes to addresses</span>
        <span class="token builtin">bytes32</span> name<span class="token punctuation">;</span>
        <span class="token builtin">address</span> mappedAddress<span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>

    <span class="token comment">// records who registered names</span>
    <span class="token keyword">mapping</span><span class="token punctuation">(</span><span class="token builtin">address</span> <span class="token operator">=></span> NameRecord<span class="token punctuation">)</span> <span class="token keyword">public</span> registeredNameRecord<span class="token punctuation">;</span>
    <span class="token comment">// resolves hashes to addresses</span>
    <span class="token keyword">mapping</span><span class="token punctuation">(</span><span class="token builtin">bytes32</span> <span class="token operator">=></span> <span class="token builtin">address</span><span class="token punctuation">)</span> <span class="token keyword">public</span> resolve<span class="token punctuation">;</span>

    <span class="token keyword">function</span> <span class="token function">register</span><span class="token punctuation">(</span><span class="token builtin">bytes32</span> _name<span class="token punctuation">,</span> <span class="token builtin">address</span> _mappedAddress<span class="token punctuation">)</span> <span class="token keyword">public</span> <span class="token punctuation">&#123;</span>
        <span class="token comment">// set up the new NameRecord</span>
        NameRecord newRecord<span class="token punctuation">;</span>
        newRecord<span class="token punctuation">.</span>name <span class="token operator">=</span> _name<span class="token punctuation">;</span>
        newRecord<span class="token punctuation">.</span>mappedAddress <span class="token operator">=</span> _mappedAddress<span class="token punctuation">;</span>

        resolve<span class="token punctuation">[</span>_name<span class="token punctuation">]</span> <span class="token operator">=</span> _mappedAddress<span class="token punctuation">;</span>
        registeredNameRecord<span class="token punctuation">[</span>msg<span class="token punctuation">.</span>sender<span class="token punctuation">]</span> <span class="token operator">=</span> newRecord<span class="token punctuation">;</span>

        <span class="token keyword">require</span><span class="token punctuation">(</span>unlocked<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// only allow registrations if contract is unlocked</span>
    <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></div></figure>

<p>这个简单的名称注册器只有一个功能。当合约是 <code>unlocked</code> 时，它允许任何人注册一个名称（作为 <code>bytes32</code> 散列）并将该名称映射到一个地址。 registrar 最初被锁定，第 25 行的 <code>require</code> 阻止 <code>register</code> 添加名称记录。合约似乎无法使用，因为无法解锁注册表！但是，有一个漏洞允许名称注册，而不管 <code>unlocked</code> 的变量如何。</p>
<p>要讨论这个漏洞，首先我们需要了解存储在 Solidity 中是如何工作的。作为一个层级概述（没有任何适当的技术细节——我们建议阅读 Solidity 文档以进行适当的查看），状态变量按出现在合约中的顺序存储在 <em>slots</em> 中（它们可以组合在一起但不在此例中，所以我们不会担心）。因此，<code>unlocked</code> 存在于 <code>slot[0]</code> 中，<code>registeredNameRecord</code> 存在于 <code>slot[1]</code> 中，并且 <code>resolve</code> 存在于 <code>slot[2]</code> 中，等等。这些 slot 中的每一个都是 32 字节大小（映射增加了复杂性，我们现在将忽略它）。<code>unlocked</code> 的布尔值看起来像 <code>0x000...0</code>（64 个 0，不包括 0x）表示 <code>false</code> 或 <code>0x000...1</code>（63 0s）表示 <code>true</code>。如您所见，在此特定示例中存在大量存储浪费。</p>
<p>下一个难题是 Solidity 在将复杂数据类型（例如 struct）初始化为局部变量时默认将它们放入存储中。因此，第 18 行的 <code>newRecord</code> 默认为 storage。该漏洞是由于 <code>newRecord</code> 未初始化造成的。因为默认是 storage，所以映射到 storage slot[0]，当前包含一个指向 <code>unlocked</code> 的指针。请注意，在第 19 行和第 20 行，我们将 <code>newRecord.name</code> 设置为 <code>_name</code> 并将 <code>newRecord.mappedAddress</code> 设置为 <code>_mappedAddress</code>；这会更新 slot[0] 和 slot[1] 的存储位置，这会同时修改 <code>unlocked</code> 和与 <code>registerNameRecord</code> 关联的 storage slot。</p>
<p>这意味着 <code>unlocked</code> 可以直接修改，只需通过 <code>register</code>  函数的 <code>bytes32_name</code> 参数即可。因此，如果 <code>_name</code> 的最后一个字节不为零，它会修改 storage <code>slot[0]</code> 的最后一个字节，直接将 <code>unlocked</code> 改为 <code>true</code>。这样的 <code>_name</code> 值将导致第 25 行的 <code>require</code> 调用成功，因为我们已将 <code>unlocked</code> 设置为 <code>true</code>。在 Remix 中试试这个。请注意，如果您使用以下形式的 <code>_name</code>，该函数将通过：</p>
<figure><div class="code-wrapper"><pre class="line-numbers language-solidity" data-language="solidity"><code class="language-solidity"><span class="token number">0x0000000000000000000000000000000000000000000000000000000000000001</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre></div></figure>

<h3 id="预防技术-13"><a href="#预防技术-13" class="headerlink" title="预防技术"></a>预防技术</h3><p>Solidity 编译器对未初始化的 storage 变量显示警告；开发人员在构建智能合约时应特别注意这些警告。当前版本的 Mist (0.10) 不允许编译这些合约。在处理复杂类型时，显式使用 <code>memory</code> 或 <code>storage</code> 说明符通常是一种很好的做法，以确保它们的行为符合预期。</p>
<h3 id="现实世界的例子：OpenAddressLottery-和-CryptoRoulette-Honey-Pots"><a href="#现实世界的例子：OpenAddressLottery-和-CryptoRoulette-Honey-Pots" class="headerlink" title="现实世界的例子：OpenAddressLottery 和 CryptoRoulette Honey Pots"></a>现实世界的例子：OpenAddressLottery 和 CryptoRoulette Honey Pots</h3><p>部署了一个名为 <a target="_blank" rel="noopener" href="https://etherscan.io/address/0x8685631276cfcf17a973d92f6dc11645e5158c0c#code">OpenAddressLottery</a> 的蜜罐，它使用这个未初始化的存储变量怪癖(quirk)从一些潜在的黑客那里收集以太币。合约相当复杂，所以我们将把分析留给 <a target="_blank" rel="noopener" href="https://www.reddit.com/r/ethdev/comments/7wp363/how_does_this_honeypot_work_it_seems_like_a/">Reddit thread</a>，在那里对攻击进行了非常清楚的解释。</p>
<h2 id="浮点数和精度-Floating-Point-and-Precision"><a href="#浮点数和精度-Floating-Point-and-Precision" class="headerlink" title="浮点数和精度 (Floating Point and Precision)"></a>浮点数和精度 (Floating Point and Precision)</h2><p>在撰写本文时（v0.4.24），Solidity 不支持定点数和浮点数。这意味着浮点表示必须使用 Solidity 中的整数类型来构造。如果没有正确实施，这可能会导致错误和漏洞。</p>
<table>
<thead>
<tr>
<th>Note</th>
<th>如需进一步阅读，请参阅 <a target="_blank" rel="noopener" href="https://github.com/ethereum/wiki/wiki/Safety#beware-rounding-with-integer-division">以太坊合约安全技术和 Tips wiki</a>。</th>
</tr>
</thead>
</table>
<h3 id="漏洞-14"><a href="#漏洞-14" class="headerlink" title="漏洞"></a>漏洞</h3><p>由于 Solidity 中没有定点类型，因此要求开发人员使用标准整数数据类型实现自己的需求。在此过程中，开发人员可能会遇到许多陷阱。我们将尝试在本节中强调其中的一些。</p>
<p>让我们从一个代码示例开始（为简单起见，我们将忽略本章前面讨论过的上溢&#x2F;下溢问题）：</p>
<figure><div class="code-wrapper"><pre class="line-numbers language-solidity" data-language="solidity"><code class="language-solidity"><span class="token keyword">contract</span> <span class="token class-name">FunWithNumbers</span> <span class="token punctuation">&#123;</span>
    <span class="token builtin">uint</span> <span class="token keyword">constant</span> <span class="token keyword">public</span> tokensPerEth <span class="token operator">=</span> <span class="token number">10</span><span class="token punctuation">;</span>
    <span class="token builtin">uint</span> <span class="token keyword">constant</span> <span class="token keyword">public</span> weiPerEth <span class="token operator">=</span> <span class="token number">1e18</span><span class="token punctuation">;</span>
    <span class="token keyword">mapping</span><span class="token punctuation">(</span><span class="token builtin">address</span> <span class="token operator">=></span> <span class="token builtin">uint</span><span class="token punctuation">)</span> <span class="token keyword">public</span> balances<span class="token punctuation">;</span>

    <span class="token keyword">function</span> <span class="token function">buyTokens</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">external</span> <span class="token keyword">payable</span> <span class="token punctuation">&#123;</span>
        <span class="token comment">// convert wei to eth, then multiply by token rate</span>
        <span class="token builtin">uint</span> tokens <span class="token operator">=</span> msg<span class="token punctuation">.</span>value<span class="token operator">/</span>weiPerEth<span class="token operator">*</span>tokensPerEth<span class="token punctuation">;</span>
        balances<span class="token punctuation">[</span>msg<span class="token punctuation">.</span>sender<span class="token punctuation">]</span> <span class="token operator">+=</span> tokens<span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>

    <span class="token keyword">function</span> <span class="token function">sellTokens</span><span class="token punctuation">(</span><span class="token builtin">uint</span> tokens<span class="token punctuation">)</span> <span class="token keyword">public</span> <span class="token punctuation">&#123;</span>
        <span class="token keyword">require</span><span class="token punctuation">(</span>balances<span class="token punctuation">[</span>msg<span class="token punctuation">.</span>sender<span class="token punctuation">]</span> <span class="token operator">>=</span> tokens<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token builtin">uint</span> eth <span class="token operator">=</span> tokens<span class="token operator">/</span>tokensPerEth<span class="token punctuation">;</span>
        balances<span class="token punctuation">[</span>msg<span class="token punctuation">.</span>sender<span class="token punctuation">]</span> <span class="token operator">-=</span> tokens<span class="token punctuation">;</span>
        msg<span class="token punctuation">.</span>sender<span class="token punctuation">.</span><span class="token function">transfer</span><span class="token punctuation">(</span>eth<span class="token operator">*</span>weiPerEth<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></div></figure>

<p>这个简单的代币买卖合约有一些明显的问题。虽然买卖代币的数学计算是正确的，但缺少浮点数会给出错误的结果。例如，在第 8 行购买代币时，如果值小于 <code>1 ether</code>，则初始除法将导致 <code>0</code>，最终乘法的结果为 <code>0</code>（例如，200 wei 除以 <code>1e18</code> <code>weiPerEth</code>等于<code>0</code>）。同样，在出售代币时，任何少于 <code>10</code> 个的代币也将导致 <code>0 ether</code>。事实上，这里的四舍五入总是向下，所以卖出 <code>29 tokens</code> 将得到 <code>2 ether</code>。</p>
<p>该合约的问题在于精度仅到最接近的以太币（如 1e18 wei）。当您需要更高的精度时，在处理 ERC20 代币中的小数时，这可能会变得很棘手。</p>
<h3 id="预防技术-14"><a href="#预防技术-14" class="headerlink" title="预防技术"></a>预防技术</h3><p>在您的智能合约中保持正确的精度非常重要，尤其是在处理反映经济决策的比率和利率时。</p>
<p>您应该确保您使用的任何 ratio 或 rate 都允许分数中的大分子(large numerator)。例如，我们在示例中使用了 rate <code>tokensPerEth</code>。使用 <code>weiPerTokens</code> 会更好，这将是一个很大的数字。要计算相应的代币数量，我们可以执行 <code>msg.value/weiPerTokens</code>。这将给出更精确的结果。</p>
<p>要记住的另一个策略是注意操作顺序。在我们的示例中，购买代币的计算是 <code>msg.value/weiPerEth*tokenPerEth</code>。请注意，除法发生在乘法之前。 （与某些语言不同，Solidity 保证按照编写顺序执行操作。）如果计算先执行乘法然后执行除法，则此示例将获得更高的精度；即 <code>msg.value*tokenPerEth/weiPerEth</code>。</p>
<p>最后，在为数字定义任意精度时，最好将值转换为更高的精度，执行所有数学运算，然后最终转换回输出所需的精度。通常使用 uint256（因为它们最适合gas使用）；这些在它们的范围内给出了大约 60 个数量级，其中一些可以专用于数学运算的精度。在 Solidity 中保持所有变量的高精度并在外部应用程序中转换回较低精度可能会更好（这本质上是 <code>decimals</code> 变量在 ERC20 代币合约中的工作方式）。要查看如何完成此操作的示例，我们建议查看 <a target="_blank" rel="noopener" href="https://github.com/dapphub/ds-math">DS-Math</a>。它使用了一些时髦的命名（“wads”和“rays”），但这个概念很有用。</p>
<h3 id="现实世界的例子：Ethstick"><a href="#现实世界的例子：Ethstick" class="headerlink" title="现实世界的例子：Ethstick"></a>现实世界的例子：Ethstick</h3><p><a target="_blank" rel="noopener" href="https://etherscan.io/address/0xbA6284cA128d72B25f1353FadD06Aa145D9095Af#code">Ethstick</a> 合约不使用扩展精度；但是，它与 wei 打交道。所以，这个合约会有四舍五入的问题，但仅限于 wei 级别的精度。它有一些更严重的缺陷，但这些缺陷与在区块链上获取熵的困难有关（参见熵错觉）。</p>
<h2 id="Tx-Origin-身份认证-Tx-Origin-Authentication"><a href="#Tx-Origin-身份认证-Tx-Origin-Authentication" class="headerlink" title="Tx.Origin 身份认证 (Tx.Origin Authentication)"></a>Tx.Origin 身份认证 (Tx.Origin Authentication)</h2><p>Solidity 有一个全局变量 <code>tx.origin</code>，它会遍历整个调用栈，并包含最初发送调用（或交易）的账户地址。在智能合约中使用此变量进行身份验证会使合约容易受到类似网络钓鱼的攻击。</p>
<table>
<thead>
<tr>
<th>Note</th>
<th>如需进一步阅读，请参阅 dbryson 的 <a target="_blank" rel="noopener" href="https://ethereum.stackexchange.com/questions/1891/whats-the-difference-between-msg-sender-and-tx-origin">Ethereum Stack Exchange question</a> 和 Chris Coverdale 的“<a target="_blank" rel="noopener" href="https://medium.com/coinmonks/solidity-tx-origin-attacks-58211ad95514">Solidity: Tx Origin Attacks</a>”。</th>
</tr>
</thead>
</table>
<h3 id="漏洞-15"><a href="#漏洞-15" class="headerlink" title="漏洞"></a>漏洞</h3><p>使用 <code>tx.origin</code> 变量授权用户的合约通常容易受到网络钓鱼攻击，这些攻击可以诱骗用户对易受攻击的合约执行经过身份验证的操作。</p>
<p>考虑 Phishable.sol 中的简单合约。</p>
<p>示例13. Phishable.sol</p>
<figure><div class="code-wrapper"><pre class="line-numbers language-solidity" data-language="solidity"><code class="language-solidity"><span class="token keyword">contract</span> <span class="token class-name">Phishable</span> <span class="token punctuation">&#123;</span>
    <span class="token builtin">address</span> <span class="token keyword">public</span> owner<span class="token punctuation">;</span>

    <span class="token keyword">constructor</span> <span class="token punctuation">(</span><span class="token builtin">address</span> _owner<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        owner <span class="token operator">=</span> _owner<span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>

    <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">external</span> <span class="token keyword">payable</span> <span class="token punctuation">&#123;</span><span class="token punctuation">&#125;</span> <span class="token comment">// collect ether</span>

    <span class="token keyword">function</span> <span class="token function">withdrawAll</span><span class="token punctuation">(</span><span class="token builtin">address</span> _recipient<span class="token punctuation">)</span> <span class="token keyword">public</span> <span class="token punctuation">&#123;</span>
        <span class="token keyword">require</span><span class="token punctuation">(</span>tx<span class="token punctuation">.</span>origin <span class="token operator">==</span> owner<span class="token punctuation">)</span><span class="token punctuation">;</span>
        _recipient<span class="token punctuation">.</span><span class="token function">transfer</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>balance<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></div></figure>

<p>请注意，在第 11 行，合约使用 <code>tx.origin</code> 授权了 <code>withdrawAll</code> 函数。该合约允许攻击者创建以下形式的攻击合约：</p>
<figure><div class="code-wrapper"><pre class="line-numbers language-solidity" data-language="solidity"><code class="language-solidity"><span class="token keyword">import</span> <span class="token string">"Phishable.sol"</span><span class="token punctuation">;</span>

<span class="token keyword">contract</span> <span class="token class-name">AttackContract</span> <span class="token punctuation">&#123;</span>

    Phishable phishableContract<span class="token punctuation">;</span>
    <span class="token builtin">address</span> attacker<span class="token punctuation">;</span> <span class="token comment">// The attacker's address to receive funds</span>

    <span class="token keyword">constructor</span> <span class="token punctuation">(</span>Phishable _phishableContract<span class="token punctuation">,</span> <span class="token builtin">address</span> _attackerAddress<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        phishableContract <span class="token operator">=</span> _phishableContract<span class="token punctuation">;</span>
        attacker <span class="token operator">=</span> _attackerAddress<span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>

    <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">payable</span> <span class="token punctuation">&#123;</span>
        phishableContract<span class="token punctuation">.</span><span class="token function">withdrawAll</span><span class="token punctuation">(</span>attacker<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></div></figure>

<p>攻击者可能会将该合约伪装成他们自己的私人地址，并对受害者（Phishable 合约的所有者）进行社会工程，以向该地址发送某种形式的交易——也许向该合约发送一定数量的以太币。除非小心，否则受害者可能不会注意到攻击者的地址有代码，或者攻击者可能会将其伪装成多重签名钱包或某些高级存储钱包（请记住，默认情况下公共合约的源代码不可用）。</p>
<p>在任何情况下，如果受害者向 <code>AttackContract</code> 地址发送了一笔足够 gas 的交易，它就会调用 fallback 函数，该函数又会调用带有参数 <code>attacker</code>的 <code>Phishable</code>合约的<code>withdrawAll</code> 函数。这将导致从 <code>Phishable</code> 合约中提取所有资金到 <code>attacker</code> 地址。这是因为首先初始化调用的地址是受害者（即 <code>Phishable</code> 合约的所有者）。因此，<code>tx.origin</code> 将等于 <code>owner</code>，<code>Phishable</code> 合约第 11 行的要求将通过。</p>
<h3 id="预防技术-15"><a href="#预防技术-15" class="headerlink" title="预防技术"></a>预防技术</h3><p><code>tx.origin</code> 不应用于智能合约中的授权。这并不是说永远不应该使用 <code>tx.origin</code> 变量。它在智能合约中确实有一些合法的用例。例如，如果想要拒绝外部合约调用当前合约，可以实现形式为 <code>require(tx.origin == msg.sender)</code> 的 <code>require</code>。这可以防止使用中间合约来调用当前合约，从而将合约限制为常规无代码地址。</p>
<h2 id="合约库-Contract-Libraries"><a href="#合约库-Contract-Libraries" class="headerlink" title="合约库 (Contract Libraries)"></a>合约库 (Contract Libraries)</h2><p>有很多现有代码可供重用，既部署在链上作为可调用库，又部署在链下作为代码模板库。已部署的平台库以字节码智能合约的形式存在，因此在生产中使用它们之前应格外小心。但是，使用完善的现有平台库具有许多优势，例如能够从最新升级中受益，并通过减少以太坊中的实时合约总数为您节省资金并有益于以太坊生态系统。</p>
<p>在以太坊中，使用最广泛的资源是 <a target="_blank" rel="noopener" href="https://www.openzeppelin.com/contracts">OpenZeppelin</a> 套件，它是一个丰富的合约库，范围从 ERC20 和 ERC721 代币的实现，到多种众筹模型，再到合约中常见的简单行为，例如 <code>Ownable</code>、<code>Pausable</code> 或 <code>LimitBalance</code> 。这个存储库中的合约已经过广泛的测试，在某些情况下甚至可以作为事实上的标准实现。它们可以免费使用，并且由 <a target="_blank" rel="noopener" href="https://www.openzeppelin.com/">OpenZeppelin</a> 与不断增长的外部贡献者列表一起构建和维护。</p>
<p>Zeppelin 还提供了 <a target="_blank" rel="noopener" href="https://www.openzeppelin.com/defender">OpenZeppelin | Defender</a>，这是一个开源的服务和工具平台，用于安全地开发和管理智能合约应用程序。 它在 EVM 之上提供了一个层，使开发人员可以轻松地启动可升级的 DApp，这些 DApp 链接到链上库，其中包含经过良好测试的合约，这些合约本身是可升级的。这些库的不同版本可以在以太坊平台上共存，并且担保系统允许用户提出或推动不同方向的改进。该平台还提供了一套用于调试、测试、部署和监控去中心化应用程序的链下工具。</p>
<p>ethpm 项目旨在通过提供包管理系统来组织生态系统中正在开发的各种资源。因此，他们的注册表提供了更多示例供您浏览：</p>
<ul>
<li>Website: <a target="_blank" rel="noopener" href="https://www.ethpm.com/">https://www.ethpm.com/</a></li>
<li>Repository link: <a target="_blank" rel="noopener" href="https://www.ethpm.com/registry">https://www.ethpm.com/registry</a></li>
<li>GitHub link: <a target="_blank" rel="noopener" href="https://github.com/ethpm">https://github.com/ethpm</a></li>
<li>Documentation: <a target="_blank" rel="noopener" href="https://www.ethpm.com/docs/integration-guide">https://www.ethpm.com/docs/integration-guide</a></li>
</ul>
<h2 id="结论-Conclusions"><a href="#结论-Conclusions" class="headerlink" title="结论 (Conclusions)"></a>结论 (Conclusions)</h2><p>任何在智能合约领域工作的开发人员都需要了解和理解很多东西。通过遵循智能合约设计和代码编写的最佳实践，您将避免许多严重的陷阱和陷阱。</p>
<p>也许最基本的软件安全原则是最大限度地重用受信任的代码。在密码学中，这非常重要，以至于被浓缩成一句格言：“不要推出自己的加密货币。”就智能合约而言，这相当于从经过社区彻底审查的免费可用库中获得尽可能多的收益。</p>

                
              </div>
            
            <hr/>
            <div>
              <div class="post-metas my-3">
  
    <div class="post-meta mr-3 d-flex align-items-center">
      <i class="iconfont icon-category"></i>
      

<span class="category-chains">
  
  
    
      <span class="category-chain">
        
  <a href="/categories/%E5%8C%BA%E5%9D%97%E9%93%BE%E6%8A%80%E6%9C%AF/" class="category-chain-item">区块链技术</a>
  
  
    <span>></span>
    
  <a href="/categories/%E5%8C%BA%E5%9D%97%E9%93%BE%E6%8A%80%E6%9C%AF/%E7%B2%BE%E9%80%9A%E4%BB%A5%E5%A4%AA%E5%9D%8A/" class="category-chain-item">精通以太坊</a>
  
  

  

      </span>
    
  
</span>

    </div>
  
  
    <div class="post-meta">
      <i class="iconfont icon-tags"></i>
      
        <a href="/tags/%E5%8C%BA%E5%9D%97%E9%93%BE%E6%8A%80%E6%9C%AF/">#区块链技术</a>
      
        <a href="/tags/%E4%BB%A5%E5%A4%AA%E5%9D%8A/">#以太坊</a>
      
        <a href="/tags/%E5%8C%BA%E5%9D%97%E9%93%BE%E5%AE%89%E5%85%A8/">#区块链安全</a>
      
    </div>
  
</div>


              
  

  <div class="license-box my-3">
    <div class="license-title">
      <div>精通以太坊：智能合约安全</div>
      <div>https://alphafitz.com/2022/09/13/mastering-ethereum-smart-contract-security/</div>
    </div>
    <div class="license-meta">
      
        <div class="license-meta-item">
          <div>作者</div>
          <div>alphafitz</div>
        </div>
      
      
        <div class="license-meta-item license-meta-date">
          <div>发布于</div>
          <div>2022年9月13日</div>
        </div>
      
      
      <div class="license-meta-item">
        <div>许可协议</div>
        <div>
          
            
            
              <a target="_blank" href="https://creativecommons.org/licenses/by-nc-sa/4.0/">
              <span class="hint--top hint--rounded" aria-label="BY - 署名">
                <i class="iconfont icon-by"></i>
              </span>
              </a>
            
              <a target="_blank" href="https://creativecommons.org/licenses/by-nc-sa/4.0/">
              <span class="hint--top hint--rounded" aria-label="NC - 非商业性使用">
                <i class="iconfont icon-nc"></i>
              </span>
              </a>
            
              <a target="_blank" href="https://creativecommons.org/licenses/by-nc-sa/4.0/">
              <span class="hint--top hint--rounded" aria-label="SA - 相同方式共享">
                <i class="iconfont icon-sa"></i>
              </span>
              </a>
            
          
        </div>
      </div>
    </div>
    <div class="license-icon iconfont"></div>
  </div>



              
                <div class="post-prevnext my-3">
                  <article class="post-prev col-6">
                    
                    
                      <a href="/2022/09/14/openzeppelin-contracts-4-docs/" title="OpenZeppelin Contracts 4.x 文档">
                        <i class="iconfont icon-arrowleft"></i>
                        <span class="hidden-mobile">OpenZeppelin Contracts 4.x 文档</span>
                        <span class="visible-mobile">上一篇</span>
                      </a>
                    
                  </article>
                  <article class="post-next col-6">
                    
                    
                      <a href="/2022/09/12/mastering-ethereum-the-ethereum-virtual-machine/" title="精通以太坊：以太坊虚拟机">
                        <span class="hidden-mobile">精通以太坊：以太坊虚拟机</span>
                        <span class="visible-mobile">下一篇</span>
                        <i class="iconfont icon-arrowright"></i>
                      </a>
                    
                  </article>
                </div>
              
            </div>

            
          </article>
        </div>
      </div>
    </div>

    <div class="side-col d-none d-lg-block col-lg-2">
      
  <aside class="sidebar" style="margin-left: -1rem">
    <div id="toc">
  <p class="toc-header"><i class="iconfont icon-list"></i>&nbsp;目录</p>
  <div class="toc-body" id="toc-body"></div>
</div>



  </aside>


    </div>
  </div>
</div>





  



  



  



  



  







    

    
      <a id="scroll-top-button" aria-label="TOP" href="#" role="button">
        <i class="iconfont icon-arrowup" aria-hidden="true"></i>
      </a>
    

    
      <div class="modal fade" id="modalSearch" tabindex="-1" role="dialog" aria-labelledby="ModalLabel"
     aria-hidden="true">
  <div class="modal-dialog modal-dialog-scrollable modal-lg" role="document">
    <div class="modal-content">
      <div class="modal-header text-center">
        <h4 class="modal-title w-100 font-weight-bold">搜索</h4>
        <button type="button" id="local-search-close" class="close" data-dismiss="modal" aria-label="Close">
          <span aria-hidden="true">&times;</span>
        </button>
      </div>
      <div class="modal-body mx-3">
        <div class="md-form mb-5">
          <input type="text" id="local-search-input" class="form-control validate">
          <label data-error="x" data-success="v" for="local-search-input">关键词</label>
        </div>
        <div class="list-group" id="local-search-result"></div>
      </div>
    </div>
  </div>
</div>

    

    
  </main>

  <footer>
    <div class="footer-inner">
  
    <div class="footer-content">
       <a href="https://hexo.io" target="_blank" rel="nofollow noopener"><span>Hexo</span></a> <i class="iconfont icon-love"></i> <a href="https://github.com/fluid-dev/hexo-theme-fluid" target="_blank" rel="nofollow noopener"><span>Fluid</span></a> 
    </div>
  
  
    <div class="statistics">
  
  

  
    
      <span id="busuanzi_container_site_pv" style="display: none">
        总访问量 
        <span id="busuanzi_value_site_pv"></span>
         次
      </span>
    
    
      <span id="busuanzi_container_site_uv" style="display: none">
        总访客数 
        <span id="busuanzi_value_site_uv"></span>
         人
      </span>
    
    
  
</div>

  
  
  
</div>

  </footer>

  <!-- Scripts -->
  
  <script  src="https://lib.baomitu.com/nprogress/0.2.0/nprogress.min.js" ></script>
  <link  rel="stylesheet" href="https://lib.baomitu.com/nprogress/0.2.0/nprogress.min.css" />

  <script>
    NProgress.configure({"showSpinner":false,"trickleSpeed":100})
    NProgress.start()
    window.addEventListener('load', function() {
      NProgress.done();
    })
  </script>


<script  src="https://lib.baomitu.com/jquery/3.6.0/jquery.min.js" ></script>
<script  src="https://lib.baomitu.com/twitter-bootstrap/4.6.1/js/bootstrap.min.js" ></script>
<script  src="/js/events.js" ></script>
<script  src="/js/plugins.js" ></script>


  <script  src="https://lib.baomitu.com/typed.js/2.0.12/typed.min.js" ></script>
  <script>
    (function (window, document) {
      var typing = Fluid.plugins.typing;
      var subtitle = document.getElementById('subtitle');
      if (!subtitle || !typing) {
        return;
      }
      var text = subtitle.getAttribute('data-typed-text');
      
        typing(text);
      
    })(window, document);
  </script>




  
    <script  src="/js/img-lazyload.js" ></script>
  




  
<script>
  Fluid.utils.createScript('https://lib.baomitu.com/tocbot/4.18.2/tocbot.min.js', function() {
    var toc = jQuery('#toc');
    if (toc.length === 0 || !window.tocbot) { return; }
    var boardCtn = jQuery('#board-ctn');
    var boardTop = boardCtn.offset().top;

    window.tocbot.init({
      tocSelector     : '#toc-body',
      contentSelector : '.markdown-body',
      headingSelector : CONFIG.toc.headingSelector || 'h1,h2,h3,h4,h5,h6',
      linkClass       : 'tocbot-link',
      activeLinkClass : 'tocbot-active-link',
      listClass       : 'tocbot-list',
      isCollapsedClass: 'tocbot-is-collapsed',
      collapsibleClass: 'tocbot-is-collapsible',
      collapseDepth   : CONFIG.toc.collapseDepth || 0,
      scrollSmooth    : true,
      headingsOffset  : -boardTop
    });
    if (toc.find('.toc-list-item').length > 0) {
      toc.css('visibility', 'visible');
    }
  });
</script>


  <script  src="https://lib.baomitu.com/prism/1.27.0/plugins/line-numbers/prism-line-numbers.min.js" ></script>

  <script src=https://lib.baomitu.com/clipboard.js/2.0.10/clipboard.min.js></script>

  <script>Fluid.plugins.codeWidget();</script>


  
<script>
  Fluid.utils.createScript('https://lib.baomitu.com/anchor-js/4.3.1/anchor.min.js', function() {
    window.anchors.options = {
      placement: CONFIG.anchorjs.placement,
      visible  : CONFIG.anchorjs.visible
    };
    if (CONFIG.anchorjs.icon) {
      window.anchors.options.icon = CONFIG.anchorjs.icon;
    }
    var el = (CONFIG.anchorjs.element || 'h1,h2,h3,h4,h5,h6').split(',');
    var res = [];
    for (var item of el) {
      res.push('.markdown-body > ' + item.trim());
    }
    if (CONFIG.anchorjs.placement === 'left') {
      window.anchors.options.class = 'anchorjs-link-left';
    }
    window.anchors.add(res.join(', '));
  });
</script>


  
<script>
  Fluid.utils.createScript('https://lib.baomitu.com/fancybox/3.5.7/jquery.fancybox.min.js', function() {
    Fluid.plugins.fancyBox();
  });
</script>


  <script>Fluid.plugins.imageCaption();</script>

  <script  src="/js/local-search.js" ></script>

  <script defer src="https://busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js" ></script>





<!-- 主题的启动项，将它保持在最底部 -->
<!-- the boot of the theme, keep it at the bottom -->
<script  src="/js/boot.js" ></script>


  

  <noscript>
    <div class="noscript-warning">博客在允许 JavaScript 运行的环境下浏览效果更佳</div>
  </noscript>
</body>
</html>
