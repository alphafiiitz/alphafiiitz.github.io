

<!DOCTYPE html>
<html lang="zh-CN" data-default-color-scheme=dark>



<head>
  <meta charset="UTF-8">
  <link rel="apple-touch-icon" sizes="76x76" href="/img/fitz.png">
  <link rel="icon" href="/img/fitz.png">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=5.0, shrink-to-fit=no">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  
  <meta name="theme-color" content="#2f4154">
  <meta name="author" content="alphafitz">
  <meta name="keywords" content="">
  
    <meta name="description" content="深入以太坊虚拟机 Part6 — Solidity 事件实现 原文：How Solidity Events Are Implemented — Diving Into The Ethereum VM Part 6 | by Howard | Jan 21, 2018  在上一部分中，我们了解了“方法”是如何建立在更简单的 EVM 原语（如“跳转”和“比较”指令）之上的抽象。 在本文中，我们将深入探">
<meta property="og:type" content="article">
<meta property="og:title" content="深入以太坊虚拟机 Part6 — Solidity 事件实现">
<meta property="og:url" content="https://alphafitz.com/2022/10/07/diving-into-the-ethereum-vm-part6-zh/index.html">
<meta property="og:site_name">
<meta property="og:description" content="深入以太坊虚拟机 Part6 — Solidity 事件实现 原文：How Solidity Events Are Implemented — Diving Into The Ethereum VM Part 6 | by Howard | Jan 21, 2018  在上一部分中，我们了解了“方法”是如何建立在更简单的 EVM 原语（如“跳转”和“比较”指令）之上的抽象。 在本文中，我们将深入探">
<meta property="og:locale" content="zh_CN">
<meta property="article:published_time" content="2022-10-07T08:39:57.000Z">
<meta property="article:modified_time" content="2022-10-17T04:06:25.671Z">
<meta property="article:author" content="alphafitz">
<meta property="article:tag" content="区块链技术">
<meta property="article:tag" content="智能合约开发">
<meta name="twitter:card" content="summary_large_image">
  
  
    <meta name="referrer" content="no-referrer-when-downgrade">
  
  
  <title>深入以太坊虚拟机 Part6 — Solidity 事件实现 - </title>

  <link  rel="stylesheet" href="https://lib.baomitu.com/twitter-bootstrap/4.6.1/css/bootstrap.min.css" />



  <link  rel="stylesheet" href="https://lib.baomitu.com/github-markdown-css/4.0.0/github-markdown.min.css" />

  <link  rel="stylesheet" href="https://lib.baomitu.com/hint.css/2.7.0/hint.min.css" />

  <link  rel="stylesheet" href="https://lib.baomitu.com/prism/1.27.0/plugins/line-numbers/prism-line-numbers.min.css" />

  <link  rel="stylesheet" href="https://lib.baomitu.com/fancybox/3.5.7/jquery.fancybox.min.css" />



<!-- 主题依赖的图标库，不要自行修改 -->
<!-- Do not modify the link that theme dependent icons -->

<link rel="stylesheet" href="//at.alicdn.com/t/font_1749284_hj8rtnfg7um.css">



<link rel="stylesheet" href="//at.alicdn.com/t/font_1736178_lbnruvf0jn.css">


<link  rel="stylesheet" href="/css/main.css" />


  <link id="highlight-css" rel="stylesheet" href="/css/highlight.css" />
  
    <link id="highlight-css-dark" rel="stylesheet" href="/css/highlight-dark.css" />
  




  <script id="fluid-configs">
    var Fluid = window.Fluid || {};
    Fluid.ctx = Object.assign({}, Fluid.ctx)
    var CONFIG = {"hostname":"alphafitz.com","root":"/","version":"1.9.2","typing":{"enable":true,"typeSpeed":70,"cursorChar":"_","loop":false,"scope":[]},"anchorjs":{"enable":true,"element":"h1,h2,h3,h4,h5,h6","placement":"left","visible":"hover","icon":""},"progressbar":{"enable":true,"height_px":3,"color":"#29d","options":{"showSpinner":false,"trickleSpeed":100}},"code_language":{"enable":true,"default":"TEXT"},"copy_btn":true,"image_caption":{"enable":true},"image_zoom":{"enable":true,"img_url_replace":["",""]},"toc":{"enable":true,"placement":"right","headingSelector":"h1,h2,h3,h4,h5,h6","collapseDepth":0},"lazyload":{"enable":true,"loading_img":"/img/loading.gif","onlypost":false,"offset_factor":2},"web_analytics":{"enable":true,"follow_dnt":false,"baidu":null,"google":null,"gtag":null,"tencent":{"sid":null,"cid":null},"woyaola":null,"cnzz":null,"leancloud":{"app_id":null,"app_key":null,"server_url":null,"path":"window.location.pathname","ignore_local":false}},"search_path":"/local-search.xml"};

    if (CONFIG.web_analytics.follow_dnt) {
      var dntVal = navigator.doNotTrack || window.doNotTrack || navigator.msDoNotTrack;
      Fluid.ctx.dnt = dntVal && (dntVal.startsWith('1') || dntVal.startsWith('yes') || dntVal.startsWith('on'));
    }
  </script>
  <script  src="/js/utils.js" ></script>
  <script  src="/js/color-schema.js" ></script>
  

  

  

  

  

  

  

  



  
<meta name="generator" content="Hexo 6.2.0"><link rel="alternate" href="/atom.xml" title="null" type="application/atom+xml">
</head>


<body>
  

  <header>
    

<div class="header-inner" style="height: 70vh;">
  <nav id="navbar" class="navbar fixed-top  navbar-expand-lg navbar-dark scrolling-navbar">
  <div class="container">
    <a class="navbar-brand" href="/">
      <strong>alphafitz</strong>
    </a>

    <button id="navbar-toggler-btn" class="navbar-toggler" type="button" data-toggle="collapse"
            data-target="#navbarSupportedContent"
            aria-controls="navbarSupportedContent" aria-expanded="false" aria-label="Toggle navigation">
      <div class="animated-icon"><span></span><span></span><span></span></div>
    </button>

    <!-- Collapsible content -->
    <div class="collapse navbar-collapse" id="navbarSupportedContent">
      <ul class="navbar-nav ml-auto text-center">
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/">
                <i class="iconfont icon-home-fill"></i>
                首页
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/archives/">
                <i class="iconfont icon-archive-fill"></i>
                归档
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/categories/">
                <i class="iconfont icon-category-fill"></i>
                分类
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/tags/">
                <i class="iconfont icon-tags-fill"></i>
                标签
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/about/">
                <i class="iconfont icon-user-fill"></i>
                关于
              </a>
            </li>
          
        
        
          <li class="nav-item" id="search-btn">
            <a class="nav-link" target="_self" href="javascript:;" data-toggle="modal" data-target="#modalSearch" aria-label="Search">
              &nbsp;<i class="iconfont icon-search"></i>&nbsp;
            </a>
          </li>
          
        
        
          <li class="nav-item" id="color-toggle-btn">
            <a class="nav-link" target="_self" href="javascript:;" aria-label="Color Toggle">&nbsp;<i
                class="iconfont icon-dark" id="color-toggle-icon"></i>&nbsp;</a>
          </li>
        
      </ul>
    </div>
  </div>
</nav>

  

<div id="banner" class="banner" parallax=true
     style="background: url('/img/default.png') no-repeat center center; background-size: cover;">
  <div class="full-bg-img">
    <div class="mask flex-center" style="background-color: rgba(0, 0, 0, 0.3)">
      <div class="banner-text text-center fade-in-up">
        <div class="h2">
          
            <span id="subtitle" data-typed-text="深入以太坊虚拟机 Part6 — Solidity 事件实现"></span>
          
        </div>

        
          
  <div class="mt-3">
    
    
      <span class="post-meta">
        <i class="iconfont icon-date-fill" aria-hidden="true"></i>
        <time datetime="2022-10-07 16:39" pubdate>
          2022年10月7日 下午
        </time>
      </span>
    
  </div>

  <div class="mt-1">
    
      <span class="post-meta mr-2">
        <i class="iconfont icon-chart"></i>
        
          13k 字
        
      </span>
    

    
      <span class="post-meta mr-2">
        <i class="iconfont icon-clock-fill"></i>
        
        
        
          109 分钟
        
      </span>
    

    
    
  </div>


        
      </div>

      
    </div>
  </div>
</div>

</div>

  </header>

  <main>
    
      

<div class="container-fluid nopadding-x">
  <div class="row nomargin-x">
    <div class="side-col d-none d-lg-block col-lg-2">
      

    </div>

    <div class="col-lg-8 nopadding-x-md">
      <div class="container nopadding-x-md" id="board-ctn">
        <div id="board">
          <article class="post-content mx-auto">
            <!-- SEO header -->
            <h1 style="display: none">深入以太坊虚拟机 Part6 — Solidity 事件实现</h1>
            
            
              <div class="markdown-body">
                
                <h1 id="深入以太坊虚拟机-Part6-—-Solidity-事件实现"><a href="#深入以太坊虚拟机-Part6-—-Solidity-事件实现" class="headerlink" title="深入以太坊虚拟机 Part6 — Solidity 事件实现"></a>深入以太坊虚拟机 Part6 — Solidity 事件实现</h1><blockquote>
<p>原文：<a target="_blank" rel="noopener" href="https://blog.qtum.org/how-solidity-events-are-implemented-diving-into-the-ethereum-vm-part-6-30e07b3037b9">How Solidity Events Are Implemented — Diving Into The Ethereum VM Part 6 | by Howard | Jan 21, 2018</a></p>
</blockquote>
<p>在上一部分中，我们了解了“方法”是如何建立在更简单的 EVM 原语（如“跳转”和“比较”指令）之上的抽象。</p>
<p>在本文中，我们将深入探讨 <a target="_blank" rel="noopener" href="https://docs.soliditylang.org/en/develop/contracts.html#events">Solidity Events</a>。总的来说，事件日志有三种主要用途：</p>
<ul>
<li>作为替代返回值，因为交易不记录方法的返回值。</li>
<li>作为一种更便宜的替代数据存储，只要合约不需要访问它。</li>
<li>最后，作为 DApp 客户端可以订阅的事件。</li>
</ul>
<p>事件日志是一个相对复杂的语言特性。但就像方法一样，它们映射到更简单的 EVM 日志原语。</p>
<p>通过了解事件是如何使用较低级别的 EVM 指令实现的，以及它们的成本，我们将获得更好的直觉来有效地使用事件。</p>
<p>如果你对前面的内容不熟悉，请阅读前面的文章：</p>
<ul>
<li><a href="http://alphafitz.com/2022/10/07/diving-into-the-ethereum-vm-part1-zh/">深入以太坊虚拟机 Part1 — 汇编与字节码</a></li>
<li><a href="http://alphafitz.com/2022/10/07/diving-into-the-ethereum-vm-part2-zh/">深入以太坊虚拟机 Part2 — 固定长度数据类型的表示</a></li>
<li><a href="http://alphafitz.com/2022/10/07/diving-into-the-ethereum-vm-part3-zh/">深入以太坊虚拟机 Part3 — 动态数据类型的表示</a></li>
<li><a href="http://alphafitz.com/2022/10/07/diving-into-the-ethereum-vm-part4-zh/">深入以太坊虚拟机 Part4 — 智能合约外部方法调用</a></li>
<li><a href="http://alphafitz.com/2022/10/07/diving-into-the-ethereum-vm-part5-zh/">深入以太坊虚拟机 Part5 — 智能合约创建过程</a></li>
</ul>
<h2 id="Solidity-Events"><a href="#Solidity-Events" class="headerlink" title="Solidity Events"></a>Solidity Events</h2><p>Solidity 事件如下所示：</p>
<figure><div class="code-wrapper"><pre class="line-numbers language-solidity" data-language="solidity"><code class="language-solidity"><span class="token keyword">event</span> <span class="token function">Deposit</span><span class="token punctuation">(</span>
	<span class="token builtin">address</span> <span class="token keyword">indexed</span> _from<span class="token punctuation">,</span>
	<span class="token builtin">bytes32</span> <span class="token keyword">indexed</span> _id<span class="token punctuation">,</span>
	<span class="token builtin">uint</span> _value
<span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre></div></figure>

<ul>
<li>它的名称为 <code>Deposit</code>​；</li>
<li>它具有三个不同类型的参数；</li>
<li>其中两种类型是 “indexed”；</li>
<li>一个参数不是 “indexed”。</li>
</ul>
<p>Solidity 事件有两个奇怪的限制：</p>
<ul>
<li>最多可以有 3 个索引参数；</li>
<li>如果索引参数的类型大于 32 字节（比如 string 和 bytes），则不存储实际数据，而是存储数据的 KECCAK256 摘要。</li>
</ul>
<p>为什么会这样？索引参数和非索引参数有什么区别？</p>
<h2 id="EVM-Log-Primitives"><a href="#EVM-Log-Primitives" class="headerlink" title="EVM Log Primitives"></a>EVM Log Primitives</h2><p>要开始了解 Solidity 事件的这些怪癖和限制，让我们看一下 <code>log0</code>​、<code>log1</code>​、…、<code>log4</code>​ EVM 指令。</p>
<p>EVM 日志工具使用与 Solidity 不同的术语：</p>
<ul>
<li>“topics”：最多可以有 4 个主题(topic)。每个主题正好是 32 个字节。</li>
<li>“data”：数据是事件的有效负载(payload)。它可以是任意数量的字节。</li>
</ul>
<p>Solidity 事件如何映射到日志原语？</p>
<ul>
<li>事件的所有“非索引参数”都存储为数据。</li>
<li>事件的每个“索引参数”都存储为一个 32 字节的主题。</li>
</ul>
<p>由于 string 和 bytes 可能超过 32 个字节，如果它们被索引，Solidity 将存储 KECCAK256 摘要而不是实际数据。</p>
<p>Solidity 最多允许拥有 3 个索引参数，但 EVM 最多允许拥有 4 个主题。事实证明，Solidity 将一个主题用作事件的签名。</p>
<h2 id="The-log0-Primitive"><a href="#The-log0-Primitive" class="headerlink" title="The log0 Primitive"></a>The log0 Primitive</h2><p>最简单的日志原语是 <code>log0</code>​。这将创建一个只有数据但没有主题的日志项。日志的数据可以是任意字节数。</p>
<p>我们可以在 Solidity 中直接使用 <code>log0</code>​。在本例中，我们将存储一个 32 字节的数字：</p>
<figure><div class="code-wrapper"><pre class="line-numbers language-solidity" data-language="solidity"><code class="language-solidity"><span class="token keyword">pragma</span> <span class="token keyword">solidity</span> <span class="token operator">^</span><span class="token version number">0.4.18</span><span class="token punctuation">;</span>

<span class="token keyword">contract</span> <span class="token class-name">Logger</span> <span class="token punctuation">&#123;</span>
	<span class="token keyword">function</span> <span class="token function">Logger</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">public</span> <span class="token punctuation">&#123;</span>
		<span class="token function">log0</span><span class="token punctuation">(</span><span class="token number">0xc0fefe</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></div></figure>

<p>生成的汇编可以分为两半。前半部分将日志数据（<code>0xc0fefe</code>​）从堆栈复制到内存中。后半部分将 <code>log0</code>​ 指令的参数放在堆栈上，告诉它在内存中加载数据的位置。</p>
<p>带注释的汇编：</p>
<figure><div class="code-wrapper"><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">memory: <span class="token punctuation">&#123;</span> 0x40 <span class="token operator">=</span><span class="token operator">></span> 0x60 <span class="token punctuation">&#125;</span>

tag_1:
  // copy data into memory
  0xc0fefe
    <span class="token punctuation">[</span>0xc0fefe<span class="token punctuation">]</span>
  mload<span class="token punctuation">(</span>0x40<span class="token punctuation">)</span>
    <span class="token punctuation">[</span>0x60 0xc0fefe<span class="token punctuation">]</span>
  swap1
    <span class="token punctuation">[</span>0xc0fefe 0x60<span class="token punctuation">]</span>
  dup2
    <span class="token punctuation">[</span>0x60 0xc0fefe 0x60<span class="token punctuation">]</span>
  mstore
    <span class="token punctuation">[</span>0x60<span class="token punctuation">]</span>
    memory: <span class="token punctuation">&#123;</span>
      0x40 <span class="token operator">=</span><span class="token operator">></span> 0x60
      0x60 <span class="token operator">=</span><span class="token operator">></span> 0xc0fefe
    <span class="token punctuation">&#125;</span>

// calculate data start position and size
  0x20
    <span class="token punctuation">[</span>0x20 0x60<span class="token punctuation">]</span>
  <span class="token function">add</span>
    <span class="token punctuation">[</span>0x80<span class="token punctuation">]</span>
  mload<span class="token punctuation">(</span>0x40<span class="token punctuation">)</span>
    <span class="token punctuation">[</span>0x60 0x80<span class="token punctuation">]</span>
  dup1
    <span class="token punctuation">[</span>0x60 0x60 0x80<span class="token punctuation">]</span>
  swap2
    <span class="token punctuation">[</span>0x60 0x80 0x60<span class="token punctuation">]</span>
  sub
    <span class="token punctuation">[</span>0x20 0x60<span class="token punctuation">]</span>
  swap1
    <span class="token punctuation">[</span>0x60 0x20<span class="token punctuation">]</span>

log0<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></div></figure>

<p>就在执行 <code>log0</code>​ 之前，堆栈上有两个参数：<code>[0x60 0x20]</code>​。</p>
<ul>
<li><code>start</code>​：0x60 是内存中加载数据的位置。</li>
<li><code>size</code>​：0x20（或32）指定要加载的数据的字节数。</li>
</ul>
<p><code>log0</code>​ 的 go-ethereum 实现如下：</p>
<figure><div class="code-wrapper"><pre class="line-numbers language-go" data-language="go"><code class="language-go"><span class="token keyword">func</span> <span class="token function">log0</span><span class="token punctuation">(</span>pc <span class="token operator">*</span><span class="token builtin">uint64</span><span class="token punctuation">,</span> evm <span class="token operator">*</span>EVM<span class="token punctuation">,</span> contract <span class="token operator">*</span>Contract<span class="token punctuation">,</span> memory <span class="token operator">*</span>Memory<span class="token punctuation">,</span> stack <span class="token operator">*</span>Stack<span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token builtin">byte</span><span class="token punctuation">,</span> <span class="token builtin">error</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
	mStart<span class="token punctuation">,</span> mSize <span class="token operator">:=</span> stack<span class="token punctuation">.</span><span class="token function">pop</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> stack<span class="token punctuation">.</span><span class="token function">pop</span><span class="token punctuation">(</span><span class="token punctuation">)</span>

	data <span class="token operator">:=</span> memory<span class="token punctuation">.</span><span class="token function">Get</span><span class="token punctuation">(</span>mStart<span class="token punctuation">.</span><span class="token function">Int64</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> mSize<span class="token punctuation">.</span><span class="token function">Int64</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>

	evm<span class="token punctuation">.</span>StateDB<span class="token punctuation">.</span><span class="token function">AddLog</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>types<span class="token punctuation">.</span>Log<span class="token punctuation">&#123;</span>
		Address<span class="token punctuation">:</span> contract<span class="token punctuation">.</span><span class="token function">Address</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
		Data<span class="token punctuation">:</span>    data<span class="token punctuation">,</span>
		<span class="token comment">// This is a non-consensus field, but assigned here because</span>
		<span class="token comment">// core/state doesn't know the current block number.</span>
		BlockNumber<span class="token punctuation">:</span> evm<span class="token punctuation">.</span>BlockNumber<span class="token punctuation">.</span><span class="token function">Uint64</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
	<span class="token punctuation">&#125;</span><span class="token punctuation">)</span>

	evm<span class="token punctuation">.</span>interpreter<span class="token punctuation">.</span>intPool<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span>mStart<span class="token punctuation">,</span> mSize<span class="token punctuation">)</span>
	<span class="token keyword">return</span> <span class="token boolean">nil</span><span class="token punctuation">,</span> <span class="token boolean">nil</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></div></figure>

<p>您可以在这段代码中看到 <code>log0</code>​ 从堆栈中弹出两个参数，然后从内存中复制数据。然后它调用 <code>StateDB.AddLog</code>​ 将日志与合约关联起来。</p>
<h2 id="Logging-With-Topics"><a href="#Logging-With-Topics" class="headerlink" title="Logging With Topics"></a>Logging With Topics</h2><p>主题是 32 字节的任意数据。以太坊实现将使用这些主题来索引日志，以实现高效的事件日志查询和过滤。</p>
<p>这个例子使用 <code>log2</code>​ 原语。第一个参数是数据（任意字节数），后跟 2 个主题（32 字节）：</p>
<figure><div class="code-wrapper"><pre class="line-numbers language-solidity" data-language="solidity"><code class="language-solidity"><span class="token comment">// log-2.sol</span>
<span class="token keyword">pragma</span> <span class="token keyword">solidity</span> <span class="token operator">^</span><span class="token version number">0.4.18</span><span class="token punctuation">;</span>

<span class="token keyword">contract</span> <span class="token class-name">Logger</span> <span class="token punctuation">&#123;</span>
	<span class="token keyword">function</span> <span class="token function">Logger</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">public</span> <span class="token punctuation">&#123;</span>
		<span class="token function">log2</span><span class="token punctuation">(</span><span class="token number">0xc0fefe</span><span class="token punctuation">,</span> <span class="token number">0xaaaa1111</span><span class="token punctuation">,</span> <span class="token number">0xbbbb2222</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></div></figure>

<p>汇编非常相似。唯一的区别是两个主题（<code>0xbbbb2222</code>​, <code>0xaaaa1111</code>​）在一开始就被压入堆栈：</p>
<figure><div class="code-wrapper"><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">tag_1:
  // push topics
  0xbbbb2222
  0xaaaa1111

// copy data into memory
  0xc0fefe
  mload<span class="token punctuation">(</span>0x40<span class="token punctuation">)</span>
  swap1
  dup2
  mstore
  0x20
  <span class="token function">add</span>
  mload<span class="token punctuation">(</span>0x40<span class="token punctuation">)</span>
  dup1
  swap2
  sub
  swap1

// create log
  log2<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></div></figure>

<p>数据还是 <code>0xc0fefe</code>​，复制到内存。在执行 <code>log2</code>​ 之前，EVM 的状态如下所示：</p>
<figure><div class="code-wrapper"><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">stack: <span class="token punctuation">[</span>0x60 0x20 0xaaaa1111 0xbbbb2222<span class="token punctuation">]</span>
memory: <span class="token punctuation">&#123;</span>
  0x60: 0xc0fefe
<span class="token punctuation">&#125;</span>

log2<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></div></figure>

<p>前两个参数指定用作日志数据的内存区域。两个额外的堆栈参数是两个 32 字节的主题。</p>
<h2 id="All-EVM-Logging-Primitives"><a href="#All-EVM-Logging-Primitives" class="headerlink" title="All EVM Logging Primitives"></a>All EVM Logging Primitives</h2><p>EVM 支持 5 个日志原语：</p>
<figure><div class="code-wrapper"><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">0xa0 LOG0
0xa1 LOG1
0xa2 LOG2
0xa3 LOG3
0xa4 LOG4<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre></div></figure>

<p>除了使用的主题数量外，它们都是相同的。 go-ethereum 实现实际上使用相同的代码生成这些指令，只是大小不同，它指定要从堆栈中弹出的主题数。</p>
<figure><div class="code-wrapper"><pre class="line-numbers language-go" data-language="go"><code class="language-go"><span class="token keyword">func</span> <span class="token function">makeLog</span><span class="token punctuation">(</span>size <span class="token builtin">int</span><span class="token punctuation">)</span> executionFunc <span class="token punctuation">&#123;</span>
	<span class="token keyword">return</span> <span class="token keyword">func</span><span class="token punctuation">(</span>pc <span class="token operator">*</span><span class="token builtin">uint64</span><span class="token punctuation">,</span> evm <span class="token operator">*</span>EVM<span class="token punctuation">,</span> contract <span class="token operator">*</span>Contract<span class="token punctuation">,</span> memory <span class="token operator">*</span>Memory<span class="token punctuation">,</span> stack <span class="token operator">*</span>Stack<span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token builtin">byte</span><span class="token punctuation">,</span> <span class="token builtin">error</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
		topics <span class="token operator">:=</span> <span class="token function">make</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token punctuation">]</span>common<span class="token punctuation">.</span>Hash<span class="token punctuation">,</span> size<span class="token punctuation">)</span>
		mStart<span class="token punctuation">,</span> mSize <span class="token operator">:=</span> stack<span class="token punctuation">.</span><span class="token function">pop</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> stack<span class="token punctuation">.</span><span class="token function">pop</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
		<span class="token keyword">for</span> i <span class="token operator">:=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> size<span class="token punctuation">;</span> i<span class="token operator">++</span> <span class="token punctuation">&#123;</span>
			topics<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token operator">=</span> common<span class="token punctuation">.</span><span class="token function">BigToHash</span><span class="token punctuation">(</span>stack<span class="token punctuation">.</span><span class="token function">pop</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
		<span class="token punctuation">&#125;</span>

		d <span class="token operator">:=</span> memory<span class="token punctuation">.</span><span class="token function">Get</span><span class="token punctuation">(</span>mStart<span class="token punctuation">.</span><span class="token function">Int64</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> mSize<span class="token punctuation">.</span><span class="token function">Int64</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
		evm<span class="token punctuation">.</span>StateDB<span class="token punctuation">.</span><span class="token function">AddLog</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>types<span class="token punctuation">.</span>Log<span class="token punctuation">&#123;</span>
			Address<span class="token punctuation">:</span> contract<span class="token punctuation">.</span><span class="token function">Address</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
			Topics<span class="token punctuation">:</span>  topics<span class="token punctuation">,</span>
			Data<span class="token punctuation">:</span>    d<span class="token punctuation">,</span>
			<span class="token comment">// This is a non-consensus field, but assigned here because</span>
			<span class="token comment">// core/state doesn't know the current block number.</span>
			BlockNumber<span class="token punctuation">:</span> evm<span class="token punctuation">.</span>BlockNumber<span class="token punctuation">.</span><span class="token function">Uint64</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
		<span class="token punctuation">&#125;</span><span class="token punctuation">)</span>

		evm<span class="token punctuation">.</span>interpreter<span class="token punctuation">.</span>intPool<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span>mStart<span class="token punctuation">,</span> mSize<span class="token punctuation">)</span>
		<span class="token keyword">return</span> <span class="token boolean">nil</span><span class="token punctuation">,</span> <span class="token boolean">nil</span>
	<span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></div></figure>

<p>随意看一下 sourcegraph 上的代码：<a target="_blank" rel="noopener" href="https://sourcegraph.com/github.com/ethereum/go-ethereum@83d16574444d0b389755c9003e74a90d2ab7ca2e/-/blob/core/vm/instructions.go#L744">https:&#x2F;&#x2F;sourcegraph.com&#x2F;github.com&#x2F;ethereum&#x2F;go-ethereum@83d16574444d0b389755c9003e74a90d2ab7ca2e&#x2F;-&#x2F;blob&#x2F;core&#x2F;vm&#x2F;instructions.go#L744</a></p>
<h2 id="Logging-Testnet-Demo"><a href="#Logging-Testnet-Demo" class="headerlink" title="Logging Testnet Demo"></a>Logging Testnet Demo</h2><p>让我们尝试使用已部署的合约生成一些日志。合约记录 5 次，使用不同的数据和主题：</p>
<figure><div class="code-wrapper"><pre class="line-numbers language-solidity" data-language="solidity"><code class="language-solidity"><span class="token keyword">pragma</span> <span class="token keyword">solidity</span> <span class="token operator">^</span><span class="token version number">0.4.18</span><span class="token punctuation">;</span>

<span class="token keyword">contract</span> <span class="token class-name">Logger</span> <span class="token punctuation">&#123;</span>
	<span class="token keyword">function</span> <span class="token function">Logger</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">public</span> <span class="token punctuation">&#123;</span>
		<span class="token function">log0</span><span class="token punctuation">(</span><span class="token number">0x0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token function">log1</span><span class="token punctuation">(</span><span class="token number">0x1</span><span class="token punctuation">,</span> <span class="token number">0xa</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token function">log2</span><span class="token punctuation">(</span><span class="token number">0x2</span><span class="token punctuation">,</span> <span class="token number">0xa</span><span class="token punctuation">,</span> <span class="token number">0xb</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token function">log3</span><span class="token punctuation">(</span><span class="token number">0x3</span><span class="token punctuation">,</span> <span class="token number">0xa</span><span class="token punctuation">,</span> <span class="token number">0xb</span><span class="token punctuation">,</span> <span class="token number">0xc</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token function">log4</span><span class="token punctuation">(</span><span class="token number">0x4</span><span class="token punctuation">,</span> <span class="token number">0xa</span><span class="token punctuation">,</span> <span class="token number">0xb</span><span class="token punctuation">,</span> <span class="token number">0xc</span><span class="token punctuation">,</span> <span class="token number">0xd</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></div></figure>

<p>该合约部署在 Rinkeby 测试网络上。创建此合约的交易是：<a target="_blank" rel="noopener" href="https://rinkeby.etherscan.io/tx/0x0e88c5281bb38290ae2e9cd8588cd979bc92755605021e78550fbc4d130053d1">https://rinkeby.etherscan.io/tx/0x0e88c5281bb38290ae2e9cd8588cd979bc92755605021e78550fbc4d130053d1</a></p>
<p>单击“Event Logs”选项，您应该会看到 5 个日志项的原始数据。</p>
<p>主题都是 32 字节。我们记录为数据的数字被编码为 32 字节的数字。</p>
<h2 id="Querying-For-The-Logs"><a href="#Querying-For-The-Logs" class="headerlink" title="Querying For The Logs"></a>Querying For The Logs</h2><p>让我们使用以太坊的 JSON RPC 来查询这些日志。以太坊 API 节点将创建索引，以便通过匹配主题来高效查找日志，或查找由合约地址生成的日志。</p>
<p>我们将使用 <a target="_blank" rel="noopener" href="https://infura.io/">infura.io</a> 提供的托管 RPC 节点。您可以通过注册免费帐户来获取 API 密钥。</p>
<p>获得密钥后，设置 shell 变量 <code>INFURA_KEY</code>​ 以使以下 curl 示例正常工作：</p>
<p>举个简单的例子，让我们调用 <a target="_blank" rel="noopener" href="https://github.com/ethereum/wiki/wiki/JSON-RPC#eth_getlogs">eth_getLogs</a> 来获取与合约相关的所有日志：</p>
<figure><div class="code-wrapper"><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token function">curl</span> <span class="token string">"https://rinkeby.infura.io/<span class="token variable">$INFURA_KEY</span>"</span> <span class="token punctuation">\</span>
  -X POST <span class="token punctuation">\</span>
  -H <span class="token string">"Content-Type: application/json"</span> <span class="token punctuation">\</span>
  --data <span class="token string">'
&#123;
  "jsonrpc": "2.0",
  "id": 1,
  "method": "eth_getLogs",
  "params": [&#123;
    "fromBlock": "0x0",
    "address": "0x507e86b11541bcb1f3fe200b2f10ed8fd9413bd0"
  &#125;]
&#125;
'</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></div></figure>

<ul>
<li><code>fromBlock</code>​：从哪个块开始寻找日志。默认情况下，它开始查看区块链的顶端。我们想要所有的日志，所以我们从第一个块开始。</li>
<li><code>address</code>​：日志是通过合约地址来索引的，所以这实际上是非常有效的。</li>
</ul>
<p>输出是 etherscan 为“Event Logs”选项显示的基础数据。查看完整输出：<a target="_blank" rel="noopener" href="https://gist.github.com/hayeah/fbc862a87534bc45e77eddea9d779847">evmlog.json</a>。</p>
<p>JSON API 返回的日志项如下所示：</p>
<figure><div class="code-wrapper"><pre class="line-numbers language-json" data-language="json"><code class="language-json"><span class="token punctuation">&#123;</span>
	<span class="token property">"address"</span><span class="token operator">:</span> <span class="token string">"0x507e86b11541bcb1f3fe200b2f10ed8fd9413bd0"</span><span class="token punctuation">,</span>
	<span class="token property">"topics"</span><span class="token operator">:</span> <span class="token punctuation">[</span>
		<span class="token string">"0x000000000000000000000000000000000000000000000000000000000000000a"</span>
	<span class="token punctuation">]</span><span class="token punctuation">,</span>
	<span class="token property">"data"</span><span class="token operator">:</span> <span class="token string">"0x0000000000000000000000000000000000000000000000000000000000000001"</span><span class="token punctuation">,</span>
	<span class="token property">"blockNumber"</span><span class="token operator">:</span> <span class="token string">"0x179097"</span><span class="token punctuation">,</span>
	<span class="token property">"transactionHash"</span><span class="token operator">:</span> <span class="token string">"0x0e88c5281bb38290ae2e9cd8588cd979bc92755605021e78550fbc4d130053d1"</span><span class="token punctuation">,</span>
	<span class="token property">"transactionIndex"</span><span class="token operator">:</span> <span class="token string">"0x1"</span><span class="token punctuation">,</span>
	<span class="token property">"blockHash"</span><span class="token operator">:</span> <span class="token string">"0x541bb92d8de24cad637717cdc43ae5e66d9d6193b9f964fbb6461f6727eb9e57"</span><span class="token punctuation">,</span>
	<span class="token property">"logIndex"</span><span class="token operator">:</span> <span class="token string">"0x2"</span><span class="token punctuation">,</span>
	<span class="token property">"removed"</span><span class="token operator">:</span> <span class="token boolean">false</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></div></figure>

<p>接下来，我们可以查询匹配主题“0xc”的日志：</p>
<figure><div class="code-wrapper"><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token function">curl</span> <span class="token string">"https://rinkeby.infura.io/<span class="token variable">$INFURA_KEY</span>"</span> <span class="token punctuation">\</span>
  -X POST <span class="token punctuation">\</span>
  -H <span class="token string">"Content-Type: application/json"</span> <span class="token punctuation">\</span>
  --data <span class="token string">'
&#123;
  "jsonrpc": "2.0",
  "id": 1,
  "method": "eth_getLogs",
  "params": [&#123;
    "fromBlock": "0x179097",
    "toBlock": "0x179097",
    "address": "0x507e86b11541bcb1f3fe200b2f10ed8fd9413bd0",
    "topics": [null, null, "0x000000000000000000000000000000000000000000000000000000000000000c"]
  &#125;]
&#125;
'</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></div></figure>

<ul>
<li><code>topics</code>​：要匹配的主题数组。<code>null</code>​ 匹配任何东西。见<a target="_blank" rel="noopener" href="https://github.com/ethereum/wiki/wiki/JSON-RPC#parameters-38">详细说明</a>。</li>
</ul>
<p>应该有两个匹配的日志：</p>
<figure><div class="code-wrapper"><pre class="line-numbers language-json" data-language="json"><code class="language-json"><span class="token punctuation">&#123;</span>
    <span class="token property">"address"</span><span class="token operator">:</span> <span class="token string">"0x507e86b11541bcb1f3fe200b2f10ed8fd9413bd0"</span><span class="token punctuation">,</span>
    <span class="token property">"topics"</span><span class="token operator">:</span> <span class="token punctuation">[</span>
        <span class="token string">"0x000000000000000000000000000000000000000000000000000000000000000a"</span><span class="token punctuation">,</span>
        <span class="token string">"0x000000000000000000000000000000000000000000000000000000000000000b"</span><span class="token punctuation">,</span>
        <span class="token string">"0x000000000000000000000000000000000000000000000000000000000000000c"</span>
    <span class="token punctuation">]</span><span class="token punctuation">,</span>
    <span class="token property">"data"</span><span class="token operator">:</span> <span class="token string">"0x0000000000000000000000000000000000000000000000000000000000000003"</span><span class="token punctuation">,</span>
    <span class="token property">"blockNumber"</span><span class="token operator">:</span> <span class="token string">"0x179097"</span><span class="token punctuation">,</span>
    <span class="token property">"transactionHash"</span><span class="token operator">:</span> <span class="token string">"0x0e88c5281bb38290ae2e9cd8588cd979bc92755605021e78550fbc4d130053d1"</span><span class="token punctuation">,</span>
    <span class="token property">"transactionIndex"</span><span class="token operator">:</span> <span class="token string">"0x1"</span><span class="token punctuation">,</span>
    <span class="token property">"blockHash"</span><span class="token operator">:</span> <span class="token string">"0x541bb92d8de24cad637717cdc43ae5e66d9d6193b9f964fbb6461f6727eb9e57"</span><span class="token punctuation">,</span>
    <span class="token property">"logIndex"</span><span class="token operator">:</span> <span class="token string">"0x4"</span><span class="token punctuation">,</span>
    <span class="token property">"removed"</span><span class="token operator">:</span> <span class="token boolean">false</span>
<span class="token punctuation">&#125;</span><span class="token punctuation">,</span>
<span class="token punctuation">&#123;</span>
    <span class="token property">"address"</span><span class="token operator">:</span> <span class="token string">"0x507e86b11541bcb1f3fe200b2f10ed8fd9413bd0"</span><span class="token punctuation">,</span>
    <span class="token property">"topics"</span><span class="token operator">:</span> <span class="token punctuation">[</span>
        <span class="token string">"0x000000000000000000000000000000000000000000000000000000000000000a"</span><span class="token punctuation">,</span>
        <span class="token string">"0x000000000000000000000000000000000000000000000000000000000000000b"</span><span class="token punctuation">,</span>
        <span class="token string">"0x000000000000000000000000000000000000000000000000000000000000000c"</span><span class="token punctuation">,</span>
        <span class="token string">"0x000000000000000000000000000000000000000000000000000000000000000d"</span>
    <span class="token punctuation">]</span><span class="token punctuation">,</span>
    <span class="token property">"data"</span><span class="token operator">:</span> <span class="token string">"0x0000000000000000000000000000000000000000000000000000000000000004"</span><span class="token punctuation">,</span>
    <span class="token property">"blockNumber"</span><span class="token operator">:</span> <span class="token string">"0x179097"</span><span class="token punctuation">,</span>
    <span class="token property">"transactionHash"</span><span class="token operator">:</span> <span class="token string">"0x0e88c5281bb38290ae2e9cd8588cd979bc92755605021e78550fbc4d130053d1"</span><span class="token punctuation">,</span>
    <span class="token property">"transactionIndex"</span><span class="token operator">:</span> <span class="token string">"0x1"</span><span class="token punctuation">,</span>
    <span class="token property">"blockHash"</span><span class="token operator">:</span> <span class="token string">"0x541bb92d8de24cad637717cdc43ae5e66d9d6193b9f964fbb6461f6727eb9e57"</span><span class="token punctuation">,</span>
    <span class="token property">"logIndex"</span><span class="token operator">:</span> <span class="token string">"0x5"</span><span class="token punctuation">,</span>
    <span class="token property">"removed"</span><span class="token operator">:</span> <span class="token boolean">false</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></div></figure>

<h2 id="Logging-Gas-Costs"><a href="#Logging-Gas-Costs" class="headerlink" title="Logging Gas Costs"></a>Logging Gas Costs</h2><p>日志原语的 gas 费用取决于您拥有多少主题以及您记录了多少数据：</p>
<figure><div class="code-wrapper"><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">// Per byte <span class="token keyword">in</span> a LOG operation's data
LogDataGas       uint64 <span class="token operator">=</span> <span class="token number">8</span>
// Per LOG 
topicLogTopicGas uint64 <span class="token operator">=</span> <span class="token number">375</span>   
// Per LOG operation.
LogGas           uint64 <span class="token operator">=</span> <span class="token number">375</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></div></figure>

<p>这些常量在 <a target="_blank" rel="noopener" href="https://github.com/ethereum/go-ethereum/blob/a139041d409d0ffaf81c7cf931c6b24299a05705/params/protocol_params.go#L25">protocol_params</a> 中定义。</p>
<p>不要忘记使用的内存，即每字节 3 gas：</p>
<figure><div class="code-wrapper"><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">MemoryGas        uint64 <span class="token operator">=</span> <span class="token number">3</span>  <span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre></div></figure>

<p>等什么？每字节日志数据只花费 8 gas？也就是说 32 个字节需要 256 个 gas，内存使用需要 96 个 gas。因此，322 gas 与 20000 gas 存储相同数量的数据，成本仅为 1.7%！</p>
<p>但是等一下，如果你将日志数据作为 calldata 传递给交易，你也需要为交易数据付费。 calldata 的 gas 成本为：</p>
<figure><div class="code-wrapper"><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">TxDataZeroGas      uint64 <span class="token operator">=</span> <span class="token number">4</span>     // zero tx data abyte
TxDataNonZeroGas   uint64 <span class="token operator">=</span> <span class="token number">68</span>    // non-zero tx data byte<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre></div></figure>

<p>假设所有 32 个字节都不为零，这仍然比存储便宜很多：</p>
<figure><div class="code-wrapper"><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">// cost of <span class="token number">32</span> bytes of log data
<span class="token number">32</span> * <span class="token number">68</span> <span class="token operator">=</span> <span class="token number">2176</span> // tx data cost
<span class="token number">32</span> * <span class="token number">8</span> <span class="token operator">=</span> <span class="token number">256</span> // log data cost
<span class="token number">32</span> * <span class="token number">3</span> <span class="token operator">=</span> <span class="token number">96</span> // memory usage cost
<span class="token number">375</span> // log call cost
----
total <span class="token punctuation">(</span><span class="token number">2176</span> + <span class="token number">256</span> + <span class="token number">96</span> + <span class="token number">375</span><span class="token punctuation">)</span>

~14% of sstore <span class="token keyword">for</span> <span class="token number">32</span> bytes<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></div></figure>

<p>大部分 gas 费用实际上都花在了交易数据上，而不是日志操作本身。</p>
<p>日志操作便宜的原因是日志数据并没有真正存储在区块链中。原则上，日志可以根据需要即时重新计算。尤其是矿工，可以简单地丢弃日志数据，因为未来的计算无论如何都无法访问过去的日志。</p>
<p>整个网络不承担日志成本。只有 API 服务节点需要实际处理、存储和索引日志。</p>
<p>所以日志的成本结构只是防止日志垃圾邮件(spamming)的最小成本。</p>
<h2 id="Solidity-Events-1"><a href="#Solidity-Events-1" class="headerlink" title="Solidity Events"></a>Solidity Events</h2><p>了解了日志原语是如何工作的，Solidity 事件就很简单了。</p>
<p>让我们看一下采用 3 个 uint256 参数（非索引）的 <code>Log</code>​ 事件类型：</p>
<figure><div class="code-wrapper"><pre class="line-numbers language-solidity" data-language="solidity"><code class="language-solidity"><span class="token keyword">pragma</span> <span class="token keyword">solidity</span> <span class="token operator">^</span><span class="token version number">0.4.18</span><span class="token punctuation">;</span>

<span class="token keyword">contract</span> <span class="token class-name">Logger</span> <span class="token punctuation">&#123;</span>
	<span class="token keyword">event</span> <span class="token function">Log</span><span class="token punctuation">(</span><span class="token builtin">uint256</span> a<span class="token punctuation">,</span> <span class="token builtin">uint256</span> b<span class="token punctuation">,</span> <span class="token builtin">uint256</span> c<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token keyword">function</span> <span class="token function">log</span><span class="token punctuation">(</span><span class="token builtin">uint256</span> a<span class="token punctuation">,</span> <span class="token builtin">uint256</span> b<span class="token punctuation">,</span> <span class="token builtin">uint256</span> c<span class="token punctuation">)</span> <span class="token keyword">public</span> <span class="token punctuation">&#123;</span>
		<span class="token function">Log</span><span class="token punctuation">(</span>a<span class="token punctuation">,</span> b<span class="token punctuation">,</span> c<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></div></figure>

<p>与其查看汇编代码，不如查看生成的原始日志。</p>
<p>这是一个调用 <code>log(1, 2, 3)</code>​ 的交易：<a target="_blank" rel="noopener" href="https://rinkeby.etherscan.io/tx/0x9d3d394867330ae75d7153def724d062b474b0feb1f824fe1ff79e772393d395">https://rinkeby.etherscan.io/tx/0x9d3d394867330ae75d7153def724d062b474b0feb1f824fe1ff79e772393d395</a></p>
<p>日志数据中的 data 是事件参数，ABI 编码：</p>
<figure><div class="code-wrapper"><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">0000000000000000000000000000000000000000000000000000000000000001
0000000000000000000000000000000000000000000000000000000000000002
0000000000000000000000000000000000000000000000000000000000000003<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre></div></figure>

<p>只有一个 topic，一个神秘的 32 字节哈希：</p>
<figure><div class="code-wrapper"><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">0x00032a912636b05d31af43f00b91359ddcfddebcffa7c15470a13ba1992e10f0<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre></div></figure>

<p>这是事件类型签名的 SHA3 哈希：</p>
<figure><div class="code-wrapper"><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token comment"># Install pyethereum </span>
<span class="token comment"># https://github.com/ethereum/pyethereum/#installation</span>
<span class="token operator">></span> from ethereum.utils <span class="token function">import</span> sha3
<span class="token operator">></span> sha3<span class="token punctuation">(</span><span class="token string">"Log(uint256,uint256,uint256)"</span><span class="token punctuation">)</span>.hex<span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token string">'00032a912636b05d31af43f00b91359ddcfddebcffa7c15470a13ba1992e10f0'</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre></div></figure>

<p>这与方法调用的 ABI 编码的工作方式非常相似。</p>
<p>因为 Solidity 事件使用一个主题作为事件签名，所以索引参数只剩下 3 个主题。</p>
<h2 id="Solidity-Event-With-Indexed-Arguments"><a href="#Solidity-Event-With-Indexed-Arguments" class="headerlink" title="Solidity Event With Indexed Arguments"></a>Solidity Event With Indexed Arguments</h2><p>让我们看一个具有一个 indexed <code>uint256</code>​ 参数的事件：</p>
<figure><div class="code-wrapper"><pre class="line-numbers language-solidity" data-language="solidity"><code class="language-solidity"><span class="token keyword">pragma</span> <span class="token keyword">solidity</span> <span class="token operator">^</span><span class="token version number">0.4.18</span><span class="token punctuation">;</span>

<span class="token keyword">contract</span> <span class="token class-name">Logger</span> <span class="token punctuation">&#123;</span>
	<span class="token keyword">event</span> <span class="token function">Log</span><span class="token punctuation">(</span><span class="token builtin">uint256</span> a<span class="token punctuation">,</span> <span class="token builtin">uint256</span> <span class="token keyword">indexed</span> b<span class="token punctuation">,</span> <span class="token builtin">uint256</span> c<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token keyword">function</span> <span class="token function">log</span><span class="token punctuation">(</span><span class="token builtin">uint256</span> a<span class="token punctuation">,</span> <span class="token builtin">uint256</span> b<span class="token punctuation">,</span> <span class="token builtin">uint256</span> c<span class="token punctuation">)</span> <span class="token keyword">public</span> <span class="token punctuation">&#123;</span>
		<span class="token function">Log</span><span class="token punctuation">(</span>a<span class="token punctuation">,</span> b<span class="token punctuation">,</span> c<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></div></figure>

<p>生成的事件日志中现在有两个 topic：</p>
<figure><div class="code-wrapper"><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">0x00032a912636b05d31af43f00b91359ddcfddebcffa7c15470a13ba1992e10f0
0x0000000000000000000000000000000000000000000000000000000000000002<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre></div></figure>

<ul>
<li>第一个主题是事件类型签名，哈希后的。</li>
<li>第二个主题是索引参数，原值。</li>
</ul>
<p>数据是 ABI 编码的事件参数，不包括索引参数(indexed parameters)：</p>
<figure><div class="code-wrapper"><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">0000000000000000000000000000000000000000000000000000000000000001
0000000000000000000000000000000000000000000000000000000000000003<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre></div></figure>

<h2 id="String-x2F-Bytes-Event-Parameter"><a href="#String-x2F-Bytes-Event-Parameter" class="headerlink" title="String&#x2F;Bytes Event Parameter"></a>String&#x2F;Bytes Event Parameter</h2><p>现在让我们将事件参数更改为字符串：</p>
<figure><div class="code-wrapper"><pre class="line-numbers language-solidity" data-language="solidity"><code class="language-solidity"><span class="token keyword">pragma</span> <span class="token keyword">solidity</span> <span class="token operator">^</span><span class="token version number">0.4.18</span><span class="token punctuation">;</span>

<span class="token keyword">contract</span> <span class="token class-name">Logger</span> <span class="token punctuation">&#123;</span>
	<span class="token keyword">event</span> <span class="token function">Log</span><span class="token punctuation">(</span><span class="token builtin">string</span> a<span class="token punctuation">,</span> <span class="token builtin">string</span> <span class="token keyword">indexed</span> b<span class="token punctuation">,</span> <span class="token builtin">string</span> c<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token keyword">function</span> <span class="token function">log</span><span class="token punctuation">(</span><span class="token builtin">string</span> a<span class="token punctuation">,</span> <span class="token builtin">string</span> b<span class="token punctuation">,</span> <span class="token builtin">string</span> c<span class="token punctuation">)</span> <span class="token keyword">public</span> <span class="token punctuation">&#123;</span>
		<span class="token function">Log</span><span class="token punctuation">(</span>a<span class="token punctuation">,</span> b<span class="token punctuation">,</span> c<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></div></figure>

<p>使用 <code>log(&quot;a&quot;, &quot;b&quot;, &quot;c&quot;)</code>​ 生成日志。交易是：<a target="_blank" rel="noopener" href="https://rinkeby.etherscan.io/tx/0x21221c2924bbf1860db9e098ab98b3fd7a5de24dd68bab1ea9ce19ae9c303b56">https://rinkeby.etherscan.io/tx/0x21221c2924bbf1860db9e098ab98b3fd7a5de24dd68bab1ea9ce19ae9c303b56</a></p>
<p>有两个主题：</p>
<figure><div class="code-wrapper"><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">0xb857d3ea78d03217f929ae616bf22aea6a354b78e5027773679b7b4a6f66e86b
0xb5553de315e0edf504d9150af82dafa5c4667fa618ed0a6f19c69b41166c5510<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre></div></figure>

<ul>
<li>第一个主题还是方法签名。</li>
<li>第二个主题是字符串参数的 sha256 摘要。</li>
</ul>
<p>让我们验证“b”的哈希是否与第二个主题相同：</p>
<figure><div class="code-wrapper"><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token operator">>></span><span class="token operator">></span> sha3<span class="token punctuation">(</span><span class="token string">"b"</span><span class="token punctuation">)</span>.hex<span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token string">'b5553de315e0edf504d9150af82dafa5c4667fa618ed0a6f19c69b41166c5510'</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre></div></figure>

<p>日志数据是 ABI 编码的两个非索引字符串“a”和“c”：</p>
<figure><div class="code-wrapper"><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">0000000000000000000000000000000000000000000000000000000000000040
0000000000000000000000000000000000000000000000000000000000000080
0000000000000000000000000000000000000000000000000000000000000001
<span class="token number">6100000000000000000000000000000000000000000000000000000000000000</span>
0000000000000000000000000000000000000000000000000000000000000001
<span class="token number">6300000000000000000000000000000000000000000000000000000000000000</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></div></figure>

<p>不幸的是，索引字符串参数的原始字符串没有存储（因为使用的是哈希），因此 DApp 客户端无法恢复它。</p>
<p>如果您真的需要原始字符串，只需记录两次，包括索引和非索引：</p>
<figure><div class="code-wrapper"><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">event Log<span class="token punctuation">(</span>string a, string indexed indexedB, string b<span class="token punctuation">)</span><span class="token punctuation">;</span>

Log<span class="token punctuation">(</span><span class="token string">"a"</span>, <span class="token string">"b"</span>, <span class="token string">"b"</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre></div></figure>

<h2 id="Query-For-Logs-Efficiently"><a href="#Query-For-Logs-Efficiently" class="headerlink" title="Query For Logs Efficiently"></a>Query For Logs Efficiently</h2><p>我们如何找到第一个主题匹配“0x000…001”的所有日志？我们可以从创世块开始，重新执行每一笔交易，看看生成的日志是否符合我们的过滤条件。这不好。</p>
<p>事实证明，区块头(block header)包含了足够的信息，让我们可以快速跳过没有我们想要的日志的块。</p>
<p>区块头包括父哈希、叔父哈希币库(coin base)和用于该区块中包含的交易生成的所有日志的布隆过滤器等信息。看起来像：</p>
<figure><div class="code-wrapper"><pre class="line-numbers language-json" data-language="json"><code class="language-json">type Header struct <span class="token punctuation">&#123;</span>

    ParentHash  common.Hash    `json<span class="token operator">:</span><span class="token string">"parentHash"</span>       gencodec<span class="token operator">:</span><span class="token string">"required"</span>`

    UncleHash   common.Hash    `json<span class="token operator">:</span><span class="token string">"sha3Uncles"</span>       gencodec<span class="token operator">:</span><span class="token string">"required"</span>`

    Coinbase    common.Address `json<span class="token operator">:</span><span class="token string">"miner"</span>            gencodec<span class="token operator">:</span><span class="token string">"required"</span>`

    <span class="token comment">// ...</span>

    <span class="token comment">// The Bloom filter composed from indexable information (logger address and log topics) contained in each log entry from the receipt of each transaction in the transactions list</span>
    Bloom       Bloom          `json<span class="token operator">:</span><span class="token string">"logsBloom"</span>        gencodec<span class="token operator">:</span><span class="token string">"required"</span>`
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></div></figure>

<p><a target="_blank" rel="noopener" href="https://sourcegraph.com/github.com/ethereum/go-ethereum@479aa61f11724560c63a7b56084259552892819d/-/blob/core/types/block.go#L70:1">https:&#x2F;&#x2F;sourcegraph.com&#x2F;github.com&#x2F;ethereum&#x2F;go-ethereum@479aa61f11724560c63a7b56084259552892819d&#x2F;-&#x2F;blob&#x2F;core&#x2F;types&#x2F;block.go#L70:1</a></p>
<p>布隆过滤器是一个固定的 256 字节数据结构。它的行为类似于 set，您可以询问它是否存在某个主题。</p>
<p>所以我们可以这样优化日志查询流程：</p>
<figure><div class="code-wrapper"><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token keyword">for</span> <span class="token for-or-select variable">block</span> <span class="token keyword">in</span> chain:
    <span class="token comment"># check bloom filter to filter out a block quickly</span>
    <span class="token keyword">if</span> not block.Bloom.exist<span class="token punctuation">(</span>topic<span class="token punctuation">)</span>:
        next
    <span class="token comment"># block might have the log we want, re-execute</span>
    <span class="token keyword">for</span> <span class="token for-or-select variable">tx</span> <span class="token keyword">in</span> block.transactions:
        <span class="token keyword">for</span> <span class="token for-or-select variable">log</span> <span class="token keyword">in</span> tx.recalculateLogs<span class="token punctuation">(</span><span class="token punctuation">)</span>:
            <span class="token keyword">if</span> log.topic<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span>.matches<span class="token punctuation">(</span>topic<span class="token punctuation">)</span>
                yield log<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></div></figure>

<p>除了主题之外，发出日志的合约地址也被添加到布隆过滤器中。</p>
<h2 id="BloomBitsTrie"><a href="#BloomBitsTrie" class="headerlink" title="BloomBitsTrie"></a>BloomBitsTrie</h2><p>以太坊主网在 2018 年 1 月有大约 5,000,000 个区块，迭代所有区块仍然非常昂贵，因为您需要从磁盘加载区块头。</p>
<p>平均块头约为 500 字节，您总共将加载 2.5GB 的数据。</p>
<p><a target="_blank" rel="noopener" href="https://github.com/zsfelfoldi">Felföldi Zsolt</a> 在 <a target="_blank" rel="noopener" href="https://github.com/ethereum/go-ethereum/pull/14970">PR #14970</a> 中实现了 BloomBitsTrie，以使日志过滤更快。其思想是，与其单独查看每个块的布隆过滤器，不如设计一个同时查看 32768 个块的数据结构。</p>
<p>要理解接下来的内容，您需要了解的关于布隆过滤器的最少信息是，将一段数据“哈希”为布隆过滤器中的 3 个随机（但确定性）位并将它们设置为 1。为了检查是否存在，我们检查这 3 位是否设置为 1。</p>
<p>以太坊中使用的布隆过滤器是 2048 位。</p>
<p>假设主题“0xa”将布隆过滤器的第 16、632 和 777 位设置为 1。BloomBits Trie 是 2048 x 32768 位图(bitmap)。对 <code>BloomBits</code>​ 结构进行索引为我们提供了三个 32768 位向量：</p>
<figure><div class="code-wrapper"><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">BloomBits<span class="token punctuation">[</span><span class="token number">15</span><span class="token punctuation">]</span> <span class="token operator">=</span><span class="token operator">></span> <span class="token number">32768</span> bit vector <span class="token punctuation">(</span><span class="token number">4096</span> byte<span class="token punctuation">)</span>
BloomBits<span class="token punctuation">[</span><span class="token number">631</span><span class="token punctuation">]</span> <span class="token operator">=</span><span class="token operator">></span> <span class="token number">32768</span> bit vector <span class="token punctuation">(</span><span class="token number">4096</span> byte<span class="token punctuation">)</span>
BloomBits<span class="token punctuation">[</span><span class="token number">776</span><span class="token punctuation">]</span> <span class="token operator">=</span><span class="token operator">></span> <span class="token number">32768</span> bit vector <span class="token punctuation">(</span><span class="token number">4096</span> byte<span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre></div></figure>

<p>这些位向量告诉我们哪些块的布隆过滤器的第 16、632 和 777 位设置为 1。</p>
<p>让我们看看这些向量的前 8 位，可能看起来像</p>
<figure><div class="code-wrapper"><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token number">10110001</span><span class="token punctuation">..</span>.
00101101<span class="token punctuation">..</span>.
<span class="token number">10101001</span><span class="token punctuation">..</span>.<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre></div></figure>

<ul>
<li>第 1 个块的第 16 位和第 776 位设置为 1，但不是第 631 位。</li>
<li>第 3 个块设置了所有三个位。</li>
<li>第 8 个块设置了所有三个位。</li>
</ul>
<p>然后我们可以通过对这些向量应用二进制与来快速找到匹配所有三个位的块：</p>
<figure><div class="code-wrapper"><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">00100001<span class="token punctuation">..</span>.<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre></div></figure>

<p>最后的位向量准确地告诉我们 32768 中哪些块符合我们的过滤条件。</p>
<p>为了匹配多个主题，我们只需对每个主题进行相同的索引，然后将最终的位向量二进制和。</p>
<p>有关其工作原理的更多详细信息，请参阅 <a target="_blank" rel="noopener" href="https://github.com/zsfelfoldi/go-ethereum/wiki/BloomBits-Trie">BloomBits Trie</a>。</p>
<h2 id="Conclusion"><a href="#Conclusion" class="headerlink" title="Conclusion"></a>Conclusion</h2><p>总的来说，一个 EVM 日志最多可以有 4 个主题，以及任意数量的字节作为数据。 Solidity 事件的非索引参数被 ABI 编码为数据，索引参数用作日志主题。</p>
<p>存储日志数据的 gas 成本比普通存储要便宜得多，因此只要您的合约不需要访问数据，您就可以将其视为 DApp 的替代方案。</p>
<p>日志设施的两种替代设计选择可能是：</p>
<ul>
<li>允许更多数量的主题，尽管更多主题会降低用于按主题索引日志的布隆过滤器的有效性。</li>
<li>允许主题具有任意数量的字节。为什么不呢？</li>
</ul>
<h2 id="Other-Parts"><a href="#Other-Parts" class="headerlink" title="Other Parts"></a>Other Parts</h2><p>‍在这一系列文章中，我翻译了 <a target="_blank" rel="noopener" href="https://medium.com/@hayeah">Howard</a> 的 <a target="_blank" rel="noopener" href="https://blog.qtum.org/diving-into-the-ethereum-vm-6e8d5d2f3c30">Diving Into The Ethereum VM</a> 系列文章。译文链接如下：</p>
<ul>
<li><a href="http://alphafitz.com/2022/10/07/diving-into-the-ethereum-vm-part1-zh/">深入以太坊虚拟机 Part1 — 汇编与字节码</a></li>
<li><a href="http://alphafitz.com/2022/10/07/diving-into-the-ethereum-vm-part2-zh/">深入以太坊虚拟机 Part2 — 固定长度数据类型的表示</a></li>
<li><a href="http://alphafitz.com/2022/10/07/diving-into-the-ethereum-vm-part3-zh/">深入以太坊虚拟机 Part3 — 动态数据类型的表示</a></li>
<li><a href="http://alphafitz.com/2022/10/07/diving-into-the-ethereum-vm-part4-zh/">深入以太坊虚拟机 Part4 — 智能合约外部方法调用</a></li>
<li><a href="http://alphafitz.com/2022/10/07/diving-into-the-ethereum-vm-part5-zh/">深入以太坊虚拟机 Part5 — 智能合约创建过程</a></li>
<li><a href="http://alphafitz.com/2022/10/07/diving-into-the-ethereum-vm-part6-zh/">深入以太坊虚拟机 Part6 — Solidity 事件实现</a><br>也可以直接看总结篇：</li>
<li><a href="http://alphafitz.com/2022/10/17/diving-into-the-ethereum-vm-summary">深入以太坊虚拟机 总结</a></li>
</ul>

                
              </div>
            
            <hr/>
            <div>
              <div class="post-metas my-3">
  
    <div class="post-meta mr-3 d-flex align-items-center">
      <i class="iconfont icon-category"></i>
      

<span class="category-chains">
  
  
    
      <span class="category-chain">
        
  <a href="/categories/%E5%8C%BA%E5%9D%97%E9%93%BE%E6%8A%80%E6%9C%AF/" class="category-chain-item">区块链技术</a>
  
  
    <span>></span>
    
  <a href="/categories/%E5%8C%BA%E5%9D%97%E9%93%BE%E6%8A%80%E6%9C%AF/%E4%BB%A5%E5%A4%AA%E5%9D%8A%E8%99%9A%E6%8B%9F%E6%9C%BA/" class="category-chain-item">以太坊虚拟机</a>
  
  

  

      </span>
    
  
</span>

    </div>
  
  
    <div class="post-meta">
      <i class="iconfont icon-tags"></i>
      
        <a href="/tags/%E5%8C%BA%E5%9D%97%E9%93%BE%E6%8A%80%E6%9C%AF/">#区块链技术</a>
      
        <a href="/tags/%E6%99%BA%E8%83%BD%E5%90%88%E7%BA%A6%E5%BC%80%E5%8F%91/">#智能合约开发</a>
      
    </div>
  
</div>


              
  

  <div class="license-box my-3">
    <div class="license-title">
      <div>深入以太坊虚拟机 Part6 — Solidity 事件实现</div>
      <div>https://alphafitz.com/2022/10/07/diving-into-the-ethereum-vm-part6-zh/</div>
    </div>
    <div class="license-meta">
      
        <div class="license-meta-item">
          <div>作者</div>
          <div>alphafitz</div>
        </div>
      
      
        <div class="license-meta-item license-meta-date">
          <div>发布于</div>
          <div>2022年10月7日</div>
        </div>
      
      
      <div class="license-meta-item">
        <div>许可协议</div>
        <div>
          
            
            
              <a target="_blank" href="https://creativecommons.org/licenses/by-nc-sa/4.0/">
              <span class="hint--top hint--rounded" aria-label="BY - 署名">
                <i class="iconfont icon-by"></i>
              </span>
              </a>
            
              <a target="_blank" href="https://creativecommons.org/licenses/by-nc-sa/4.0/">
              <span class="hint--top hint--rounded" aria-label="NC - 非商业性使用">
                <i class="iconfont icon-nc"></i>
              </span>
              </a>
            
              <a target="_blank" href="https://creativecommons.org/licenses/by-nc-sa/4.0/">
              <span class="hint--top hint--rounded" aria-label="SA - 相同方式共享">
                <i class="iconfont icon-sa"></i>
              </span>
              </a>
            
          
        </div>
      </div>
    </div>
    <div class="license-icon iconfont"></div>
  </div>



              
                <div class="post-prevnext my-3">
                  <article class="post-prev col-6">
                    
                    
                      <a href="/2022/10/11/ethereum-mainstream-token-standard/" title="以太坊主流代币标准">
                        <i class="iconfont icon-arrowleft"></i>
                        <span class="hidden-mobile">以太坊主流代币标准</span>
                        <span class="visible-mobile">上一篇</span>
                      </a>
                    
                  </article>
                  <article class="post-next col-6">
                    
                    
                      <a href="/2022/10/07/diving-into-the-ethereum-vm-part5-zh/" title="深入以太坊虚拟机 Part5 — 智能合约创建过程">
                        <span class="hidden-mobile">深入以太坊虚拟机 Part5 — 智能合约创建过程</span>
                        <span class="visible-mobile">下一篇</span>
                        <i class="iconfont icon-arrowright"></i>
                      </a>
                    
                  </article>
                </div>
              
            </div>

            
          </article>
        </div>
      </div>
    </div>

    <div class="side-col d-none d-lg-block col-lg-2">
      
  <aside class="sidebar" style="margin-left: -1rem">
    <div id="toc">
  <p class="toc-header"><i class="iconfont icon-list"></i>&nbsp;目录</p>
  <div class="toc-body" id="toc-body"></div>
</div>



  </aside>


    </div>
  </div>
</div>





  



  



  



  



  







    

    
      <a id="scroll-top-button" aria-label="TOP" href="#" role="button">
        <i class="iconfont icon-arrowup" aria-hidden="true"></i>
      </a>
    

    
      <div class="modal fade" id="modalSearch" tabindex="-1" role="dialog" aria-labelledby="ModalLabel"
     aria-hidden="true">
  <div class="modal-dialog modal-dialog-scrollable modal-lg" role="document">
    <div class="modal-content">
      <div class="modal-header text-center">
        <h4 class="modal-title w-100 font-weight-bold">搜索</h4>
        <button type="button" id="local-search-close" class="close" data-dismiss="modal" aria-label="Close">
          <span aria-hidden="true">&times;</span>
        </button>
      </div>
      <div class="modal-body mx-3">
        <div class="md-form mb-5">
          <input type="text" id="local-search-input" class="form-control validate">
          <label data-error="x" data-success="v" for="local-search-input">关键词</label>
        </div>
        <div class="list-group" id="local-search-result"></div>
      </div>
    </div>
  </div>
</div>

    

    
  </main>

  <footer>
    <div class="footer-inner">
  
    <div class="footer-content">
       <a href="https://hexo.io" target="_blank" rel="nofollow noopener"><span>Hexo</span></a> <i class="iconfont icon-love"></i> <a href="https://github.com/fluid-dev/hexo-theme-fluid" target="_blank" rel="nofollow noopener"><span>Fluid</span></a> 
    </div>
  
  
    <div class="statistics">
  
  

  
    
      <span id="busuanzi_container_site_pv" style="display: none">
        总访问量 
        <span id="busuanzi_value_site_pv"></span>
         次
      </span>
    
    
      <span id="busuanzi_container_site_uv" style="display: none">
        总访客数 
        <span id="busuanzi_value_site_uv"></span>
         人
      </span>
    
    
  
</div>

  
  
  
</div>

  </footer>

  <!-- Scripts -->
  
  <script  src="https://lib.baomitu.com/nprogress/0.2.0/nprogress.min.js" ></script>
  <link  rel="stylesheet" href="https://lib.baomitu.com/nprogress/0.2.0/nprogress.min.css" />

  <script>
    NProgress.configure({"showSpinner":false,"trickleSpeed":100})
    NProgress.start()
    window.addEventListener('load', function() {
      NProgress.done();
    })
  </script>


<script  src="https://lib.baomitu.com/jquery/3.6.0/jquery.min.js" ></script>
<script  src="https://lib.baomitu.com/twitter-bootstrap/4.6.1/js/bootstrap.min.js" ></script>
<script  src="/js/events.js" ></script>
<script  src="/js/plugins.js" ></script>


  <script  src="https://lib.baomitu.com/typed.js/2.0.12/typed.min.js" ></script>
  <script>
    (function (window, document) {
      var typing = Fluid.plugins.typing;
      var subtitle = document.getElementById('subtitle');
      if (!subtitle || !typing) {
        return;
      }
      var text = subtitle.getAttribute('data-typed-text');
      
        typing(text);
      
    })(window, document);
  </script>




  
    <script  src="/js/img-lazyload.js" ></script>
  




  
<script>
  Fluid.utils.createScript('https://lib.baomitu.com/tocbot/4.18.2/tocbot.min.js', function() {
    var toc = jQuery('#toc');
    if (toc.length === 0 || !window.tocbot) { return; }
    var boardCtn = jQuery('#board-ctn');
    var boardTop = boardCtn.offset().top;

    window.tocbot.init({
      tocSelector     : '#toc-body',
      contentSelector : '.markdown-body',
      headingSelector : CONFIG.toc.headingSelector || 'h1,h2,h3,h4,h5,h6',
      linkClass       : 'tocbot-link',
      activeLinkClass : 'tocbot-active-link',
      listClass       : 'tocbot-list',
      isCollapsedClass: 'tocbot-is-collapsed',
      collapsibleClass: 'tocbot-is-collapsible',
      collapseDepth   : CONFIG.toc.collapseDepth || 0,
      scrollSmooth    : true,
      headingsOffset  : -boardTop
    });
    if (toc.find('.toc-list-item').length > 0) {
      toc.css('visibility', 'visible');
    }
  });
</script>


  <script  src="https://lib.baomitu.com/prism/1.27.0/plugins/line-numbers/prism-line-numbers.min.js" ></script>

  <script src=https://lib.baomitu.com/clipboard.js/2.0.10/clipboard.min.js></script>

  <script>Fluid.plugins.codeWidget();</script>


  
<script>
  Fluid.utils.createScript('https://lib.baomitu.com/anchor-js/4.3.1/anchor.min.js', function() {
    window.anchors.options = {
      placement: CONFIG.anchorjs.placement,
      visible  : CONFIG.anchorjs.visible
    };
    if (CONFIG.anchorjs.icon) {
      window.anchors.options.icon = CONFIG.anchorjs.icon;
    }
    var el = (CONFIG.anchorjs.element || 'h1,h2,h3,h4,h5,h6').split(',');
    var res = [];
    for (var item of el) {
      res.push('.markdown-body > ' + item.trim());
    }
    if (CONFIG.anchorjs.placement === 'left') {
      window.anchors.options.class = 'anchorjs-link-left';
    }
    window.anchors.add(res.join(', '));
  });
</script>


  
<script>
  Fluid.utils.createScript('https://lib.baomitu.com/fancybox/3.5.7/jquery.fancybox.min.js', function() {
    Fluid.plugins.fancyBox();
  });
</script>


  <script>Fluid.plugins.imageCaption();</script>

  <script  src="/js/local-search.js" ></script>

  <script defer src="https://busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js" ></script>





<!-- 主题的启动项，将它保持在最底部 -->
<!-- the boot of the theme, keep it at the bottom -->
<script  src="/js/boot.js" ></script>


  

  <noscript>
    <div class="noscript-warning">博客在允许 JavaScript 运行的环境下浏览效果更佳</div>
  </noscript>
</body>
</html>
